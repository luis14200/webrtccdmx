!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.MediaDevice=t()}(this,(function(){function e(){this.deviceCheckTimer=null}e.prototype.getQuickScanList=function(){return[{label:"4K(UHD)",width:3840,height:2160,ratio:"16:9",frameRate:30},{label:"4K(UHD)",width:3840,height:2160,ratio:"16:9",frameRate:15},{label:"1080p(FHD)",width:1920,height:1080,ratio:"16:9",frameRate:30},{label:"1080p(FHD)",width:1920,height:1080,ratio:"16:9",frameRate:15},{label:"UXGA",width:1600,height:1200,ratio:"4:3",frameRate:30},{label:"UXGA",width:1600,height:1200,ratio:"4:3",frameRate:15},{label:"720p(HD)",width:1280,height:720,ratio:"16:9",frameRate:30},{label:"720p(HD)",width:1280,height:720,ratio:"16:9",frameRate:15},{label:"SVGA",width:800,height:600,ratio:"4:3",frameRate:30},{label:"SVGA",width:800,height:600,ratio:"4:3",frameRate:15},{label:"VGA",width:640,height:480,ratio:"4:3",frameRate:30},{label:"VGA",width:640,height:480,ratio:"4:3",frameRate:15},{label:"360p(nHD)",width:640,height:360,ratio:"16:9",frameRate:30},{label:"360p(nHD)",width:640,height:360,ratio:"16:9",frameRate:15},{label:"CIF",width:352,height:288,ratio:"4:3",frameRate:30},{label:"CIF",width:352,height:288,ratio:"4:3",frameRate:15},{label:"QVGA",width:320,height:240,ratio:"4:3",frameRate:30},{label:"QVGA",width:320,height:240,ratio:"4:3",frameRate:15},{label:"180p?",width:320,height:180,ratio:"16:9",frameRate:30},{label:"180p?",width:320,height:180,ratio:"16:9",frameRate:15},{label:"QCIF",width:176,height:144,ratio:"4:3",frameRate:30},{label:"QCIF",width:176,height:144,ratio:"4:3",frameRate:15},{label:"QQVGA",width:160,height:120,ratio:"4:3",frameRate:30},{label:"QQVGA",width:160,height:120,ratio:"4:3",frameRate:15}]},e.prototype.enumDevices=function(e){navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then((function(t){for(var i=[],o=[],n=[],r=[],s=0;s<t.length;s++){var a=t[s];"default"!==a.deviceId&&"communications"!==a.deviceId&&("audioinput"===a.kind&&i.push({label:a.label,deviceId:a.deviceId,groupId:a.groupId,status:"available"}),"audiooutput"===a.kind&&o.push({label:a.label,deviceId:a.deviceId,groupId:a.groupId,status:"available"}),"videoinput"===a.kind&&n.push({label:a.label,deviceId:a.deviceId,groupId:a.groupId,status:"available",capability:[]}))}if(r.push({width:window.screen.width,height:window.screen.height}),!e)return{microphones:i,speakers:o,cameras:n,screenResolution:r,isConstraintsKeywordSupport:true};e({microphones:i,speakers:o,cameras:n,screenResolution:r,isConstraintsKeywordSupport:true})})).catch((function(t){console.error(t),e(t)})):console.warn("browser don't support enumerateDevices() .")},e.prototype.updateDeviceInfo=function(e,t){var i=JSON.parse(localStorage.getItem("mediaDevice")),o=[],n=[];switch(t){case"cameras":o=e.cameras,n=i&&i.cameras||[];break;case"microphones":o=e.microphones,n=i&&i.microphones||[];break;case"speakers":o=e.speakers,n=i&&i.speakers||[]}if(o.length&&!n.length)return log.warn("set new device info list"),void localStorage.setItem("mediaDevice",JSON.stringify(e,null,"    "));if(o.length||!n.length)!function(e,t){for(var i=0;i<t.length;i++)for(var o=0;o<e.length;o++){if(t[i].label===e[o].label){"unavailable"===t[i].status&&(log.log("set device unavailable to available!"),t[i].status="available"),t[i].deviceId=e[o].deviceId,t[i].groupId=e[o].groupId;break}t[i].label!==e[o].label&&o===e.length-1&&"unavailable"!==t[i].status&&(log.warn(t[i].label+" device is unavailable"),t[i].status="unavailable")}}(o,n),function(e,t){for(var i=0;i<e.length;i++)for(var o=0;o<t.length;o++){if(e[i].label===t[o].label){t[o].deviceId=e[i].deviceId,t[o].groupId=e[i].groupId;break}e[i].label!==t[o].label&&o===t.length-1&&(log.warn("new device has been insert!"),t.push(e[i]))}}(o,n),localStorage.setItem("mediaDevice",JSON.stringify(i,null,"    "));else{for(var r=0;r<n.length;r++)n[r].status="unavailable";localStorage.setItem("mediaDevice",JSON.stringify(i,null,"    "))}},e.prototype.closeStream=function(e){try{var t=e.getTracks();for(var i in t)t[i].onended=null,log.log("close stream"),t[i].stop()}catch(e){log.error(e)}},e.prototype.isConstraintsKeywordSupport=async function(){var e=this,t=!0,i=JSON.parse(localStorage.getItem("mediaDevice")),o=i?i.isConstraintsKeywordSupport:null;if(null!==o)t=o;else{var n={audio:!1,video:{width:{ideal:640},height:{ideal:360}}};log.log("isConstraintsKeywordSupport test constraints: \n"+JSON.stringify(n,null,"    "));try{!function(i){log.log("constraints keyWords support"),t=!0,e.closeStream(i)}(await navigator.mediaDevices.getUserMedia(n))}catch(e){!function(e){console.error(e),log.log("ideal is not support"+e.message),t=!1}(e)}}return log.info("is constraints Keyword support: ",t),t},e.prototype.getStreamWithExactConstraints=async function(){var e,t,i=this,o=JSON.parse(localStorage.getItem("mediaDevice")),n=i.getQuickScanList();function r(t){log.info("get Stream Success : "+n[d].width+" x "+n[d].height+"px, frameRate: "+n[d].frameRate),t&&(e=t),c.push({width:n[d].width,height:n[d].height,frameRate:n[d].frameRate,aspectRatio:n[d].ratio}),a===o.cameras.length-1&&d===n.length-1&&(log.log("Resolution scan completed, clear stream."),i.closeStream(e))}function s(e){"ConstraintNotSatisfiedError"===e.name?log.info("The resolution "+n[d].width+"x"+n[d].height+" px and frameRate with "+n[d].frameRate+" is not supported by your device."):"PermissionDeniedError"===e.name&&log.info("Permissions have not been granted to use your camera and microphone, you need to allow the page access to your devices in order for the demo to work."),log.log("fail: mismatch : "+n[d].width+" x "+n[d].height+"px, frameRate: "+n[d].frameRate)}for(var a=0;a<o.cameras.length;a++)if(e&&i.closeStream(e),o.cameras[a].capability&&o.cameras[a].capability.length>0)log.log("this device has already get resolution before: "+o.cameras[a].label);else{log.warn("Current scan device："+o.cameras[a].label);for(var l=o.cameras[a].deviceId,c=o.cameras[a].capability,d=0;d<n.length;d++){var p=e?e.getVideoTracks()[0]:null;if(e&&!0===e.active&&e.getVideoTracks().length>0&&p.applyConstraints){t={frameRate:{exact:n[d].frameRate},aspectRatio:{exact:n[d].width/n[d].height},width:{exact:n[d].width},height:{exact:n[d].height}};try{await p.applyConstraints(t),r()}catch(e){s(e)}}else{t={audio:!1,video:{frameRate:{exact:n[d].frameRate},aspectRatio:{exact:n[d].width/n[d].height},width:{max:n[d].width,exact:n[d].width},height:{max:n[d].height,exact:n[d].height}}},l&&(t.video.deviceId={exact:l});try{r(await navigator.mediaDevices.getUserMedia(t))}catch(e){s(e)}}}}localStorage.setItem("mediaDevice",JSON.stringify(o,null,"    "))};var t=document.createElement("video");return t.onloadedmetadata=e.prototype.displayVideoDimensions,e.prototype.displayVideoDimensions=function(e,i){var o=this,n=e,r=i,s=JSON.parse(localStorage.getItem("mediaDevice")),a=s.cameras[r].capability,l=o.getQuickScanList();function c(e){!0===e.result?(log.log("pass"),a.push({width:l[n].width,height:l[n].height,frameRate:l[n].frameRate,aspectRatio:l[n].ratio}),localStorage.setItem("mediaDevice",JSON.stringify(s,null,"    "))):log.log("fail: mismatch"),++n<l.length?(log.log("Scan the next resolution"),window.isScanCameraChange=!1,o.getStreamWithoutConstraintsKeyWords(n,r)):r<s.cameras.length-1?(log.log("Scan the next camera"),window.isScanCameraChange=!0,o.closeStream(stream),r++,n=0,o.getStreamWithoutConstraintsKeyWords(n,r)):(o.closeStream(stream),log.log("All camera capabilities are End of scan ~~"),t=null)}log.log("Video onloadedmetadata call~~~"),t.videoWidth||setTimeout((function(){o.displayVideoDimensions(e,i)}),500),t.videoWidth*t.videoHeight>0&&(log.info("Display size for : "+l[e].width+"x"+l[e].height),log.info("Stream dimensions for :"+t.videoWidth+"x"+t.videoHeight),l[e].width+"x"+l[e].height!=t.videoWidth+"x"+t.videoHeight?(log.info("fail: mismatch"),c({result:!1})):(log.info("pass :"+l[e].width+"x"+l[e].height),c({result:!0})))},e.prototype.getStreamWithoutConstraintsKeyWords=async function(e,i){var o,n=this,r=n.getQuickScanList(),s=JSON.parse(localStorage.getItem("mediaDevice")),a=e,l=i,c=window.stream,d=s.cameras[l].deviceId,p=s.cameras[l].capability;if(!0===window.isScanCameraChange&&p&&p.length>0)return log.warn("this device has already get resolution before: "+s.cameras[l].label),void(++i<s.cameras.length&&(log.warn("Scan the next device"),n.getStreamWithoutConstraintsKeyWords(e,i)));function g(s){log.log("applyConstraints success"+JSON.stringify(o,null,"    ")),log.log("Display size for "+r[a].label+": "+r[a].width+"x"+r[a].height),s&&(window.stream=s,t.srcObject=s),setTimeout((function(){n.displayVideoDimensions(e,i)}),2e3)}function u(e){log.warn("applyConstraints error: ",e.name)}window.isScanCameraChange=!1,log.warn("Current scan device：",s.cameras[l].label);var f=c?c.getVideoTracks()[0]:null;if(c&&!0===c.active&&c.getVideoTracks().length>0&&f.applyConstraints){o={frameRate:r[a].frameRate,width:r[a].width,height:r[a].height,aspectRatio:{exact:r[a].width/r[a].height}};try{await f.applyConstraints(o),g()}catch(e){u(e)}}else{o={audio:!1,video:{deviceId:d,frameRate:r[a].frameRate,width:r[a].width,height:r[a].height,aspectRatio:{exact:r[a].width/r[a].height}}};try{await navigator.mediaDevices.getUserMedia(o),g(stream)}catch(e){u(e)}}},e.prototype.setDeviceCapability=async function(){log.warn("device capability scanning");var e=this,t=JSON.parse(localStorage.getItem("mediaDevice"));if(t&&t.cameras.length>0){var i=await e.isConstraintsKeywordSupport();t.isConstraintsKeywordSupport=i,!0===i?(log.info("min/max/ideal/exact keyWord is support"),await e.getStreamWithExactConstraints()):(log.info("min/max/ideal/exact keyWord is  NOT support"),window.isScanCameraChange=!0,await e.getStreamWithoutConstraintsKeyWords(0,0))}else log.warn("no cameras need to resolution scan!")},e.prototype.checkAvailableDev=function(){var e=this;e.enumDevices((function(t){function i(e,t){for(var i=0;i<e.length;i++)e[i].label||(e[i].label=t+i);return e}t?(t.cameras&&i(t.cameras,"cameras"),t.microphones&&i(t.microphones,"microphones"),t.speakers&&i(t.speakers,"speakers"),e.updateDeviceInfo(t,"cameras"),e.updateDeviceInfo(t,"microphones"),e.updateDeviceInfo(t,"speakers")):log.warn("deviceInfo is null")}),(function(e){log.error("enum device error: "+e.toString())}))},e.prototype.setDeviceCheckInterval=function(e){var t=this;e?(clearInterval(t.deviceCheckTimer),t.deviceCheckTimer=setInterval((function(){t.checkAvailableDev()}),2e3)):(clearInterval(t.deviceCheckTimer),t.deviceCheckTimer=null)},e.prototype.getSuitableResolution=function(e){if(e.deviceId&&e.width&&e.height&&e.frameRate){var t=JSON.parse(localStorage.getItem("mediaDevice")),i=[],o=[],n={};if(t&&t.cameras.length>0){for(var r=0;r<t.cameras.length;r++)if(t.cameras[r].deviceId===e.deviceId){i=t.cameras[r].capability;break}if(i.length>0)for(var s=0;s<i.length;s++)i[s].width===e.width&&o.push(i[s]);if(o.length>0){for(var a=0;a<o.length;a++)if(o[a].width===e.width&&o[a].height===e.height&&o[a].frameRate===e.frameRate){n=o[a];break}if("{}"===JSON.stringify(n))for(a=0;a<o.length;a++)if(o[a].width===e.width&&o[a].height===e.height&&o[a].frameRate<e.frameRate){log.log("Returns the resolution where the width height is the same and the frameRate is less than the expected value. ",o[a]),n=o[a];break}if("{}"===JSON.stringify(n))for(a=0;a<o.length;a++)if(o[a].width===e.width&&o[a].height<e.height&&o[a].frameRate===e.frameRate){log.log("Returns the resolution where the width height is the same and the frameRate is less than the expected value. ",o[a]),n=o[a];break}}else{log.warn("no same with resolution exist, get other resolution;");for(s=0;s<i.length;s++)if(i[s].width<e.width){log.log("Returns the maximum resolution supported by the device with a smaller width than expected"),n=i[s];break}}return n}return n}log.warn("Invalid parameter")},e.getBrowserDetail=function(){function e(e,t,i){let o=e.match(t);return o&&o.length>=i&&parseInt(o[i],10)}var t=window&&window.navigator,i={browser:null,version:null,UIVersion:null,chromeVersion:null};if("undefined"==typeof window||!window.navigator)return i.browser="Not a browser.",i;if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))i.browser="edge",i.version=e(t.userAgent,/Edge\/(\d+).(\d+)$/,2),i.UIVersion=t.userAgent.match(/Edge\/([\d.]+)/)[1];else if(!t.mediaDevices&&(window.ActiveXObject||"ActiveXObject"in window||t.userAgent.match(/MSIE (\d+)/)||t.userAgent.match(/rv:(\d+)/)))i.browser="ie",t.userAgent.match(/MSIE (\d+)/)?(i.version=e(t.userAgent,/MSIE (\d+).(\d+)/,1),i.UIVersion=t.userAgent.match(/MSIE ([\d.]+)/)[1]):t.userAgent.match(/rv:(\d+)/)&&(i.version=e(t.userAgent,/rv:(\d+).(\d+)/,1),i.UIVersion=t.userAgent.match(/rv:([\d.]+)/)[1]);else if(t.mozGetUserMedia)i.browser="firefox",i.version=e(t.userAgent,/Firefox\/(\d+)\./,1),i.UIVersion=t.userAgent.match(/Firefox\/([\d.]+)/)[1];else if(t.webkitGetUserMedia&&window.webkitRTCPeerConnection){!!t.userAgent.match(/(OPR|Opera).([\d.]+)/)?(i.browser="opera",i.version=e(t.userAgent,/O(PR|pera)\/(\d+)\./,2),i.UIVersion=t.userAgent.match(/O(PR|pera)\/([\d.]+)/)[2],t.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2]&&(i.chromeVersion=e(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2))):(i.browser="chrome",i.version=e(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2),i.UIVersion=t.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2])}else{if(!(!t.webkitGetUserMedia&&t.userAgent.match(/AppleWebKit\/([0-9]+)\./)||t.webkitGetUserMedia&&!t.webkitRTCPeerConnection))return i.browser="Not a supported browser.",i;if(!t.userAgent.match(/Version\/(\d+).(\d+)/))return i.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",i;i.browser="safari",i.version=e(t.userAgent,/AppleWebKit\/(\d+)\./,1),i.UIVersion=t.userAgent.match(/Version\/([\d.]+)/)[1]}return i},e.prototype.isSystemAudioShareSupport=function(){let t=!1,i=e.getBrowserDetail();return("chrome"===i.browser&&navigator.userAgent.indexOf("Edg")>0&&i.version>=79||"chrome"===i.browser&&navigator.userAgent.indexOf("Edg")<0&&i.version>=74||"opera"===i.browser&&i.version>=74)&&(t=!0),t},e.prototype.getMedia=async function(e,t){function i(i){log.info("get stream success constraints: "+JSON.stringify(t,null,"  ")),e.callback({stream:i||e.stream})}function o(i){e.error=i,log.warn("get stream failed: "+JSON.stringify(t,null,"  ")),log.warn("onGetStreamFailed: "+i.message),"OverconstrainedError"===i.name||"ConstraintNotSatisfiedError"===i.name?(log.warn("constraints can not be satisfied by avb.device"),e.callback({error:i,constraints:t})):("NotFoundError"===i.name||"DeviceNotFoundError"===i.name?log.warn("require track is missing"):"NotReadableError"===i.name||"TrackStartError"===i.name?log.warn("webcam or mic are already in use"):"NotAllowedError"===i.name||"PermissionDeniedError"===i.name||"PermissionDismissedError"===i.name?log.warn("permission denied in browser"):"TypeError"===i.name?log.warn("empty constraints object"):log.warn("other errors "+i.name),e.callback({error:i}))}if(log.warn("getMedia"),"audio"===e.streamType)navigator.mediaDevices.getUserMedia(t).then(i).catch(o);else if("video"===e.streamType)if("video"===e.streamType&&!0!==e.isFirefox&&e.stream&&e.stream.getVideoTracks().length&&!0===e.stream.active){let n,r={width:{exact:t.video.width.exact},height:{exact:t.video.height.exact}};n=e.stream.getVideoTracks()[0],n&&n.applyConstraints&&(log.info("applyConstraints constraints: "+JSON.stringify(r,null,"    ")),n.applyConstraints(r).then(i).catch(o))}else navigator.mediaDevices.getUserMedia(t).then(i).catch(o);else"screenShare"===e.streamType&&(window.ipcRenderer?(log.info("ipcRenderer getUserMedia for screen"),navigator.mediaDevices.getUserMedia(t).then(i).catch(o)):navigator.getDisplayMedia?navigator.getDisplayMedia(t).then(i).catch(o):navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia(t).then(i).catch(o):navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(t).then(i).catch(o):log.info("getDisplayMedia is not supported by current browser"))},e.prototype.getConstraints=function(e,t){let i=this,o={};switch(e.streamType){case"audio":o={audio:!e.deviceId||{deviceId:e.deviceId},video:!1};break;case"video":o=i.getVideoConstraints(e,t);break;case"screenShare":o=i.getScreenShareConstraints(e);break;default:console.warn("unknown type "+e.streamType)}return o},e.prototype.getVideoConstraints=function(e,t){let i,o=this,n={},r={};t?(r=o.getNextConstraints(e),i=r.deviceId,n=r):(i=e.deviceId,r=e,log.info("deviceId: ",i),i&&(n=o.getSuitableResolution({frameRate:r.frameRate?r.frameRate:30,width:r.width?r.width:640,height:r.height?r.height:360,deviceId:r.deviceId}),log.log("match constraints: ",n)));let s={audio:!1,video:{frameRate:{exact:n.frameRate?n.frameRate:r.frameRate?r.frameRate:30},aspectRatio:{exact:n.width?n.width/n.height:r.width/r.height},width:{exact:n.width?n.width:r.width?r.width:640},height:{exact:n.height?n.height:r.height?r.height:360}}};return i&&(s.video.deviceId={exact:i}),log.log("data.constraintsKeyWord: ",e.constraintsKeyWord),e.constraintsKeyWord?"ideal"===e.constraintsKeyWord?(log.warn("Use ideal limit"),s.video.frameRate.ideal=s.video.frameRate.exact,s.video.aspectRatio.ideal=s.video.aspectRatio.exact,s.video.width.ideal=s.video.width.exact,s.video.height.ideal=s.video.height.exact,s.video.frameRate.max=s.video.frameRate.exact,s.video.aspectRatio.max=s.video.aspectRatio.exact,s.video.width.max=s.video.width.exact,s.video.height.max=s.video.height.exact,s.video.deviceId.exact&&(s.video.deviceId.ideal=s.video.deviceId.exact),delete s.video.frameRate.exact,delete s.video.aspectRatio.exact,delete s.video.width.exact,delete s.video.height.exact,delete s.video.deviceId.exact):e.constraintsKeyWord:(log.warn("Do not use keyWord limit"),s.video.frameRate=s.video.frameRate.exact,s.video.aspectRatio=s.video.aspectRatio.exact,s.video.width=s.video.width.exact,s.video.height=s.video.height.exact,(s.video.deviceId.exact||s.video.deviceId.ideal)&&(s.video.deviceId=s.video.deviceId.exact?s.video.deviceId.exact:s.video.deviceId.ideal)),s},e.prototype.getNextConstraints=function(e){let t,i=e.settings,o={frameRate:i.video.frameRate.exact||i.video.frameRate.ideal||i.video.frameRate,width:i.video.width.exact||i.video.width.ideal||i.video.width,height:i.video.height.exact||i.video.height.ideal||i.video.height,deviceId:i.video.deviceId.exact||i.video.deviceId.ideal||i.video.deviceId},n=o.deviceId?o.deviceId:e.deviceId,r=this.getCapability(n);for(let e=0;e<r.length;e++)if(r[e].width===o.width&&r[e].height===o.height&&r[e].frameRate===o.frameRate){t=r[e+1];break}return log.log("nextConstraints: ",t),t||(log.warn("Change the restriction condition."),"exact"===e.constraintsKeyWord?(log.warn("Exact has been scanned, using ideals"),e.constraintsKeyWord="ideal"):"ideal"===e.constraintsKeyWord?(log.warn("The ideal has been scanned. Do not use keywords"),e.constraintsKeyWord=""):(log.warn("The flow failed completely, and the flow was not taken."),e.callback({error:e.error}))),{constraintsKeyWord:e.constraintsKeyWord,streamType:e.streamType,deviceId:o.deviceId?o.deviceId:e.deviceId,frameRate:t&&t.frameRate||e.constraints&&e.constraints.frameRate||o&&o.frameRate||15,width:t&&t.width||e.constraints&&e.constraints.width||o&&o.width||1280,height:t&&t.height||e.constraints&&e.constraints.height||o&&o.height||720}},e.prototype.getScreenShareConstraints=function(t){let i;if(navigator.mediaDevices.getDisplayMedia&&(i={audio:this.isSystemAudioShareSupport(),video:{width:{max:"1920"},height:{max:"1080"},frameRate:{max:"15"}}}),navigator.mozGetUserMedia&&(i={audio:this.isSystemAudioShareSupport(),video:{mozMediaSource:t.source,mediaSource:t.source,width:{min:"10",max:"1920"},height:{min:"10",max:"1080"},frameRate:{min:"1",max:"15"}}}),"edge"===e.getBrowserDetail().browser){if(!(e.getBrowserDetail().version>=17134&&navigator.getDisplayMedia))return void log.warn("This version of Edge does not support screen capture feature");i={audio:!1,video:{displaySurface:"window",logicalSurface:!0,width:{min:"10",max:"1920"},height:{min:"10",max:"1080"},frameRate:{min:"1",max:"15"}}}}return i},e.prototype.getCapability=function(e){let t=this,i=[],o=JSON.parse(localStorage.getItem("mediaDevice")).cameras;if(o&&o.length)for(let t=0;t<o.length;t++)o[t].deviceId===e&&(i=o[t].capability);return i.length||(i=t.getQuickScanList()),i},e}));const grammar={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(\S*) (\S*)/,names:["msid","trackid"],format:"msid:%s %s"},{name:"ptime",reg:/^ptime:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){let t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){let t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{push:"msidSemantics",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)$/,format:"content:%s"},{name:"quality",reg:/^quality:(.+)$/,format:"quality:%s"},{push:"invalid",names:["value"]}]};Object.keys(grammar).forEach((function(e){grammar[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}));let formatRegExp=/%[sdv%]/g,format=function(e){let t=1,i=arguments,o=i.length;return e.replace(formatRegExp,(function(e){if(t>=o)return e;let n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))};function getType(e){return"[object Object]"===Object.prototype.toString.call(e)?"Object":"[object Array]"===Object.prototype.toString.call(e)?"Array":"nomal"}function deepCopy(e){if("nomal"===getType(e))return e;var t="Object"===getType(e)?{}:[];for(let i in e)e.hasOwnProperty(i)&&(t[i]=deepCopy(e[i]));return t}let makeLine=function(e,t,i){let o=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(let e=0;e<t.names.length;e+=1){let n=t.names[e];t.name?o.push(i[t.name][n]):o.push(i[t.names[e]])}else o.push(i[t.name]);return format.apply(null,o)},defaultOuterOrder=["v","o","s","i","u","e","p","c","b","t","r","z","a"],defaultInnerOrder=["i","c","b","a"],toIntIfInt=function(e){return String(Number(e))===e?Number(e):e},attachProperties=function(e,t,i,o){if(o&&!i)t[o]=toIntIfInt(e[1]);else for(let o=0;o<i.length;o+=1)null!=e[o+1]&&(t[i[o]]=toIntIfInt(e[o+1]))},parseReg=function(e,t,i){let o=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:o&&!t[e.name]&&(t[e.name]={});let n=e.push?{}:o?t[e.name]:t;attachProperties(i.match(e.reg),n,e.names,e.name),e.push&&t[e.push].push(n)},validLine=RegExp.prototype.test.bind(/^([a-z])=(.*)/),paramReducer=function(e,t){let i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=toIntIfInt(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e},SDPTools={midMap:[],msidMap:[],sessionVersion:0,resolutionToLevelIdcMap:{2160:"33",1080:"28",720:"1f",480:"1e",360:"16",272:"15"},levelIdcToReSolutionMap:{15:{width:480,height:272},16:{width:640,height:360},"1e":{width:848,height:480},"1f":{width:1280,height:720},28:{width:1920,height:1080},33:{width:3840,height:2160}},maxFsToResolutionMap:{520:{width:480,height:272},920:{width:640,height:360},1596:{width:848,height:480},3600:{width:848,height:480},8160:{width:848,height:480},32400:{width:3840,height:2160}},increaseSessionVersion:function(e){if(e&&e.origin){let t=e.origin.sessionVersion;t+=1,e.origin.sessionVersion=t}},writeSDP:function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));let i=t.outerOrder||defaultOuterOrder,o=t.innerOrder||defaultInnerOrder,n=[];return i.forEach((function(t){grammar[t].forEach((function(i){i.name in e&&null!=e[i.name]?n.push(makeLine(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){n.push(makeLine(t,i,e))}))}))})),e.media.forEach((function(e){n.push(makeLine("m",grammar.m[0],e)),o.forEach((function(t){grammar[t].forEach((function(i){i.name in e&&null!=e[i.name]?n.push(makeLine(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){n.push(makeLine(t,i,e))}))}))}))})),n.join("\r\n")+"\r\n"},parseSDP:function(e){let t={},i=[],o=t;return e.split(/(\r\n|\r|\n)/).filter(validLine).forEach((function(e){let t=e[0],n=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),o=i[i.length-1]);for(let e=0;e<(grammar[t]||[]).length;e+=1){let i=grammar[t][e];if(i.reg.test(n))return parseReg(i,o,n)}})),t.media=i,this.sessionVersion<=0&&(this.sessionVersion=t.origin.sessionVersion),t},adjustMLineOrder:function(e,t){if(t){let i=[];for(let o=0;o<e.media.length;o++){let n=e.media[o].content||e.media[o].type;for(let r in t)n===t[r]&&(i[r]=e.media[o])}i&&i.length&&(e.media=i)}else{let t=[],i=[];for(let o=0;o<e.media.length;o++)"audio"===e.media[o].type?t.push(e.media[o]):i.push(e.media[o]);e.media=t.concat(i)}},setBundleMaxCompat:function(e){e.groups=[];for(let t=0;t<e.media.length;t++)e.groups.push({type:"BUNDLE",mids:e.media[t].mid})},setMediaContentType:function(e,t){if(e&&t){if(e.media&&e.media.length)for(let i=0;i<e.media.length;i++){let o=e.media[i];"video"!==o.type||o.content||(o.content=t.shift())}}else console.error("invalid error..")},modifyBundleGroups:function(e,t){e.groups=[],e.groups.mids=[];for(let i=0;i<e.media.length;i++){e.media[i].mid!==t&&e.groups.mids.push(e.media[i].mid)}e.groups.push({type:"BUNDLE",mids:e.groups.mids.join(" ")}),delete e.groups.mids},getMediaByType:function(e,t){if(!e||!t)return void console.error("invalid error..");let i;if(e.media&&e.media.length)for(let o=0;o<e.media.length;o++){let n=e.media[o];if("video"===n.type&&n.content===t){i=n;break}}return i},removeCodecByPayload:function(e,t,i){if(t>=e.media.length)return void console.log("Error index");let o=e.media[t];for(let e=0;e<i.length;e+=1)for(let t=0;t<o.fmtp.length;t+=1)null!=o.fmtp[t].config.match("apt="+i[e])&&-1===i.indexOf(o.fmtp[t].payload)&&i.push(o.fmtp[t].payload);if(o.payloads&&o.payloads.split){let e=o.payloads.split(" ");for(let t=0;t<i.length;t++)for(let o=0;o<e.length;o++)parseInt(i[t])===parseInt(e[o])&&(e.splice(o,1),o--);o.payloads=e.join(" ")}i.forEach((e=>{if(void 0!==o.rtp)for(let t=0;t<o.rtp.length;){if(o.rtp[t].payload===e){o.rtp.splice(t,1);break}t+=1}if(void 0!==o.fmtp)for(let t=0;t<o.fmtp.length;)o.fmtp[t].payload===e?o.fmtp.splice(t,1):t+=1;if(void 0!==o.rtcpFb)for(let t=0;t<o.rtcpFb.length;)o.rtcpFb[t].payload===e?o.rtcpFb.splice(t,1):t+=1})),"string"==typeof o.payloads&&(o.payloads=o.payloads.replace(/[ ]+/g," ").replace(/^\s*|\s*$/g,""))},removeCodecByName:function(e,t,i,o){if(t>=e.media.length)return void console.log("Error index");let n=[],r=e.media[t],s=[];r.rtp.forEach((e=>{o?i.includes(e.codec)?s.push(e.payload):n.push(e.payload):i.forEach((t=>{e.codec===t&&n.push(e.payload)}))})),s.map((e=>{r.fmtp.forEach((t=>{if(t.config.match("apt="+e)){let e=n.indexOf(t.payload);e>=0&&n.splice(e,1)}}))})),this.removeCodecByPayload(e,t,n)},getRTCRtpCapabilities:function(e,t){if(!e)return console.warn("no sdp"),null;if(!t||!t.length)return console.error("excludeList is not allowed to be empty"),null;let i={haveAudio:!1,haveVideo:!1},o=!1,n=SDPTools.parseSDP(e);if(n&&n.media&&n.media.length)for(let e=0;e<n.media.length;e++){let r=n.media[e];if("audio"===r.type){if(i.haveAudio=!0,i.audioCodecs||(i.audioCodecs=[]),r.rtp&&r.rtp.length)for(let e=0;e<r.rtp.length;e++){let o=r.rtp[e];!o.codec||t.includes(o.codec)||i.audioCodecs.includes(o.codec)||i.audioCodecs.push(o.codec)}}else if("video"===r.type&&!o){if(i.haveVideo=!0,i.videoCodecs||(i.videoCodecs=[]),r.rtp&&r.rtp.length)for(let e=0;e<r.rtp.length;e++){let o=r.rtp[e];!o.codec||t.includes(o.codec)||i.videoCodecs.includes(o.codec)||i.videoCodecs.push(o.codec)}o=!0}}return i},getCodecByName:function(e,t,i){if(t>=e.media.length)return void console.log("Error index");let o=[];return e.media[t].rtp.forEach((e=>{i.forEach((t=>{e.codec===t&&o.push(e.payload)}))})),o},setH264Resolution:function(e,t,i){if(!e||!i)return void console.warn("h264 res: Invalid argument!");let o=this.resolutionToLevelIdcMap[i]||"16",n=this.getCodecByName(e,t,["H264"]),r=e.media[t];if(r){let e=r.fmtp;if(e.length>0)for(let t=0;t<e.length;t++){let i=e[t].config.indexOf("profile-level-id");if(i>=0){let n=e[t].config.substr(i,21)+o;e[t].config=e[t].config.replace(/profile-level-id=([a-zA-Z0-9]{6})/,n)}else{let i;e[t].config.indexOf("apt=")>=0&&(i=parseInt(e[t].config.match("apt=[0-9]+")[0].split("=")[1])),(n.includes(e[t].payload)||n.includes(i))&&(e[t].config=e[t].config+";profile-level-id=42e0"+o)}}else console.info("profile-level-id fmtp filed has not been find")}else console.log("no media")},setVp8Resolution:function(e,t,i,o){if(!e||!i||!o)return void console.warn("VP8 res: Invalid argument!");let n=(parseInt(i,10)+15)/16,r=(parseInt(o,10)+15)/16,s=Math.floor(n)*Math.floor(r),a=this.getCodecByName(e,t,["VP8"]),l=e.media[t];if(l){let e=l.fmtp;for(let t=0;t<e.length;t++){if(e[t].config.indexOf("max-fs")>=0){let i="max-fs="+s;e[t].config=e[t].config.replace(/max-fs=([a-zA-Z0-9]{3,5})/,i)}else{let i;e[t].config.indexOf("apt=")>=0&&(i=parseInt(e[t].config.match("apt=[0-9]+")[0].split("=")[1])),(a.includes(e[t].payload)||a.includes(i))&&(e[t].config=e[t].config+";max-fs="+s)}}}else console.warn("no media found")},setResolution:function(e,t,i,o){if(!e||!i||!o)return console.error("Invalid argument"),null;this.setH264Resolution(e,t,o),this.setVp8Resolution(e,t,i,o)},getH264Resolution:function(e,t){let i,o,n=e.media[t];if(n){for(let e=0;e<n.fmtp.length;e++){if(n.fmtp[e].config.indexOf("profile-level-id=")>=0){o=n.fmtp[e].config.match("profile-level-id=[a-zA-Z0-9]{6}")[0].split("=")[1].substr(4,2).toLocaleLowerCase();break}}i=this.levelIdcToReSolutionMap[o]||{width:640,height:360}}return i},getVp8Resolution:function(e,t){let i,o,n=e.media[t];if(n){for(let e=0;e<n.fmtp.length;e++){if(n.fmtp[e].config.indexOf("max-fs=")>=0){o=parseInt(n.fmtp[e].config.match("max-fs=[0-9]+")[0].split("=")[1]);break}}o=parseInt(o),i=this.maxFsToResolutionMap[o]||{width:640,height:360}}return i},getResolution:function(e,t,i){if(!e||!t&&0!==t)return void console.error("Invalid argument");let o;return"H264"===(i=i||this.getPriorityCodec(e,t))?o=this.getH264Resolution(e,t):"VP8"===i&&(o=this.getVp8Resolution(e,t)),o},getPriorityCodec:function(e,t){if(!e)return void console.warn("setFrameRate: Invalid argument!");let i,o=e.media[t];if(o&&o.rtp&&o.rtp.length)for(let e=0;e<o.rtp.length;e++)if(o.rtp[e].codec&&"rtx"!==o.rtp[e].codec){i=o.rtp[e].codec;break}return i},setFrameRate:function(e,t,i){if(!e||!i)return void console.warn("setFrameRate: Invalid argument!");let o=e.media[t];if(o)if(o.framerate)o.framerate=i;else if(o.fmtp&&o.fmtp.length>0){let e=o.fmtp;for(let t=0;t<e.length;t++){if(e[t].config.indexOf("max-fr")>=0){let o="max-fr="+i;e[t].config=e[t].config.replace(/max-fr=([a-zA-Z0-9]{1,2})/,o)}}}},getFramerate:function(e,t){let i=e.media[t],o=null;if(i)if(i.framerate)o=i.framerate;else if(i.fmtp&&i.fmtp.length>0){let e=i.fmtp;for(let t=0;t<e.length;t++){let i=e[t].config.indexOf("max-fr");if(i>=0){var n=e[t].config.substring(i+7),r=n.indexOf(";");r>=0&&(n=n.substring(0,r)),o=parseInt(n)}}}return o},setMediaBandwidth:function(e,t,i){if(!e||!i)return;let o={AS:i/1e3+192,TIAS:i},n=e.media[t];n&&(n.bandwidth&&n.bandwidth.length?n.bandwidth.forEach((function(e){e.limit=o[e.type]})):(n.bandwidth=[],Object.keys(o).forEach((function(e){e&&n.bandwidth.push({type:e,limit:o[e]})}))))},setXgoogle:function(e,t,i){if("audio"!==e.type&&e.fmtp&&e.fmtp.length)for(let o=0;o<e.fmtp.length;o++)if(t.includes(e.fmtp[o].payload)){let t=e.fmtp[o].config;t=t.indexOf("x-google-min-bitrate=")>=0?t.replace(/x-google-min-bitrate=([a-zA-Z0-9]{1,8})/,"x-google-min-bitrate="+i):t+";x-google-min-bitrate="+i,t=t.indexOf("x-google-start-bitrate=")>=0?t.replace(/x-google-start-bitrate=([a-zA-Z0-9]{1,8})/,"x-google-start-bitrate="+i):t+";x-google-start-bitrate="+i,t=t.indexOf("x-google-max-bitrate=")>=0?t.replace(/x-google-max-bitrate=([a-zA-Z0-9]{1,8})/,"x-google-max-bitrate="+i):t+";x-google-max-bitrate="+i,e.fmtp[o].config=t}},setXgoogleBitrate:function(e,t,i){if(i||0===i){let o=this.getCodecByName(e,i,["H264"]),n=e.media[i];this.setXgoogle(n,o,t)}else for(let i=0;i<e.media.length;i++){let o=this.getCodecByName(e,i,["H264"]),n=e.media[i];this.setXgoogle(n,o,t)}},removeRembAndTransportCC:function(e,t){let i=function(e){if(e.rtcpFb&&e.rtcpFb.length)for(let t=0;t<e.rtcpFb.length;t++){let i=e.rtcpFb[t].type;i&&(i.indexOf("goog-remb")>=0||i.indexOf("transport-cc")>=0)&&(e.rtcpFb.splice(t,1),t--)}};if(void 0!==t){i(e.media[t])}else for(let t=0;t<e.media.length;t++)i(e.media[t])},addCandidate:function(e,t){if(!e||!t)return;e.candidates&&e.candidates.length||(e.candidates=[]);let i=t[0],o=t.slice(2);for(let t=0;t<(grammar[i]||[]).length;t+=1){let n=grammar[i][t];if(n.reg.test(o)){let t={};attachProperties(o.match(n.reg),t,n.names,n.name),t&&!t.value&&e.candidates.push(t)}}},parseFmtpConfig:function(e){return e.split(/;\s?/).reduce(paramReducer,{})},parsePayloads:function(e){return e.toString().split(" ").map(Number)},parseRemoteCandidates:function(e){let t=[],i=e.split(" ").map(toIntIfInt);for(let e=0;e<i.length;e+=3)t.push({component:i[e],ip:i[e+1],port:i[e+2]});return t},parseImageAttributes:function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(paramReducer,{})}))},parseSimulcastStreamList:function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){let t,i=!1;return"~"!==e[0]?t=toIntIfInt(e):(t=toIntIfInt(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))},mergeSDP:function(e){let t,i=[];for(let t=0;t<e.length;t+=1)i[t]=this.parseSDP(e[t]);let o=0;for(let t=0;t<e.length;t+=1)for(let e=0;e<i[t].media.length;e+=1){let n={};n.msid=i[t].media[e].msid,n.mid=i[t].media[e].mid,n.mappedMID=o,this.midMap.push(n),"string"==typeof i[t].groups[0].mids?i[t].groups[0].mids=i[t].groups[0].mids.replace(i[t].media[e].mid,o):"number"==typeof i[t].groups[0].mids?i[t].groups[0].mids=o:console.log("ERROR on Process mid mapping"),i[t].media[e].mid=o,o+=1}void 0===i[0].groups&&(i[0].groups=[]),void 0===i[0].msidSemantics&&(i[0].msidSemantics=[]);for(let t=0;t<e.length;t+=1)console.log("Session "+t+"th:\n"+i[t]),void 0!==i[t].fingerprint&&(i[t].media.forEach((function(e){e.fingerprint=deepCopy(i[t].fingerprint)})),delete i[t].fingerprint),void 0!==i[t].groups&&t>0&&i[t].groups.forEach((function(e){i[0].groups.push(deepCopy(e))})),void 0!==i[t].msidSemantics&&t>0&&i[t].msidSemantics.forEach((function(e){i[0].msidSemantics.push(deepCopy(e))}));for(let t=0;t<e.length;t+=1)void 0!==i[t].media&&t>0&&i[t].media.forEach((function(e){i[0].media.push(deepCopy(e))}));return t=this.writeSDP(i[0]),t},splitSDP:function(e){let t=[],i=this.parseSDP(e);if(void 0===i.groups){console.log("No GROUP information, need to split m lines to each pc"),i.groups=[],this.midMap=[];for(let e=0;e<i.media.length;e+=1){i.groups.push({type:"BUNDLE",mids:i.media[e].mid});let t={};t.msid=i.media[e].msid,t.mid=0,t.mappedMID=i.media[e].mid,this.midMap.push(t)}}for(let e=0;e<i.groups.length;e+=1){let o,n=deepCopy(i);n.groups=new Array(n.groups[e]),void 0!==n.msidSemantics?n.msidSemantics=new Array(n.msidSemantics[e]):delete n.msidSemantics;let r=[];if("number"==typeof n.groups[e].mids){for(let t=0;t<n.media.length;t+=1)if(n.media[t].mid===n.groups[e].mids){r.push(n.media[t]);break}}else"string"==typeof n.groups[e].mids&&n.groups[0].mids.split(" ").forEach((e=>{for(let t=0;t<n.media.length;t+=1)if(n.media[t].mid===e){r.push(n.media[t]);break}}));n.media=r;for(let e=0;e<n.media.length;e+=1)for(let t=0;t<this.midMap.length;t+=1)if(n.media[e].mid===this.midMap[t].mappedMID){n.media[e].mid=this.midMap[t].mid,"string"==typeof n.groups[0].mids?n.groups[0].mids=n.groups[0].mids.replace(n.media[e].mid,this.midMap[t].mid):"number"==typeof n.groups[0].mids?n.groups[0].mids=this.midMap[t].mid:console.log("ERROR on Process mid mapping");break}o=this.writeSDP(n),t.push(o)}return t}};var worker=new Worker("./jsSipStackWorker.js");function objectClone(e){if(null===e||"object"!=typeof e)return e;var t=function(e){var t=e.constructor();for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t};if("object"==typeof e&&!Array.isArray(e))try{return JSON.parse(JSON.stringify(e))}catch(i){return t(e)}return t(e)}worker.onmessage=function(e){postMessage(e.data,"*")};var session=objectClone(window.sessionStorage),local=objectClone(window.localStorage);function addHeaderList(e,t,i=0,o=0){"string"==typeof e&&"string"==typeof t&&"number"==typeof i&&"number"==typeof o?worker.postMessage({cmd:"addHeaderList",headerName:e,headerValue:t,isModify:i,modifyPos:o}):log.error("addHeaderList param type is error. headerName:string, headerValue:string, isModify:number, modifyPos:number")}function jsSipInit(e=null){null===e||"number"==typeof e?worker.postMessage({cmd:"jsSipInit",level:e}):log.error("jsSipInit param type is error. level:number")}function jsSipStart(e){worker.postMessage({cmd:"jsSipStart",config:e})}function jsSipStop(){worker.postMessage({cmd:"jsSipStop"})}function jsSipSendRegister(e,t=null,i=null){"number"==typeof e&&(null===t&&null===i||"string"==typeof t&&"string"==typeof i)?worker.postMessage({cmd:"jsSipSendRegister",expires:e,contentType:t,body:i}):log.error("jsSipSendRegister param type is error. expires:number, contentType:string/null, body:string/null")}function jsSipSendUnRegister(e=null,t=null){null===e&&null===t||"string"==typeof e&&"string"==typeof t?worker.postMessage({cmd:"jsSipSendUnRegister",contentType:e,body:t}):log.error("jsSipSendUnRegister param type is error. contentType:string/null, body:string/null")}function jsSipSendMessage(e=-1,t=null,i=null){"number"==typeof e&&(null===t&&null===i||"string"==typeof t&&"string"==typeof i)?worker.postMessage({cmd:"jsSipSendMessage",line:e,contentType:t,body:i}):log.error("jsSipSendMessage param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendOptions(e,t=-1,i=null,o=null){"string"==typeof e&&"number"==typeof t&&(null===i&&null===o||"string"==typeof i&&"string"==typeof o)?worker.postMessage({cmd:"jsSipSendOptions",toUri:e,line:t,contentType:i,body:o}):log.error("jsSipSendOptions param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendSubscribe(e,t,i,o,n,r=null,s=null){"string"!=typeof e||"string"!=typeof t||"number"!=typeof i||"number"!=typeof o||null!==n&&"string"!=typeof n||!(null===r&&null===s||"string"==typeof r&&"string"==typeof s)?log.error("jsSipSendSubscribe param type is error. line:number, contentType:string/null, body:string/null"):worker.postMessage({cmd:"jsSipSendSubscribe",toUri:e,event:t,id:i,expires:o,accept:n,contentType:r,body:s})}function jsSipSendInvite(e,t=0,i=null,o=null,n=!1){(null===i&&null===o||"string"==typeof i&&"string"==typeof o)&&"string"==typeof e&&"number"==typeof t&&"boolean"==typeof n?worker.postMessage({cmd:"jsSipSendInvite",toUri:e,line:t,contentType:i,body:o,anonymous:n}):log.error("jsSipSendInvite param type is error. toUri:string, line:number, contentType:string/null, body:string/null, anonymous:boolean")}function jsSipSendCancel(e,t=null,i=null){"number"==typeof e&&(null===t&&null===i||"string"==typeof t&&"string"==typeof i)?worker.postMessage({cmd:"jsSipSendCancel",line:e,contentType:t,body:i}):log.error("jsSipSendCancel param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendReInvite(e=0,t=null,i=null){"number"==typeof e&&(null===t&&null===i||"string"==typeof t&&"string"==typeof i)?worker.postMessage({cmd:"jsSipSendReInvite",line:e,contentType:t,body:i}):log.error("jsSipSendReInvite param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendInfo(e=0,t=null,i=null){"number"==typeof e&&(null===t&&null===i||"string"==typeof t&&"string"==typeof i)?worker.postMessage({cmd:"jsSipSendInfo",line:e,contentType:t,body:i}):log.error("jsSipSendInfo param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendUpdate(e=0,t=null,i=null){"number"==typeof e&&(null===t&&null===i||"string"==typeof t&&"string"==typeof i)?worker.postMessage({cmd:"jsSipSendUpdate",line:e,contentType:t,body:i}):log.error("jsSipSendUpdate param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendRefer(e,t,i=0,o=null,n=null){(null===o&&null===n||"string"==typeof o&&"string"==typeof n)&&"number"==typeof i&&"string"==typeof e&&"string"==typeof t?worker.postMessage({cmd:"jsSipSendRefer",referTo:e,referredBy:t,line:i,contentType:o,body:n}):log.error("jsSipSendRefer param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendBye(e=0,t=null,i=null){"number"==typeof e&&(null===t&&null===i||"string"==typeof t&&"string"==typeof i)?worker.postMessage({cmd:"jsSipSendBye",line:e,contentType:t,body:i}):log.error("jsSipSendBye param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendAck(e=0,t=null,i=null){"number"==typeof e&&(null===t&&null===i||"string"==typeof t&&"string"==typeof i)?worker.postMessage({cmd:"jsSipSendAck",line:e,contentType:t,body:i}):log.error("jsSipSendAck param type is error. line:number, contentType:string/null, body:string/null")}function jsSipSendRsp(e,t,i=null,o=null){"number"==typeof e&&"number"==typeof t&&(null===i&&null===o||"string"==typeof i&&"string"==typeof o)?worker.postMessage({cmd:"jsSipSendRsp",transaction:e,rspcode:t,contentType:i,body:o}):log.error("jsSipSendRsp param type is error. transaction:number, rspcode:number, contentType:string/null, body:string/null")}function jsSipAcceptCall(e,t=0,i=200,o=null,n=null){"number"==typeof e&&"number"==typeof t&&"number"==typeof i&&(null===o&&null===n||"string"==typeof o&&"string"==typeof n)?worker.postMessage({cmd:"jsSipAcceptCall",transaction:e,line:t,rspcode:i,contentType:o,body:n}):log.error("jsSipAcceptCall param type is error. transaction:number, line:number, contentType:string/null, body:string/null")}function jsSipParser(e){"string"==typeof e?worker.postMessage({cmd:"jsSipParser",param:e}):log.error("jsSipParser param type is error. buf:string")}worker.postMessage({cmd:"workerParam",sessionStorage:session,localStorage:local});let log={};log.debug=window.debug("sipWebRTC:DEBUG"),log.log=window.debug("sipWebRTC:LOG"),log.info=window.debug("sipWebRTC:INFO"),log.warn=window.debug("sipWebRTC:WARN"),log.error=window.debug("sipWebRTC:ERROR");let GsRTC=function(e){log.info("set options: "+JSON.stringify(e,null,"    ")),this.accountId="",this.onCall=!1,this.conf=e,this.subscribeIdIndex=1,this.lineIdCount=1,this.capabilitiesCodecExcludeList=["telephone-event","rtx","red","ulpfec"],this.RTCRtpReceiverCapabilities={AUDIO_CODECS:[],VIDEO_CODECS:[]},this.subscribeEvents=[],this.webrtcSessions=[],this.socket=null,this.isWsReconToRefreSubscAndReInvite=!1,this.device=new MediaDevice,this.deviceInit(),this.sipStack=new SipStack,e&&(log.info("set storage config"),this.loadStorageConfiguration()),this.setRTCRtpReceiverCapabilities()};GsRTC.prototype.preInit=function(){log.info("preInit: create new GsRTC object");try{log.info("get gsRTC instrance"),window.gsRTC=new GsRTC({})}catch(e){log.error(e.toString())}},GsRTC.prototype.SIP_RESPONSE_CODES={OK:200,RING:180,TEMPORARILY_UNAVAILABLE:480,BUSY_HERE:486,NOT_ACCEPTABLE_HERE:488,REQUEST_PENDING:491},GsRTC.prototype.CODE_TYPE={PARAMETER_ERROR:16,COMMON_ERROR:17,INCOMING_CALL_CANCELED:101,FAILED_TO_MUTE_MIC:110,FAILED_TO_UNMUTE_MIC:111,FAILED_TO_ADJUST_RESOLUTION:113,FAILED_TO_VIDEO_ON:114,CAMERA_NOT_SUPPORT:115,SERVER_RESOURCE_REACHED_LIMIT:116,FAILED_TO_CLOSE_LOCAL_VIDEO:117,FAILED_TO_OPEN_LOCAL_VIDEO:118,CODE_NOT_SUPPORT:119,CANCEL_TO_SCREEN_SHARE:121,FAILED_TO_SCREEN_SHARE:122,SHARE_PERMISSION_DENIED:123,SHARE_STREAM_STOPPED_BY_CONTROL_BAR:124,FAILED_TO_STOP_SCREEN_SHARE:125,FAILED_TO_GET_SCREEN_STREAM:126,FAILED_TO_SWITCH_SCREEN_STREAM:127,FAILED_TO_SEND_INFO:133,FAILED_TO_SEND_MESSAGE:134,FAILED_TO_HOLD:135,FAILED_TO_RESUME:136,WEBSOCKET_RECONNECTION_FAILED:137,WEBSOCKET_CONNECTING:138,WEBSOCKET_CLOSE:139,ICE_CONNECTION_FAILED:151,ICE_RECONNECTING:152,ICE_RECONNECTED_FAILED:153,MIC_NOT_FOUND:932,MIC_NOT_READABLE:933,MIC_REQUEST_REFUSE:941,MIC_REQUEST_FAIL:942,MIC_REQUEST_CLOSE:943,MIC_TYPE_ERROR:944,VIDEO_REQUEST_REFUSE:945,VIDEO_REQUEST_OCCUPY:946,VIDEO_REQUEST_BEYOND:948,VIDEO_REQUEST_FAIL:949,VIDEO_NOT_FOUND:950,VIDEO_TYPE_ERROR:951,VIDEO_NOT_READABLE:952,VIDEO_REQUEST_OVER_CONSTRAINTS:953,ACTION_SUCCESS:999},GsRTC.prototype.EVENTS={OnError:void 0,onCallEnd:void 0,onStreamChange:void 0},GsRTC.prototype.setRTCRtpReceiverCapabilities=function(){log.info("save the capabilities of the system for receiving media");let e=this,t=function(t){t?(e.RTCRtpReceiverCapabilities={AUDIO_CODECS:t.audioCodecs,VIDEO_CODECS:t.videoCodecs},log.info("save RTCRtp Receiver Capabilities")):log.warn("no Capabilities get")};if(RTCRtpReceiver.getCapabilities){log.info("get capabilities form RTCRtpReceiver.getCapabilities");let i=GsRTC.prototype.getRTCRtpCapabilities(e.capabilitiesCodecExcludeList);log.info("capabilities: "+JSON.stringify(i,null,"    ")),t(i)}else{log.info("get capabilities form sdp");let i=new RTCPeerConnection;i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then((function(o){let n=SDPTools.getRTCRtpCapabilities(o.sdp,e.capabilitiesCodecExcludeList);log.info("capabilities: "+JSON.stringify(n,null,"    ")),t(n),i.close()})).catch((function(e){log.warn("setRTCRtpReceiverCapabilities error: "+e.name)}))}},GsRTC.prototype.loadStorageConfiguration=function(){log.info("local storage configuration"),"chrome"===this.getBrowserDetail().browser&&this.getBrowserDetail().version>=69||"safari"===this.getBrowserDetail().browser?(log.info("set test_red_ulpfec_enabled false"),localStorage.setItem("test_red_ulpfec_enabled","false")):void 0===localStorage.test_red_ulpfec_enabled&&(log.info("set test_red_ulpfec_enabled true"),localStorage.setItem("test_red_ulpfec_enabled","true")),log.warn("Open trickle ice!"),localStorage.setItem("enableTrickleIce","true")},GsRTC.prototype.deviceInit=function(){log.info("device init");let e=this;window.MediaDevice?(e.device||(e.device=new MediaDevice),e.device.availableDev={},e.device.currentDev={},e.device.enumDevices((t=>{e.device.availableDev.videoInputList=t.cameras,e.device.availableDev.audioOutputList=t.speakers,e.device.availableDev.audioInputList=t.microphones,e.device.checkAvailableDev()}),(function(e){log.error("enum device error: "+e)}))):log.info("MediaDevice is not exist!")},GsRTC.prototype.on=function(e,t){if("function"!=typeof t)throw new Error("Provided parameter is not a function");this.EVENTS[e]=[],this.EVENTS[e].push(t)},GsRTC.prototype.off=function(e,t){if(e&&"string"==typeof e){if(void 0===t)return void(this.EVENTS[e]=[]);let i=this.EVENTS[e]||[];for(let e=0;e<i.length;e++)if(i[e]===t){i.splice(e,1);break}}else this.EVENTS={}},GsRTC.prototype.trigger=function(e){let t=Array.prototype.slice.call(arguments),i=this.EVENTS[e];if(t.shift(),i)for(let e=0;e<i.length;e++)try{if(!1===i[e].apply(this,t))break}catch(e){throw e}},window.addEventListener("load",(function(){log.info("window onload!"),window.gsRTC||(log.info("init..."),GsRTC.prototype.preInit())})),GsRTC.prototype.sipSetConfig=function(e){log.info("set sip config");e?gsRTC?(gsRTC.conf=gsRTC.conf||{},e.iceServer&&e.iceServer.length&&(log.info("set iceServers"),gsRTC.conf.iceServers=e.iceServer),e.iceTransportPolicy&&(log.info("set iceTransportPolicy"),gsRTC.conf.iceTransportPolicy=e.iceTransportPolicy),e.RTCpeerConnectionOptional&&(log.info("set RTCpeerConnectionOptional"),gsRTC.conf.RTCpeerConnectionOptional=e.RTCpeerConnectionOptional)):log.error("sipSetConfig: gsRTC is not initialized"):log.error("sipSetConfig: Invalid Argument")},GsRTC.prototype.sipRegister=function(e){if(log.info("sipRegister.. "),!e)return void log.error("sipRegister failed: Invalid Argument");this.device&&(log.info("set device check interval"),this.device.setDeviceCheckInterval(!0));let t=this.getBrowserDetail();window.ipcRenderer?e.userAgent="Grandstream Wave Desktop "+e.version+" ("+t.browser+" "+t.UIVersion+" "+t.systemFriendlyName+")":e.userAgent="Grandstream Wave Web "+e.version+" ("+t.browser+" "+t.UIVersion+" "+t.systemFriendlyName+")",log.info("userAgent: "+e.userAgent),this.conf&&(this.conf.sipRealm=e.sipRealm,this.conf.sipImpi=e.sipImpi,this.conf.sipPasswd=e.sipPasswd,this.conf.sipDisplayName=e.sipDisplayName,this.conf.userAgent=e.userAgent,this.conf.host=e.host,this.conf.organization=e.organization,this.conf.protocol=e.protocol,this.conf.websocketUrl=e.websocketUrl,this.conf.iceServers=e.iceServers,this.conf.iceTransportPolicy=e.iceTransportPolicy,this.conf.RTCpeerConnectionOptional=e.RTCpeerConnectionOptional,this.accountId=e.sipImpi),e.callback&&this.on("onSipRegister",e.callback);let i=function(e,t){if(gsRTC.sipStack){if(gsRTC.sipStack.initialized)return log.info("gsRTC already initialized!!!"),void gsRTC.sipStack.jsSipSendRegister(gsRTC.sipStack.REGISTER_EXPIRES);gsRTC.sipStack.init(e,t)}else log.warn("sipStack does not exist for register")};!this.socket||this.socket.ws&&1!==this.socket.ws.readyState?this.socket=new WebSocketInstance(e.websocketUrl,e.protocol,i):i(e,e.callback)},GsRTC.prototype.sipUnRegister=function(e){let t=this;if(log.info("sip unRegister..."),t.sipStack.initialized=!1,!t||!t.sipStack)throw new Error("unRegister: sipStack is not exist!");e&&e.callback&&t.on("onSipUnRegister",(function(t){log.info("un-register data: "+JSON.stringify(t,null,"    ")),e.callback(t)})),t.sipStack.jsSipSendUnRegister()},GsRTC.prototype.sipCallInit=function(e){if(log.info("sipRegister.. "),!e)return void log.error("sipRegister failed: Invalid Argument");let t=this.getBrowserDetail();window.ipcRenderer?e.userAgent="Grandstream Wave Desktop "+e.version+" ("+t.browser+" "+t.UIVersion+" "+t.systemFriendlyName+")":e.userAgent="Grandstream Wave Web "+e.version+" ("+t.browser+" "+t.UIVersion+" "+t.systemFriendlyName+")",log.info("userAgent: "+e.userAgent),this.conf&&(this.conf.sipRealm=e.sipRealm,this.conf.sipImpi=e.sipImpi,this.conf.sipPasswd=e.sipPasswd,this.conf.sipDisplayName=e.sipDisplayName,this.conf.userAgent=e.userAgent,this.conf.host=e.host,this.conf.organization=e.organization,this.conf.protocol=e.protocol,this.conf.websocketUrl=e.websocketUrl,this.accountId=e.sipImpi,this.click2Talk=e.click2Talk),this.on("onSipCallInit",e.callback);let i=function(e,t){gsRTC.sipStack?gsRTC.sipStack.init(e,t):log.warn("sipStack does not exist for register")};!this.socket||this.socket.ws&&1!==this.socket.ws.readyState?this.socket=new WebSocketInstance(e.websocketUrl,e.protocol,i):i(e,e.callback)},GsRTC.prototype.sipCall=async function(e){let t=this;if(log.info("sipCallInfo: "+JSON.stringify(e,null,"    ")),!e||!e.type||!e.peerAccount)return log.warn("sipCall: ERR_INVALID_PARAMETER_VALUE"),void(e&&e.callback({codeType:t.CODE_TYPE.PARAMETER_ERROR}));let i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(i)return void log.warn("multiple calls is not allow for the same number!");i=WebRTCSession.prototype.getSessionInstance();let o=t.conf||{};o.peerAccount=String(e.peerAccount),o.type=e.type,i.callType=e.type,i.conf=o,i.action="onSipCall",i.actionCallback=function(o){o.isLocalVideoOn=i.isLocalVideoOn,log.info("sip call back: "+JSON.stringify(o,null,"    ")),e.callback&&e.callback(o),t.onCall?(999===o.codeType&&(log.info("call success"),t.trigger("onCallAnswered",{type:i.callType,channelID:i.channelID,to:i.peerAccount,isGDS:i.isGDS})),i.actionCallback=null,i.action=null):log.info("session is not on call")},await i.createRTCSession(o,e.type)},GsRTC.prototype.sipRefuse=function(e){log.info("sip refuse...");let t=this;if(!t||!t.sipStack)return void log.warn("refuse incoming call: null sipStack");if(!e||!e.peerAccount)return void log.warn("sipRefuse: ERR_INVALID_PARAMETER_VALUE");log.warn("refuse incoming call of "+e.peerAccount);let i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});i?(i.isGDSCall&&(i.isGDSCall="callRefuse"),t.sipStack.sendSipMessage({session:i,rspCode:t.SIP_RESPONSE_CODES.BUSY_HERE}),log.warn("remove session of line "+i.lineId),t.cleanSession({lineId:i.lineId})):log.warn("refuse incoming call: null session found")},GsRTC.prototype.sipAccept=function(e){if(log.info("sip accept data: "+JSON.stringify(e,null,"    ")),!e||!e.peerAccount)return void log.info("sipAccept: invalid parameters");function t(t){t.isLocalVideoOn=i.isLocalVideoOn,log.info("call accept data "+JSON.stringify(t,null,"    ")),e.callback&&e.callback(t),i.actionCallback=null,i.action=null}let i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(i.isIncomingCall=!0,this.conf.peerAccount=i.peerAccount?i.peerAccount:"",i){i.action="sipAccept",i.on("sipAccept",t),i.callType=e.type,i.isRequestOpenLocalVideo=i.callType.indexOf("Video")>=0;let o=i.remotePendingSdp;i.isGDSCall&&(log.info("GDS answer call"),i.isGDSCall="callAnswer",o=i.pc&&i.pc.currentRemoteDescription&&i.pc.currentRemoteDescription.sdp),i.actionCallback=t,o?i.handleServerRequestSdp(o):log.warn("sipAccept: no sdp found")}else log.warn("incoming call: session is null")},GsRTC.prototype.sipHold=function(e){if(!e||!e.peerAccount)return void log.error("invalid hold parameters!");log.info("hold data: "+JSON.stringify(e,null,"    "));let t=this,i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});i?(log.warn("Hold account "+e.peerAccount),i.action=e.isHold?"hold":"unhold",i.actionCallback=function(){e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS}),i.actionCallback=null,i.action=null},Object.keys(i.localStreams).forEach((function(e){let t=i.localStreams[e];t&&(log.info("mute line local stream"+t.id),i.streamMuteSwitch({stream:t,type:"audio"===e?"audio":"video",mute:!1}))})),i.doOffer(i.pc,i.callType)):log.info("no session is found")},GsRTC.prototype.sipSendSubscribe=function(e){let t,i=this;if(log.info("sip Subscribe data: "+JSON.stringify(e,null,"   ")),!(e&&e.peerAccount&&e.event&&e.accept))return void log.error("Send Subscribe error: Invalid event or accept");let o=e.event,n=i.subscribeEvents.find((e=>e.event===o));n?(log.info("update subscribe of ("+o+")"),t=n.id):(e.id=i.subscribeIdIndex,i.subscribeEvents.push(e),t=e.id,i.subscribeIdIndex++,log.info("new subscription of ("+o+")")),e.callback&&i.on("onSipSendSubscribe",e.callback),i.sipStack.jsSipSendSubscribe(e.peerAccount,o,t,e.accept,e.expires,e.headers)},GsRTC.prototype.sipSendInfo=function(e){if(log.info("sip send info: "+JSON.stringify(e,null,"   ")),!e||!e.peerAccount)return void log.info("send info invalid paramters");let t=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});t.lineId||log.warn("get session error: "+JSON.stringify(t,null,"   ")),this.sipStack.jsSipSendInfo(t.lineId,[],e.contentType,e.content)},GsRTC.prototype.sipSendDtmf=function(e){if(log.info("send dtmf digit:  "+e.digit),!e||!e.peerAccount)return void log.error("sendDtmf: webrtcSessions is empty");let t,i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(i.pc.getSenders){let o=i.pc.getSenders().find((e=>e.track&&"audio"===e.track.kind));if(!o)return void log.warn("No local audio track to send DTMF with");t=o.dtmf,t&&t.canInsertDTMF?(log.info("prepare send digit: "+e.digit),t.insertDTMF(e.digit)):log.warn("DTMF function not available")}else log.warn("getSenders is not available by current browser version")},GsRTC.prototype.setNWayConferenceConf=function(e){log.info("set nway conference data: "+JSON.stringify(e));let t=this;if(!(e&&e.peerAccount&&e.meetingNumber&&e.meetingType))return log.warn("set NWay Conference Conf: Parameter error"),void(e&&e.callback&&e.callback({codeType:t.CODE_TYPE.PARAMETER_ERROR}));let i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(!i)return log.warn("no session"),void(e&&e.callback&&e.callback({codeType:t.CODE_TYPE.COMMON_ERROR}));log.info("set call type to "+e.meetingType),t.conf.peerAccount=e.meetingNumber,t.conf.type=e.meetingType,i.peerAccount=e.meetingNumber,i.callType=e.meetingType,i.conf={peerAccount:e.meetingNumber,type:e.meetingType},e&&e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS})},GsRTC.prototype.sipHangUp=function(e){var t=this;if(t.sipStack)if(e&&e.peerAccount){log.info("sip hangUp account "+e.peerAccount);try{let i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});i&&(t.onCall?(log.info("hangUp lineID ("+i.lineId+")"),t.sipStack.jsSipSendBye(i.lineId)):(log.info("cancel lineID ("+i.lineId+")"),t.sipStack.jsSipSendCancel(i.lineId)),t.cleanSession({lineId:i.lineId,serverHangup:!0})),e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS})}catch(e){log.error(e)}}else log.error("sipHangUp: Invalid Argument");else log.error("sipHangUp: gsRTC is not initialized")},GsRTC.prototype.shareAudio=function(e){let t=this;if(log.info("shareAudio: "+JSON.stringify(e,null,"    ")),!(e&&e.peerAccount&&e.constraints&&e.constraints.audio))return void log.error("shareAudio: invalid parameters! ");let i="audio",o=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount}),n=function(){log.info("audio refresh result"),e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS}),o.removeInviteAction({action:o.action}),o.actionCallback=null,o.action=null},r=async function(t){if(t.stream){let e=t.stream;log.info(e.id),o.setStream(e,i,!0),o.processAddStream(e,o.pc,i),await o.doOffer(o.pc)}else t.error&&(log.error("Get audio stream failed: "+t.error),e.callback&&e.callback({codeType:WebRTCSession.prototype.getGumErrorCode("audio",t.error.name)}))},s=o.getStream(i,!0);s?(o.streamMuteSwitch({stream:s,type:i,mute:!1}),e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS})):(log.info("getting new stream"),o.action="audioRefresh",o.actionCallback=n,o.sendInviteQueue.push({action:o.action,sdp:null,callback:n}),o.getStreamFromDevice({streamType:"audio",constraints:e.constraints,callback:r}))},GsRTC.prototype.switchLocalAudioDevice=function(e){log.info("switch audio device: "+JSON.stringify(e,null,"    "));let t=this;if(!(e&&e.peerAccount&&e.constraints&&e.constraints.audio&&e.constraints.audio.deviceId))return log.warn("deviceId mandatory"),void t.trigger("OnError",{codeType:t.CODE_TYPE.PARAMETER_ERROR});let i="audio",o=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount}),n=function(){log.info("switch audio result"),e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS}),o.removeInviteAction({action:o.action}),o.actionCallback=null,o.action=null};o.getStreamFromDevice({streamType:"audio",constraints:e.constraints,callback:async function(r){if(r.stream){let s=o.pc,a=o.getStream(i,!0),l=r.stream;a?(a.getAudioTracks().length&&!1===a.getAudioTracks()[0].enabled&&(log.info("audio stream is mute."),o.streamMuteSwitch({stream:l,type:"audio",mute:!0})),o.processAddStream(l,s,i),e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS})):(log.info("clear previous stream"),o.action="switchAudioSource",o.actionCallback=n,o.sendInviteQueue.push({action:o.action,sdp:null,callback:n}),o.processRemoveStream(a,s,i),o.processAddStream(l,s,i),await o.doOffer(s)),o.closeStream(a),o.setStream(l,i,!0)}else log.error(r.error),e.callback&&e.callback({codeType:WebRTCSession.prototype.getGumErrorCode("video",r.error.name)})}})},GsRTC.prototype.stopShareAudio=function(e){let t=this;if(log.info("stopShareAudio: "+JSON.stringify(e,null,"    ")),!e||!e.peerAccount)return void log.error("stopShareAudio: invalid parameters! ");let i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});try{let o=i.getStream("audio",!0);o?(i.streamMuteSwitch({stream:o,type:"audio",mute:!0}),e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS})):(log.warn("Audio stream: null"),e.callback&&e.callback({codeType:t.CODE_TYPE.FAILED_TO_MUTE_MIC}))}catch(t){log.error(t.toString()),e.callback&&e.callback({error:t})}},GsRTC.prototype.shareVideo=function(e){let t=this;if(log.info("open local video camera: "+JSON.stringify(e,null,"    ")),!(e&&e.peerAccount&&e.constraints&&e.callback))return void log.error("shareVideo: invalid parameters");let i="main",o=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(!o)return void log.info("session is not found");if(o.isLocalVideoOn)return log.warn("Local video is being shared.."),void(e.callback&&e.callback({codeType:t.CODE_TYPE.FAILED_TO_VIDEO_ON}));function n(){if(log.info("video on result"),o.isLocalVideoOn)log.info("video On succeed"),o.videoUpResolution=e.constraints.video,e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS});else{let i=o.errorCode||t.CODE_TYPE.FAILED_TO_VIDEO_ON;log.info("video on failed error code ("+i+")"),e.callback({codeType:i}),o.errorCode=null}o.removeInviteAction({action:o.action}),o.actionCallback=null,o.action=null}let r={streamType:"video",constraints:e.constraints,callback:function(t){if(t.stream){let r=o.pc;log.info("get stream success "+t.stream.id);let s=t.stream,a=document.createElement("video");a.srcObject=s,a.onloadedmetadata=function(){log.info("video: "+a.videoWidth+" * "+a.videoHeight);let t={video:{width:a.videoWidth,height:a.videoHeight}},l=o.getStream(i,!0);l&&(log.info("clear previous stream"),o.processRemoveStream(l,r,i),o.closeStream(l)),o.setVideoUpResolution(t),o.deviceId=e.deviceId,o.setStream(s,i,!0),o.action="shareVideo",o.actionCallback=n,o.sendInviteQueue.push({action:o.action,sdp:null,callback:n}),o.processAddStream(s,r,i),o.doOffer(r,o.callType)}}else if(log.info("get stream failed"),r.error=t.error,r.isFirefox="firefox"===GsRTC.prototype.getBrowserDetail().browser,"OverconstrainedError"===t.error.name||"ConstraintNotSatisfiedError"===t.error.name){let e=o.setConstraintsOfGetStream(r,t.constraints);gsRTC.device.getMedia(r,e)}else e.callback&&e.callback({codeType:WebRTCSession.prototype.getGumErrorCode("video",t.error.name)})}};o.getStreamFromDevice(r)},GsRTC.prototype.switchLocalVideoDevice=function(e){log.info("switch Local video Device: "+JSON.stringify(e,null,"   "));let t=this;if(!(e&&e.peerAccount&&e.constraints&&e.constraints.video&&e.constraints.video.deviceId))return log.warn("switchLocalVideoDevice: invalid paramters"),void(e.callback&&e.callback({codeType:t.CODE_TYPE.PARAMETER_ERROR}));let i="main",o=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount}),n={streamType:"video",constraints:e.constraints,callback:function(r){if(r.stream){log.info("get stream success");let n=r.stream;o.setVideoUpResolution(r.constraints),o.processAddStream(n,o.pc,i),o.closeStream(o.getStream(i,!0)),o.setStream(n,i,!0),o.videoUpResolution=e.constraints.video,e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS})}else if(log.info("switch Local video Device get stream failed"),n.error=r.error,n.isFirefox="firefox"===GsRTC.prototype.getBrowserDetail().browser,n.action="switchLocalVideoDevice","OverconstrainedError"===r.error.name||"ConstraintNotSatisfiedError"===r.error.name){let e=o.setConstraintsOfGetStream(n,r.constraints);gsRTC.device.getMedia(n,e)}else e.callback&&e.callback({codeType:WebRTCSession.prototype.getGumErrorCode("video",r.error.name)})}};o.getStreamFromDevice(n)},GsRTC.prototype.stopShareVideo=function(e){if(log.info("stop share Local video"),!e||!e.peerAccount)return log.info("invalid parameters!"),void e.callback({codeType:t.CODE_TYPE.FAILED_TO_CLOSE_LOCAL_VIDEO});let t=this,i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(!i||!i.isLocalVideoOn)return log.warn("No video need to close.."),void e.callback({codeType:t.CODE_TYPE.FAILED_TO_CLOSE_LOCAL_VIDEO});let o="main";i.action="stopShareVideo",i.actionCallback=function(){log.info("video off result"),e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS}),i.removeInviteAction({action:i.action}),i.actionCallback=null,i.action=null},i.sendInviteQueue.push({action:i.action,sdp:null,callback:i.actionCallback});let n=i.getStream(o,!0);n?(log.info("clear previous stream"),i.deviceId=null,i.processRemoveStream(n,i.pc,o),i.closeStream(n),i.setStream(null,o,!0)):log.warn("stopShareVideo: video stream is null "),i.doOffer(i.pc,i.callType)},GsRTC.prototype.getScreenMediaStream=function(e){if(log.info("share screen getStream"),!e||!e.constraints||!e.constraints.video)return void log.info("invalid paramters to get screen mediaStream: "+JSON.stringify(e,null,"    "));let t=this;WebRTCSession.prototype.getStreamFromDevice({streamType:"screenShare",constraints:e.constraints,callback:function(i){if(i.stream){log.info("get shareScreen stream success, "+i.stream.id);let o=i.stream;if(e.callback&&e.callback({stream:i.stream,codeType:t.CODE_TYPE.ACTION_SUCCESS}),o.oninactive=function(){log.warn("user clicks the bottom share bar to stop sharing screen"),t.trigger("onShareStoppedByControlBar","controlBar")},"firefox"===gsRTC.getBrowserDetail().browser){o.getVideoTracks()[0].onended=function(){log.warn("track: user close share control bar"),t.trigger("onShareStoppedByControlBar","controlBar")}}}else log.warn("Get shareScreen  stream failed: "+i.error),i.error&&i.error.name&&"NotAllowedError"===i.error.name?e.callback({codeType:t.CODE_TYPE.SHARE_PERMISSION_DENIED,errorName:i.error.name}):e.callback({codeType:t.CODE_TYPE.FAILED_TO_GET_SCREEN_STREAM})}})},GsRTC.prototype.shareScreen=function(e){if(log.info("share screen"),!(e&&e.peerAccount&&e.constraints&&e.constraints.video))return void log.info("invalid paramters to screen share: "+JSON.stringify(e,null,"    "));let t=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(!t)return void log.error("shareScreen: session not found! ");let i=this,o="slides";function n(n){if(n.stream){let r=t.pc;log.info("get stream success, "+n.stream.id);let s=n.stream,a=t.getStream("audio",!0);if("firefox"===gsRTC.getBrowserDetail().browser){s.getVideoTracks()[0].onended=function(){log.warn("track: user close share control bar"),i.trigger("onShareStoppedByControlBar","controlBar")}}else s.oninactive=function(){log.warn("user clicks the bottom share bar to stop sharing"),i.trigger("onShareStoppedByControlBar","controlBar")};if(a&&s.getAudioTracks().length>0){let e=i.mixingStream(s,a);t.processAddStream(e,r,"audio")}t.setStream(s,o,!0),t.processAddStream(s,r,o),log.info("share screen success"),e.callback&&e.callback({codeType:i.CODE_TYPE.ACTION_SUCCESS}),t.setEncodingParameters("main")}else log.warn("Get present stream failed: "+n.error),t.actionCallback=null,n.error&&n.error.name&&"NotAllowedError"===n.error.name?e.callback({codeType:i.CODE_TYPE.SHARE_PERMISSION_DENIED,errorName:n.error.name}):e.callback({codeType:i.CODE_TYPE.FAILED_TO_SCREEN_SHARE})}e.stream?n({stream:e.stream}):t.getStreamFromDevice({streamType:"screenShare",constraints:e.constraints,callback:n})},GsRTC.prototype.switchScreenSource=function(e){if(log.info("switch screen source"),!(e&&e.peerAccount&&e.constraints&&e.constraints.video))return void log.info("invalid paramters to screen share: "+JSON.stringify(e,null,"    "));let t=this,i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});i.getStreamFromDevice({streamType:"screenShare",constraints:e.constraints,callback:function(o){if(o.stream){let n=e.type,r=i.pc,s=o.stream;if("firefox"===gsRTC.getBrowserDetail().browser){s.getVideoTracks()[0].onended=function(){log.warn("track: user close share control bar"),t.trigger("onShareStoppedByControlBar","controlBar")}}else s.oninactive=function(){log.warn("user clicks the bottom share bar to stop sharing"),t.trigger("onShareStoppedByControlBar","controlBar")};let a=i.getStream("audio",!0);if(a&&s.getAudioTracks().length>0){log.info("switch share source");let e=t.mixingStream(s,a);i.processAddStream(e,r,"audio")}let l=i.getStream(n,!0);l&&t.isReplaceTrackSupport()&&r.getTransceivers().length>0?(log.info("use replace track to switch presentation stream"),i.processAddStream(s,r,n),e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS}),i.setEncodingParameters("main")):(l&&i.processRemoveStream(l,r,n),i.processAddStream(s,r,n),e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS}),i.setEncodingParameters("main")),i.setStream(s,n,!0)}else log.error(o.error.toString()),o.error&&o.error.name&&"NotAllowedError"===o.error.name?e.callback({codeType:t.CODE_TYPE.SHARE_PERMISSION_DENIED,errorName:o.error.name}):e.callback({codeType:t.CODE_TYPE.FAILED_TO_SWITCH_SCREEN_STREAM})}})},GsRTC.prototype.stopShareScreen=function(e){if(log.info("stop share screen"),!e||!e.peerAccount)return void log.info("invalid paramters to stop screen share");let t=this,i=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(!i)return void log.error("stopShareScreen: session is not found");let o=i.pc,n="slides",r=i.getStream(n,!0);r?(log.info("clear previous stream"),i.processRemoveStream(r,o,n),i.closeStream(r),i.setStream(null,n,!0),e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS}),i.setEncodingParameters("main")):(log.warn("stop share screen: no present stream"),e.callback&&e.callback({codeType:t.CODE_TYPE.FAILED_TO_STOP_SCREEN_SHARE}))},GsRTC.prototype.adjustResolution=function(e){log.info("adjust Resolution data: "+JSON.stringify(e,null,"   "));let t=this;if(!(e&&e.peerAccount&&e.constraints&&e.constraints.video&&e.constraints.video.width&&e.constraints.video.height&&e.constraints.video.deviceId))return void log.error("adjustResolution: invalid parameters");let i="main",o=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});if(!o)return void log.error("adjustResolution: session is not found");let n,r=o.getStream(i,!0),s=0,a=function(){log.info("adjust Resolution Result"),e.callback&&e.callback({codeType:t.CODE_TYPE.ACTION_SUCCESS}),o.removeInviteAction({action:o.action}),o.actionCallback=null,o.action=null},l={streamType:"video",stream:r,constraints:e.constraints,callback:function(t){if(t.stream){log.info("adjust Resolution get stream success");let l=document.createElement("video"),c=t.stream;l.srcObject=c,l.onloadedmetadata=function(){log.info("video: "+l.videoWidth+" * "+l.videoHeight);let t=l.videoWidth,d=l.videoHeight;t===Number(e.constraints.video.width)&&d===Number(e.constraints.video.height)||t===Number(e.constraints.video.width)&&640===t&&(480===d||360===d)?(log.info("adjust Resolution success"),"firefox"===gsRTC.getBrowserDetail().browser&&(o.processAddStream(c,o.pc,i),o.closeStream(r),o.setStream(c,i,!0)),s=0,n={audio:!1,video:{width:l.videoWidth,height:l.videoHeight}},o.action="adjustResolution",o.actionCallback=a,o.sendInviteQueue.push({action:o.action,sdp:null,callback:a}),o.setVideoUpResolution(n),o.videoUpResolution=n.video,o.setEncodingParameters("main"),o.doOffer(o.pc,o.callType)):e.callback&&e.callback({codeType:gsRTC.CODE_TYPE.FAILED_TO_ADJUST_RESOLUTION})}}else log.info("adjust Resolution get stream failed"),t.constraints?(l.error=t.error,l.action="adjustResolution",l.isFirefox="firefox"===GsRTC.prototype.getBrowserDetail().browser,s++,s<2?(n=o.setConstraintsOfGetStream(l,t.constraints),gsRTC.device.getMedia(l,n)):(s=0,e.callback&&e.callback({codeType:WebRTCSession.prototype.getGumErrorCode("video",t.error.name)}))):e.callback&&e.callback({codeType:WebRTCSession.prototype.getGumErrorCode("video",t.error.name)})}};o.getStreamFromDevice(l)},GsRTC.prototype.setVideoBitrate=function(e){if(!e||!e.type||!e.peerAccount)return log.error("setVideoBitrate: invalid session parameters! "),void(e&&e.callback&&e.callback({codeType:this.CODE_TYPE.PARAMETER_ERROR}));let t=WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount});t?t.setEncodingParameters(e.type):log.warn("setVideoBitrate: no session found")},GsRTC.prototype.setSelectedDevice=function(e){log.info("set selected device: "+JSON.stringify(e,null,"    ")),e&&e.type?gsRTC.device.currentDev[e.type+"DeviceId"]=e.deviceId:log.error("set selected device: invalid paramters")},GsRTC.prototype.listenNetStats=function(e){if(!e)return void log.error("No listenNetStats callback!");let t=this;t.webrtcSessions.forEach((function(i){i.statsInterval||(log.info("listen peer to "+i.peerAccount+" stats info"),i.statsInterval=setInterval((()=>{i&&i.pc&&i.getStats(i.pc,null,(o=>{i.processStats(o),t.setNetStats(i),e({data:i.rtpInfo,codeType:t.CODE_TYPE.ACTION_SUCCESS})}),(i=>{e({codeType:t.CODE_TYPE.PARAMETER_ERROR}),log.error("getstats error: ",i)}))}),5e3))}))},GsRTC.prototype.sipSwitchCall=function(e){let t=this;if(e&&!e.peerAccount)if(WebRTCSession.prototype.getSession({key:"peerAccount",value:e.peerAccount}))for(let i=0;i<t.webrtcSessions.length;i++){let o=t.webrtcSessions[i];if(o.peerAccount!==e.peerAccount){t.sipHold({isHold:!0,peerAccount:o.peerAccount}),log.warn("switch call lineId("+o.lineId+")");break}Object.keys(o.localStreams).forEach((function(e){let t=o.localStreams[e];t&&e.indexOf("LOCAL")>=0&&(log.info("unmute line local stream"+t.id),o.streamMuteSwitch({stream:t,type:"audio"===e?"audio":"video",mute:!1}))})),o.doOffer(o.pc,o.conf.type)}else log.warn("sipSwitchCall: no session found");else log.error("sipSwitchCall: invalid parameters!")},GsRTC.prototype.getBrowserDetail=function(){function e(e,t,i){let o=e.match(t);return o&&o.length>=i&&parseInt(o[i],10)}var t=window&&window.navigator,i={browser:null,version:null,UIVersion:null,chromeVersion:null,systemFriendlyName:null};if(t.userAgent.match(/Windows/)?i.systemFriendlyName="windows":t.userAgent.match(/Mac/)?i.systemFriendlyName="mac":t.userAgent.match(/Linux/)&&(i.systemFriendlyName="linux"),"undefined"==typeof window||!window.navigator)return i.browser="Not a browser.",i;if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))i.browser="edge",i.version=e(t.userAgent,/Edge\/(\d+).(\d+)$/,2),i.UIVersion=t.userAgent.match(/Edge\/([\d.]+)/)[1];else if(!t.mediaDevices&&(window.ActiveXObject||"ActiveXObject"in window||t.userAgent.match(/MSIE (\d+)/)||t.userAgent.match(/rv:(\d+)/)))i.browser="ie",t.userAgent.match(/MSIE (\d+)/)?(i.version=e(t.userAgent,/MSIE (\d+).(\d+)/,1),i.UIVersion=t.userAgent.match(/MSIE ([\d.]+)/)[1]):t.userAgent.match(/rv:(\d+)/)&&(i.version=e(t.userAgent,/rv:(\d+).(\d+)/,1),i.UIVersion=t.userAgent.match(/rv:([\d.]+)/)[1]);else if(t.mozGetUserMedia)i.browser="firefox",i.version=e(t.userAgent,/Firefox\/(\d+)\./,1),i.UIVersion=t.userAgent.match(/Firefox\/([\d.]+)/)[1];else if(t.webkitGetUserMedia&&window.webkitRTCPeerConnection){!!t.userAgent.match(/(OPR|Opera).([\d.]+)/)?(i.browser="opera",i.version=e(t.userAgent,/O(PR|pera)\/(\d+)\./,2),i.UIVersion=t.userAgent.match(/O(PR|pera)\/([\d.]+)/)[2],t.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2]&&(i.chromeVersion=e(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2))):(i.browser="chrome",i.version=e(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2),i.UIVersion=t.userAgent.match(/Chrom(e|ium)\/([\d.]+)/)[2])}else{if(!(!t.webkitGetUserMedia&&t.userAgent.match(/AppleWebKit\/([0-9]+)\./)||t.webkitGetUserMedia&&!t.webkitRTCPeerConnection))return i.browser="Not a supported browser.",i;if(!t.userAgent.match(/Version\/(\d+).(\d+)/))return i.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",i;i.browser="safari",i.version=e(t.userAgent,/AppleWebKit\/(\d+)\./,1),i.UIVersion=t.userAgent.match(/Version\/([\d.]+)/)[1]}return i},GsRTC.prototype.isNxx=function(e,t){return 100*e<=t&&t<=100*e+99},GsRTC.prototype.generateUUID=function(){let e=(new Date).getTime();return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,(function(t){let i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?i:i&&15).toString(16)}))},GsRTC.prototype.tskStringIsNullOrEmpty=function(e){return void 0===e||null==e||""===e},GsRTC.prototype.tskStringIsString=function(e){return e instanceof String||"string"==typeof e},GsRTC.prototype.tskStringIsJSON=function(e){try{let t=JSON.parse(e);return!("object"!=typeof t||!t)}catch(e){return!1}},GsRTC.prototype.getType=function(e){let t=Object.prototype.toString,i={undefined:"undefined",number:"number",boolean:"boolean",string:"string","[object Function]":"function0f","[object RegExp]":"regexp","[object Array] ":"array","[object Date]":"date","[object Error]":"error"};return i[typeof e]||i[t.call(e)]||(e?"object":"null")},GsRTC.prototype.getObjectURL=function(e){let t=null;return void 0!==window.createObjectURL?t=window.createObjectURL(e):void 0!==window.URL?t=window.URL.createObjectURL(e):void 0!==window.webkitURL&&(t=window.webkitURL.createObjectURL(e)),t},GsRTC.prototype.objectDeepClone=function(e){if(null===e||"object"!=typeof e)return e;let t=function(e){let t=e.constructor();for(let i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t};if("object"==typeof e&&!Array.isArray(e))try{return JSON.parse(JSON.stringify(e))}catch(i){return t(e)}return t(e)},GsRTC.prototype.isObjectXExactlyEqualToY=function(e,t){let i,o,n,r;function s(e,t){let i;if(isNaN(e)&&isNaN(t)&&"number"==typeof e&&"number"==typeof t)return!0;if(e===t)return!0;if("function"==typeof e&&"function"==typeof t||e instanceof Date&&t instanceof Date||e instanceof RegExp&&t instanceof RegExp||e instanceof String&&t instanceof String||e instanceof Number&&t instanceof Number)return e.toString()===t.toString();if(!(e instanceof Object&&t instanceof Object))return!1;if(e.isPrototypeOf(t)||t.isPrototypeOf(e))return!1;if(e.constructor!==t.constructor)return!1;if(e.prototype!==t.prototype)return!1;if(n.indexOf(e)>-1||r.indexOf(t)>-1)return!1;for(i in t){if(t.hasOwnProperty(i)!==e.hasOwnProperty(i))return!1;if(typeof t[i]!=typeof e[i])return!1}for(i in e){if(t.hasOwnProperty(i)!==e.hasOwnProperty(i))return!1;if(typeof t[i]!=typeof e[i])return!1;switch(typeof e[i]){case"object":case"function":if(n.push(e),r.push(t),!s(e[i],t[i]))return!1;n.pop(),r.pop();break;default:if(e[i]!==t[i])return!1}}return!0}if(arguments.length<1)return log.warn("Need two or more arguments to compare"),!0;for(i=1,o=arguments.length;i<o;i++)if(n=[],r=[],!s(arguments[0],arguments[i]))return!1;return!0},GsRTC.prototype.isReplaceTrackSupport=function(){let e=this.getBrowserDetail(),t=!1;switch(e.browser){case"chrome":t=e.version>=72;break;case"opera":case"firefox":t=e.version>=59;break;case"safari":t=e.UIVersion>="12.1.1"}return log.info(e.browser+" "+e.version+" version support replaceTrack : "+t),t},GsRTC.prototype.isSystemAudioShareSupport=function(){let e=!1,t=this.getBrowserDetail();return("chrome"===t.browser&&navigator.userAgent.indexOf("Edg")>0&&t.version>=79||"chrome"===t.browser&&navigator.userAgent.indexOf("Edg")<0&&t.version>=74||"opera"===t.browser&&t.version>=74)&&(e=!0),e},GsRTC.prototype.isSetEncodingSupport=function(){var e=!1;let t=GsRTC.prototype.getBrowserDetail();return("chrome"===t.browser&&navigator.userAgent.indexOf("Edg")>0&&t.version>=79||"chrome"===t.browser&&navigator.userAgent.indexOf("Edg")<0&&t.version>=72||"opera"===t.browser&&t.chromeVersion>=72||"firefox"===t.browser&&t.version>=64||"safari"===t.browser&&t.version>="12.1.1")&&(log.info("encoding is support"),e=!0),e},GsRTC.prototype.getConfFromCookies=function(e){if(e&&""!==e){var t;if(document.cookie.length>0){e+="=";var i=document.cookie.indexOf(e);i>=0&&(t=document.cookie.substring(i+e.length).split(";")[0])}return t}log.warn("INVALID PARAMETER!")},GsRTC.prototype.getConfFromLocalStorage=function(e){if(e)return localStorage.getItem(e);log.info("getConfFromLocalStorage: invalid argument")},GsRTC.prototype.getMlinesDirection=function(e,t){let i=SDPTools.parseSDP(e);if(i.media.length&&i.media.length>1)for(let e=0;e<i.media.length;e++){let o=i.media[e];if(o.content&&o.content===t||o.type===t)return log.info("get "+t+" stream direction "+o.direction),o.direction}return log.warn(t+" direction is not found!"),null},GsRTC.prototype.getCallType=function(e,t){let i;return e?"VideoConference"===e?i="inactive"===t?"videoConferenceAudioCall":"videoConferenceVideoCall":"Conference"===e&&(i="audioConference"):i=t&&"inactive"!==t?"p2pVideoCall":"p2pAudioCall",log.info("get callType ("+i+")"),i},GsRTC.prototype.getRTCRtpCapabilities=function(e){let t={audioCodecs:[],videoCodecs:[]};if(RTCRtpReceiver.getCapabilities){let i=RTCRtpReceiver.getCapabilities("audio").codecs;i&&i.length&&i.forEach((function(i){if(i.mimeType){let o=i.mimeType.split("/")[1];e.includes(o)||t.audioCodecs.includes(o)||t.audioCodecs.push(o)}}));let o=RTCRtpReceiver.getCapabilities("video").codecs;o&&o.length&&o.forEach((function(i){if(i.mimeType){let o=i.mimeType.split("/")[1];e.includes(o)||t.videoCodecs.includes(o)||t.videoCodecs.push(o)}}))}else log.info("RTCRtpReceiver.getCapabilities is not support");return t},GsRTC.prototype.isDecodeCapabilitiesSupport=function(e){let t=!0,i=SDPTools.getRTCRtpCapabilities(e,this.capabilitiesCodecExcludeList);if(log.info(`get remote capabilities: ${JSON.stringify(i)}`),i){if(i.haveAudio)if(i.audioCodecs&&i.audioCodecs.length){let e=gsRTC.RTCRtpReceiverCapabilities.AUDIO_CODECS.filter((e=>i.audioCodecs.includes(e)));e&&e.length||(log.info("audio codec does not support"),t=!1)}else log.info("audio codec does not support"),t=!1;if(i.haveVideo)if(i.videoCodecs&&i.videoCodecs.length){let e=gsRTC.RTCRtpReceiverCapabilities.VIDEO_CODECS.filter((e=>i.videoCodecs.includes(e)));e&&e.length||(log.info("video codec does not support"),t=!1)}else log.info("video codec does not support"),t=!1}return t},GsRTC.prototype.setNetStats=function(e){let t=e.getLossRate(e.stats),i=e.MEDIA_SSRCS,o=e.localStreams,n=e.remoteStreams;for(let r in i){if(t["ssrc_"+i[r]]&&!t["ssrc_"+i[r]].codecName){let o=r.indexOf("SSRC")?r.replace("SSRC","CODEC"):r;t["ssrc_"+i[r]].codecName=e.MEDIA_CODECS[o]?e.MEDIA_CODECS[o].toUpperCase():e.MEDIA_CODECS[o]}switch(r){case"LOCAL_AUDIO_SSRC":e.rtpInfo.audioOut=o.audio?t["ssrc_"+i[r]]:void 0;break;case"REMOTE_AUDIO_SSRC":e.rtpInfo.audioIn=n.audio?t["ssrc_"+i[r]]:void 0;break;case"LOCAL_VIDEO_SSRC":e.rtpInfo.videoOut=o.main?t["ssrc_"+i[r]]:void 0;break;case"REMOTE_VIDEO_SSRC":if(e.callType.indexOf("Conference")>=0)break;e.rtpInfo.videoIn=n.mainVideos.main?t["ssrc_"+i[r]]:void 0;break;case"LOCAL_PRESENT_SSRC":e.rtpInfo.slideVideoOut=o.slides?t["ssrc_"+i[r]]:void 0;break;case"REMOTE_PRESENT_SSRC":e.rtpInfo.slideVideoIn=n.slides?t["ssrc_"+i[r]]:void 0;break;default:"object"!=typeof e.rtpInfo.videoIn&&(e.rtpInfo.videoIn={}),e.rtpInfo.videoIn[r]=n.mainVideos[r]?t["ssrc_"+i[r]]:void 0,e.rtpInfo.videoIn[r]||(delete e.rtpInfo.videoIn[r],delete i[r])}}},GsRTC.prototype.cleanSession=function(e){if(!e||!e.lineId)return void log.warn("clear session: Invalid parameter: "+JSON.stringify(e,null,"    "));log.info("clear session ("+e.lineId+")");let t=this,i=e.lineId;for(let o=0;o<t.webrtcSessions.length;o++){let n=t.webrtcSessions[o];if(i===n.lineId){if(Object.keys(n.localStreams).forEach((function(e){let t=n.localStreams[e];t&&n.closeStream(t)})),t.subscribeEvents&&t.subscribeEvents.length){log.info("Cancel all subscriptions");for(let i=0;i<t.subscribeEvents.length;i++){let o=t.subscribeEvents[i];n.peerAccount===o.peerAccount&&(log.info("remove Subscribe of "+o.event),e.serverHangup||t.sipStack.jsSipSendSubscribe(o.peerAccount,o.event,o.id,o.accept,0,o.headers),t.subscribeEvents.splice(i,1),i--)}}e.serverHangup||(t.onCall?(log.info("hangUp lineID ("+i+")"),t.sipStack.jsSipSendBye(i)):(log.info("cancel lineID ("+i+")"),t.sipStack.jsSipSendCancel(i))),log.info("close pc of line ("+i+")"),n.pc&&n.pc.close(),clearInterval(n.statsInterval),log.info("remote session ("+n.lineId+")"),t.webrtcSessions.splice(o,1);break}}t.webrtcSessions&&t.webrtcSessions.length||(log.info("set onCall false"),t.onCall=!1)},GsRTC.prototype.mixingStream=function(e,t){let i;log.info("mixing audio stream"),window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,window.AudioContext?i=new window.AudioContext:log.error("not support web audio api");let o=i.createMediaStreamDestination();if(e){i.createMediaStreamSource(e).connect(o)}if(t){i.createMediaStreamSource(t).connect(o)}return o.stream},GsRTC.prototype.onSipEventStack=function(e){log.info("==session event = "+e.type);let t,i=this;switch(e.type){case"register":e.rspCode&&200===e.rspCode?(log.info("register succeed"),i.trigger("onSipRegister",{codeType:i.CODE_TYPE.ACTION_SUCCESS}),i.isWsReconToRefreSubscAndReInvite&&(i.webrtcSessions.map((e=>{e.pc&&"iceRestart"===e.pc.action?(log.warn("Ws reconnected and continue to do ice restart!"),e.doIceRestart(e.pc)):e.lastReInviteSdp&&(log.info("Ws reconnected and refresh re-invite!"),i.isInviteBeingProcessed=!1,e.sendInviteQueue.push({action:"reInviteRefreshForWsReconn",sdp:null,type:e.pc.type}),gsRTC.sipStack.sendSipMessage({sdp:e.lastReInviteSdp,contentType:"application/sdp",session:e,rspCode:gsRTC.SIP_RESPONSE_CODES.OK}))})),i.subscribeEvents.map((e=>{log.info("resubscribe for ws reconnect!"),i.sipSendSubscribe(e)})),i.isWsReconToRefreSubscAndReInvite=!1)):(log.info("register failed"),i.trigger("onSipRegister",{codeType:e.rspCode}));break;case"unregister":log.warn("The register dialogs terminated"),e.rspCode&&200===e.rspCode?i.trigger("onSipUnRegister",{codeType:i.CODE_TYPE.ACTION_SUCCESS}):i.trigger("onSipUnRegister",{codeType:e.rspCode}),gsRTC.sipStack.initialized=!1;break;case"hangup":case"cancel":if(t=e.data.line,log.warn(e.type+" line id ("+t+")"),e.serverHangup){let t;e.data.sip&&(t=SipStack.prototype.parseInviteHead(e.data.sip)),t&&t.reason?i.trigger("onCallEnd",{reason:t.reason,codeType:i.CODE_TYPE.ACTION_SUCCESS}):i.trigger("onCallEnd",{codeType:i.CODE_TYPE.ACTION_SUCCESS})}i.sipHangUp({lineId:t}),log.info(e.type+" close webSocket"),i.socket?.ws.close(),i.socket=null}};let WebSocketInstance=function(e,t,i=null){if(log.info("create new webSocket."),this.wsReconnectTimeoutEvent=null,this.wsReconnectTime=2,this.wsKeepAliveInterval=null,this.wasWebsocketClosed=!1,this.keepAliveWithoutResponse=0,GsRTC.prototype.tskStringIsNullOrEmpty(e))throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+e+"' is not valid as webSocket url value");if(GsRTC.prototype.tskStringIsNullOrEmpty(t))throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+t+"' is not valid as protocol value");if(!(this instanceof WebSocketInstance))return new WebSocketInstance(e,t);this.isChannelOpen=!1,this.ws=this.createWebSocket(e,t,i)};WebSocketInstance.prototype.createWebSocket=function(e,t,i=null){if(log.info("create webSocket"),GsRTC.prototype.tskStringIsNullOrEmpty(e))throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+e+"' is not valid as webSocket url value");let o=this;log.info("Connecting to "+e),log.info("protocols "+t);let n=new window.WebSocket(e,t);return n.onopen=function(e){log.info("websocket onopen"),o.keepAliveWithoutResponse=0,i&&i(gsRTC.conf,gsRTC.EVENTS.onSipRegister&&gsRTC.EVENTS.onSipRegister[0]?gsRTC.EVENTS.onSipRegister[0]:null),o.wasWebsocketClosed&&(gsRTC.isWsReconToRefreSubscAndReInvite=!0,gsRTC.trigger("onWebsocketReconnectStatus",{codeType:gsRTC.CODE_TYPE.ACTION_SUCCESS}),clearTimeout(o.wsReconnectTimeoutEvent),o.wsReconnectTime=2,o.wsReconnectTimeoutEvent=null,o.wasWebsocketClosed=!1),o.isChannelOpen=!0,n.keepAlive("ucm")},n.onmessage=function(e){"string"==typeof e.data&&("pong"===e.data||"ping"===e.data||"\r\n"===e.data||"\r\n\r\n"===e.data?"pong"===e.data&&(o.keepAliveWithoutResponse=0):(log.info("Recv:  \r\n"+e.data),GsRTC.prototype.tskStringIsJSON(e.data)?gsRTC.trigger("onRecvJsonNotify",{data:e.data}):gsRTC.sipStack.jsSipParser(e.data)))},n.onclose=function(e){if(log.info("websocket onclose"),o.isChannelOpen=!1,o.wasWebsocketClosed=!0,gsRTC.sipStack.reRegisterTimeoutEvent&&clearTimeout(gsRTC.sipStack.reRegisterTimeoutEvent),gsRTC.sipStack.reSubscribeTimeoutEvent&&clearTimeout(gsRTC.sipStack.reSubscribeTimeoutEvent),o.wsKeepAliveInterval&&clearInterval(o.wsKeepAliveInterval),1e3===Number(e.code)&&o.keepAliveWithoutResponse<5)log.info("websocket closed!");else{if(gsRTC.trigger("onWebsocketReconnectStatus",{codeType:gsRTC.CODE_TYPE.WEBSOCKET_CLOSE}),o.wsReconnectTime>32)return log.error("ws reconnect failed"),void gsRTC.trigger("onWebsocketReconnectStatus",{codeType:gsRTC.CODE_TYPE.WEBSOCKET_RECONNECTION_FAILED});o.wsReconnectTimeoutEvent=setTimeout((function(){gsRTC.trigger("onWebsocketReconnectStatus",{codeType:gsRTC.CODE_TYPE.WEBSOCKET_CONNECTING}),o.wsReconnect(),o.wsReconnectTime=2*o.wsReconnectTime}),1e3*o.wsReconnectTime)}},n.onerror=function(e){log.info("websocket onerror")},n.keepAlive=function(e){o.isChannelOpen?"ucm"===e&&(o.wsKeepAliveInterval=setInterval((function(){if(o.keepAliveWithoutResponse>=5)return void n.close();n.send("ping"),o.keepAliveWithoutResponse+=1}),5e3)):log.error("websocket is closed , stop keepAlive!")},window.onmessage=function(e){o.onWebWorkerMessage(e)},n},window.onmessage=function(e){e.data&&"jsSipStackInit"===e.data.cmd&&(window.sipWasmInitialized=!0)},WebSocketInstance.prototype.wsReconnect=function(){log.warn("wsReconnect!"),this.ws=this.createWebSocket(gsRTC.conf.websocketUrl,gsRTC.conf.protocol)},WebSocketInstance.prototype.onWebWorkerMessage=function(e){let t=e.data,i=this;if("\r\n"===e.data||"pong"===e.data)log.info("receive websocket keep alive!!!");else switch(t.cmd){case"functionReturn":"jsSipStart"===t.funcName&&(gsRTC.sipStack&&gsRTC.sipStack.initialized?(log.info("SipStack is init!"),gsRTC.click2Talk?(log.warn("Registration call!!!"),gsRTC.trigger("onSipCallInit",{codeType:gsRTC.CODE_TYPE.ACTION_SUCCESS})):(log.info("ready to send register!"),gsRTC.sipStack.jsSipSendRegister(gsRTC.sipStack.REGISTER_EXPIRES))):log.warn("sipStack is not initialized"));break;case"sendMessage":log.info("Send: \r\n"+e.data.msg),i.ws&&1===i.ws.readyState?i.ws.send(e.data.msg):log.warn("The connection is not open and ready to communicate in state "+i.ws.readyState);break;case"recvSipMessage":log.info("onWebWorkerMessage handle recv sip message"),e.data&&e.data.sip&&e.data.sip.type&&("response"===e.data.sip.type?i.handleServerResponse(e):"request"===e.data.sip.type&&i.handleServerRequest(e));break;case"recvTextMessage":log.info("recvTextMessage: "+JSON.stringify(e.data,null,"    "))}},WebSocketInstance.prototype.handleServerResponse=function(e){if(!e||!e.data)return void log.error("server response： Invalid parameter");let t,i=e.data.line;log.info("handle incoming message of lineId "+i);let o=e.data&&e.data.sip;log.info("receive server response: "+o.cseq.method+" , code "+o.status);let n=o.status;switch(o.cseq.method){case"REGISTER":if(log.info("receive REGISTER secMethod: "+e.data.secMethod),e.data&&"UNREGISTER"===e.data.secMethod)log.info("unregister, stop sipStack"),gsRTC&&(gsRTC.sipStack&&gsRTC.sipStack.jsSipStop(),gsRTC.onSipEventStack({type:"unregister",rspCode:n}),gsRTC.socket&&gsRTC.socket.ws&&gsRTC.socket.ws.close(),gsRTC.socket=null);else if(200===n){gsRTC.onSipEventStack({type:"register",rspCode:n});let e=SipStack.prototype.getSipHeader(o,"expires");e&&e!==gsRTC.sipStack.REGISTER_EXPIRES&&(log.info("update re-register expires to "+e),gsRTC.sipStack.setRegisterRefresh(e))}else if(423===n){log.warn("The register interval Too Brief...");let e=SipStack.prototype.getSipHeader(o,"min-expires")||SipStack.prototype.getSipHeader(o,"expires");e?gsRTC.sipStack.jsSipSendRegister(e):(log.warn("get (Min-)Expires "+e),gsRTC.onSipEventStack({type:"register",rspCode:n}))}else log.warn("get REGISTER other code "+n);break;case"SUBSCRIBE":let r=SipStack.prototype.getSipHeader(o,"expires"),s=SipStack.prototype.getSipHeader(o,"event");if(200===n)gsRTC.trigger("onSipSendSubscribe",{codeType:gsRTC.CODE_TYPE.ACTION_SUCCESS}),r&&gsRTC.sipStack.refreshSubscribWithExpires(r,s,!0);else if(423===n)log.warn("The subscribe interval Too Brief..."),r=SipStack.prototype.getSipHeader(o,"min-expires")||r,r&&!gsRTC.sipStack.refreshSubscribWithExpires(r,s)&&(log.warn("get (Min-)Expires "+r),gsRTC.trigger("onSipSendSubscribe",{codeType:n}));else if(481===n){let e;gsRTC.subscribeEvents.map(((t,o)=>{t.id===i&&(e=deepCopy(t),gsRTC.subscribeEvents.splice(o,1))})),e&&gsRTC.sipSendSubscribe(e)}else log.warn("get SUBSCRIBE other code "+n),gsRTC.trigger("onSipSendSubscribe",{codeType:n});break;case"INVITE":if(t=WebRTCSession.prototype.getSession({key:"lineId",value:i}),180===n)log.info("on remote ring"),gsRTC.trigger("onCallRemoteRinging",{codeType:n});else if(t){if(183===n)t.isExist183Process=!0,o.bodies&&o.bodies[0]&&o.bodies[0].body?t.handleServerResponseSdp(o.bodies[0].body):log.warn("No body provided to processing");else if(GsRTC.prototype.isNxx(2,n)){if(gsRTC.sipStack.jsSipSendAck(i),gsRTC.onCall=!0,!t.channelID){let e=SipStack.prototype.parseInviteHead(o);t.channelID=e&&e.channelID,log.info("save sip channelID: "+t.channelID)}if(t.isGDS=SipStack.prototype.isGDS(o),!0===t.isExist183Process?t.updateRemoteSdp(o.bodies[0].body):o.bodies&&o.bodies[0]&&o.bodies[0].body?t.handleServerResponseSdp(o.bodies[0].body):log.warn("No body provided to processing"),"true"===localStorage.getItem("enableTrickleIce"))if(t.readyToSendCandidate=!0,"completed"===t.pc.iceGatheringState||"complete"===t.pc.iceGatheringState)t.handleTrickleIce({candidate:null,mid:null}),t.readyToSendCandidate=!1;else if(!t.lastSendCandiContent){let e=t.trickleCandidate[0].candidates,i=e[e.length-1].replace(/a=/,"").replace("\r\n","");t.handleTrickleIce({candidate:i,mid:t.trickleCandidate[0].sdpMid})}}else 491===n?t.handle491Response():(log.warn("get other code "+n+", reason: "+o.reason),t&&t.actionCallback&&t.action&&(log.info("Call callback"),t.actionCallback({codeType:n})));t.isInviteBeingProcessed&&(t.isInviteBeingProcessed=!1)}else log.warn("session is empty");break;case"INFO":break;case"BYE":log.info("Hang up the call actively, close session: "+i),gsRTC.onSipEventStack({type:"hangup",rspCode:n,data:e.data});break;case"CANCEL":log.info("receive cancel response，cancel session: "+i),gsRTC.onSipEventStack({type:"cancel",rspCode:n,data:e.data});break;default:log.warn("Other method: "+o.cseq.method)}},WebSocketInstance.prototype.handleServerRequest=function(e){if(!e||!e.data)return void log.error("server request： Invalid parameter");let t,i,o=e.data.line,n=e.data.sip;log.info(n.method+" message of line ("+o+")");let r=n.method||n.cseq.method;switch(r){case"INVITE":if(t=n.bodies[0].body,o<0)if(!gsRTC.onCall&&gsRTC.webrtcSessions.length&&gsRTC.webrtcSessions[gsRTC.webrtcSessions.length-1].isInviteBeingProcessed)log.warn("The user is now establishing a call..."),gsRTC.sipStack.jsSipSendRsp(e.data.transaction,gsRTC.SIP_RESPONSE_CODES.BUSY_HERE),gsRTC.trigger("onIncomingCallAutoReject",{codeType:gsRTC.SIP_RESPONSE_CODES.BUSY_HERE});else if(!0===gsRTC.onCall)log.warn("The user is busy"),gsRTC.sipStack.jsSipSendRsp(e.data.transaction,gsRTC.SIP_RESPONSE_CODES.BUSY_HERE),gsRTC.trigger("onIncomingCallAutoReject",{codeType:gsRTC.SIP_RESPONSE_CODES.BUSY_HERE});else if(gsRTC.isDecodeCapabilitiesSupport(t)){let i=SipStack.prototype.parseInviteHead(n),o=SipStack.prototype.isGDS(n),r=GsRTC.prototype.getMlinesDirection(t,"main");i.callType=GsRTC.prototype.getCallType(i.sipCallType,r);let s=SDPTools.parseSDP(t);i&&(!i.sipCallType||i.sipCallType&&"Conference"!==i.sipCallType)&&s.media&&s.media.length<3?(log.warn("Media lines does not meet the requirements, call hang up automatically.."),gsRTC.sipStack.jsSipSendRsp(e.data.transaction,gsRTC.SIP_RESPONSE_CODES.NOT_ACCEPTABLE_HERE),gsRTC.trigger("onIncomingCallAutoReject",{callNum:i.from,type:i.callType,channelID:i.channelID,displayName:i.displayName,isGDS:o})):gsRTC.handleIncomingCall({sdp:t,sipHeaders:i,transaction:e.data.transaction,isGDS:o})}else log.warn("Does not support remote decoding capabilities"),gsRTC.sipStack.jsSipSendRsp(e.data.transaction,gsRTC.SIP_RESPONSE_CODES.NOT_ACCEPTABLE_HERE),gsRTC.trigger("onIncomingCallAutoReject",{codeType:gsRTC.SIP_RESPONSE_CODES.NOT_ACCEPTABLE_HERE});else{if(i=WebRTCSession.prototype.getSession({key:"lineId",value:o}),!i)return void log.error("no session found of line "+o);i.transaction=e.data.transaction,i.isRecvRequest=!0,"inactive"!==GsRTC.prototype.getMlinesDirection(t,"main")?(i.isRequestOpenLocalVideo=!0,i.isLocalVideoOn?(log.info("The camera is already sharing"),i.handleServerRequestSdp(t)):(log.info("request to turn on the camera"),gsRTC.trigger("onRequestedOpenCamera",{callback:function(e){log.info("onRequestedOpenCamera: "+JSON.stringify(e,null,"   ")),i.isRequestOpenLocalVideo=e.isAccept,i.handleServerRequestSdp(t)}}))):(i.isRequestOpenLocalVideo=!1,i.handleServerRequestSdp(t))}break;case"NOTIFY":if(log.info("receive notify id ("+o+")"),o<0)return void log.warn("Receive notification outside the session ("+o+")");let s=n.bodies[0].body;if(n.contentType&&n.contentType.subtype&&s){let t=n.contentType.subtype;log.info("sip NOTIFY contentType subtype: "+t),"participant-sdp"===t?(i=WebRTCSession.prototype.getSession({key:"lineId",value:o}),i&&(i.participantsSdpQueue.push({sdp:s,contentType:n.contentType,transaction:e.data.transaction,cseq:n.cseq}),i.handleParticipantsSdp())):gsRTC.trigger("onRecvNotify",{xml:s})}break;case"ACK":log.info("handle offer success ("+o+")"),i=WebRTCSession.prototype.getSession({key:"lineId",value:o}),"true"===localStorage.getItem("enableTrickleIce")&&i&&i.pc&&!0===i.isAnswerForSendCandi&&(i.readyToSendCandidate=!0,"completed"!==i.pc.iceGatheringState&&"complete"!==i.pc.iceGatheringState||(i.handleTrickleIce({candidate:null,mid:null}),i.readyToSendCandidate=!1),i.isAnswerForSendCandi=!1);break;case"INFO":if(n.contentType&&n.contentType.subtype){let e=n.contentType.subtype;log.info("sip info contentType subtype: "+e),gsRTC.trigger("onRecvInfo",{data:n.bodies[0].body})}break;case"UPDATE":e.data.transaction&&gsRTC.sipStack.jsSipSendRsp(e.data.transaction,gsRTC.SIP_RESPONSE_CODES.OK);break;case"BYE":log.info("Receive Server BYE("+o+")"),gsRTC.onSipEventStack({type:"hangup",rspCode:n.status,data:e.data,serverHangup:!0});break;case"CANCEL":log.info("Receive Server CANCEL("+o+")");let a=SipStack.prototype.parseInviteHead(n);if(gsRTC&&gsRTC.webrtcSessions&&gsRTC.webrtcSessions.length){let e=WebRTCSession.prototype.getSession({key:"peerAccount",value:a.from});e&&(log.info("user has cancel the call ("+e.lineId+")"),gsRTC.trigger("onIncomingCallCanceled",{codeType:gsRTC.CODE_TYPE.INCOMING_CALL_CANCELED,peerAccount:a.from}),gsRTC.cleanSession({lineId:e.lineId}))}else log.info("No session currently exists for cancel");break;default:log.warn("request message.data.method: "+r)}};let SipStack=function(){let e=this;if(!(this instanceof SipStack))return new SipStack;log.info("Create sipStack instance"),this.debugLevel=2,this.reRegisterTimeoutEvent=null,this.reSubscribeTimeoutEvent=null,this.REGISTER_EXPIRES=1800,this.SUBSCRIBE_EXPIRES=28800,this.DOMAIN="@df7jal23ls0d.invalid",this.initialized=!1,this.jsSipParser=window.jsSipParser,this.jsSipInit=window.jsSipInit,this.jsSipSetConfig=window.jsSipSetConfig,this.jsSipStart=window.jsSipStart,this.jsSipStop=window.jsSipStop,this.jsSipSendInvite=window.jsSipSendInvite,this.jsSipSendReInvite=window.jsSipSendReInvite,this.jsSipSendRsp=window.jsSipSendRsp,this.jsSipAcceptCall=window.jsSipAcceptCall,this.jsSipSendAck=window.jsSipSendAck,this.addHeaderList=window.addHeaderList,this.jsSipSendBye=window.jsSipSendBye,this.jsSipSendCancel=window.jsSipSendCancel,this.jsSipSendUnRegister=function(){log.info("send sip unregister"),clearTimeout(e.reRegisterTimeoutEvent),window.jsSipSendUnRegister()},this.jsSipSendRegister=function(e){log.info("sip send register"),e=parseInt(e),window.jsSipSendRegister(e),this.setRegisterRefresh(e)},this.jsSipSendInfo=function(e,t=[],i=null,o=null){t.map((function(e){window.addHeaderList(e.name,e.value)})),log.info("send info line "+e),window.jsSipSendInfo(e,i,o)},this.jsSipSendSubscribe=function(t,i,o,n,r,s){log.info("send ("+i+") subscribe event to "+t),log.info("event id ("+o+")"),s&&s.map((function(e){log.info("add subscribe header "+e.name+", value "+e.value),window.addHeaderList(e.name,e.value)}));let a="sip:"+t+"@"+(gsRTC.conf&&gsRTC.conf.sipRealm?gsRTC.conf.sipRealm:e.DOMAIN);r=r||0===r?r:e.SUBSCRIBE_EXPIRES,window.jsSipSendSubscribe(a,i,o,r,n),this.setSubscribeRefresh(t,i,o,n,r,s)}};SipStack.prototype.setRegisterRefresh=function(e){log.info("set register refresh timer");let t=this;if(!e)return void log.warn("unexpected refresh expires "+e);clearTimeout(t.reRegisterTimeoutEvent),t.REGISTER_EXPIRES=e;let i=t.REGISTER_EXPIRES/2*1e3;t.reRegisterTimeoutEvent=setTimeout((function(){log.info("send sip re-registration "+t.REGISTER_EXPIRES),t.jsSipSendRegister(t.REGISTER_EXPIRES)}),i)},SipStack.prototype.setSubscribeRefresh=function(e,t,i,o,n,r){log.info("set subscribe refresh timer");let s=this;if(clearTimeout(s.reSubscribeTimeoutEvent),0!==n){s.SUBSCRIBE_EXPIRES=parseInt(n);let a=Number(s.SUBSCRIBE_EXPIRES)/2*1e3;s.reSubscribeTimeoutEvent=setTimeout((function(){log.info("send re-subscribe "+s.SUBSCRIBE_EXPIRES),s.jsSipSendSubscribe(e,t,i,o,n,r)}),a)}},SipStack.prototype.refreshSubscribWithExpires=function(e,t,i){if(e&&gsRTC.subscribeEvents&&gsRTC.subscribeEvents.length){let o;return o=t?gsRTC.subscribeEvents.find((e=>e.event===t)):gsRTC.subscribeEvents[gsRTC.subscribeEvents.length-1],parseInt(o.expires)!==parseInt(e)&&(o.expires=e,i?(log.info("update subscribe timer "+e),gsRTC.sipStack.setSubscribeRefresh(o.peerAccount,o.event,o.id,o.accept,o.expires,o.headers)):(log.info("re-subscribe width "+e),gsRTC.sipSendSubscribe(o))),!0}return!1},SipStack.prototype.init=function(e,t){if(log.info("start sip init!"),!Object.keys(e).length)throw new Error("ERR_INVALID_PARAMETER_VALUE: null configuration value");if(GsRTC.prototype.tskStringIsNullOrEmpty(e.sipImpi))throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+e.sipImpi+"' is not valid as impi value");if(GsRTC.prototype.tskStringIsString(e.sipImpi)||(log.info(typeof e.sipImpi+" not a valid type for sipImpi. Convert to string"),e.sipImpi=e.sipImpi.toString()),GsRTC.prototype.tskStringIsNullOrEmpty(e.sipDisplayName)?log.info("sipDisplayName is set of: "+e.sipDisplayName):GsRTC.prototype.tskStringIsString(e.sipDisplayName)||(log.info(typeof e.sipDisplayName+" not a valid type for sipDisplayName. Convert to string"),e.sipDisplayName=e.sipDisplayName.toString()),GsRTC.prototype.tskStringIsNullOrEmpty(e.sipPasswd))throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+e.sipPasswd+"'  is not valid as password value");if(GsRTC.prototype.tskStringIsString(e.sipPasswd)||(log.warn(typeof e.sipPasswd+" not a valid type for sipPasswd. Convert to string"),e.sipPasswd=e.sipPasswd.toString()),log.info("pwd length "+e.sipPasswd.length),GsRTC.prototype.tskStringIsNullOrEmpty(e.sipRealm))throw new Error("ERR_INVALID_PARAMETER_VALUE: '"+e.sipRealm+"' is not valid as realm value");if(GsRTC.prototype.tskStringIsNullOrEmpty(e.userAgent))throw new Error("ERR_INVALID_PARAMETER_VALUE: "+typeof e.userAgent+" is not valid as userAgent value");GsRTC.prototype.tskStringIsNullOrEmpty(e.organization)&&(e.organization="Grandstream",log.info(e.organization+" not a valid value for organization. set default value of "+e.organization)),GsRTC.prototype.tskStringIsNullOrEmpty(e.host)&&(e.host="df7jal23ls0d.invalid",log.info(e.host+" not a valid value for host. set default value of "+e.host));try{if(!this.initialized){log.info("SipStack jsSipInit");let e=parseInt(localStorage.getItem("sipStackDebugLevel")||this.debugLevel);log.info("stack debug level: "+e),this.jsSipInit(e)}let t={websocket:1,username:e.sipImpi,password:e.sipPasswd,proxyURL:e.sipRealm,host:e.host,userAgent:e.userAgent,displayName:e.sipDisplayName,organization:e.organization,autoAnswer:{INVITE:{101:!1,180:!0},NOTIFY:{noAnswer:[{"Content-Type":{type:"application",subtype:"participant-sdp"}}]}}},i=GsRTC.prototype.objectDeepClone(t);delete i.password,log.info("sip start init config: \n"+JSON.stringify(i,null,"    ")),this.jsSipStart(t),this.initialized=!0}catch(e){throw t(e),new Error(e)}},SipStack.prototype.sendSipMessage=function(e){let t=this;if(!t.initialized)throw new Error("SIP Stack not initialized yet. Please init first");if(!e||!e.session)throw new Error("session is not found");let i=e.session;if(i.isRecvRequest)i.isIncomingCall?(log.info("Accept Call of ("+i.lineId+")"),t.jsSipAcceptCall(i.transaction,i.lineId,200,e.contentType,e.sdp),i.isIncomingCall=!1,i.isCallInitiator=!1,gsRTC.onCall=!0,i.isRecvRequest=!1,i.isSendReInvite=!0):i.isGDSCall&&"preview"===i.isGDSCall?(log.info("Send early media"),t.jsSipAcceptCall(i.transaction,i.lineId,183,e.contentType,e.sdp)):(e.contentType&&e.sdp&&e.rspCode?(log.info("send 200 ok ("+i.lineId+")"),t.jsSipSendRsp(i.transaction,e.rspCode,e.contentType,e.sdp)):(log.info("send non-2xx("+i.lineId+")"),t.jsSipSendRsp(i.transaction,e.rspCode)),i.isRecvRequest=!1,i.isSendReInvite=!0);else{if(i.isSendReInvite)log.warn("send sip re-invite("+i.lineId+")"),t.jsSipSendReInvite(i.lineId,e.contentType,e.sdp);else{log.warn("send sip init invite ("+i.lineId+")");let o="sip:"+i.peerAccount+"@"+(gsRTC.conf&&gsRTC.conf.sipRealm?gsRTC.conf.sipRealm:t.DOMAIN);t.jsSipSendInvite(o,i.lineId,e.contentType,e.sdp),i.isSendReInvite=!0}i.isInviteBeingProcessed=!0}},SipStack.prototype.parseInviteHead=function(e){let t={};if("object"==typeof e&&(t.from=e.from.url.username,t.displayName=e.from.displayname||e.from.url.username,t.to=e.to.displayname||e.to.url.username),e.headers&&e.headers.length)for(let i=0;i<e.headers.length;i++){let o=e.headers[i];"x-grandstream-call-type"===o.hname?(t.sipCallType=o.hvalue,log.info("get x-grandstream-call-type: "+t.sipCallType)):"channel-id"===o.hname?(t.channelID=o.hvalue,log.info("get channelID: "+t.channelID)):t[o.hname]=o.hvalue}return t.isConference=!!(e.contacts&&e.contacts.length&&e.contacts[0].params&&e.contacts[0].params.hasOwnProperty("isfocus")),Object.keys(t).forEach((function(e){t[e]&&"string"==typeof t[e]&&(t[e]=t[e].replace(/\"/g,""))})),t},SipStack.prototype.isGDS=function(e){let t=!1;if(e.callInfos&&e.callInfos.length)for(let i=0;i<e.callInfos.length;i++)e.callInfos[i].params&&e.callInfos[i].params.purpose&&"GDS-view"===e.callInfos[i].params.purpose&&(log.warn("now is GDS"),t=!0);return t},SipStack.prototype.getSipHeader=function(e,t){if(!e||!e.headers||!e.headers.length)return;let i;for(let o=0;o<e.headers.length;o++){let n=e.headers[o];if(n&&n.hname&&n.hname===t){log.info("get "+t+", value "+n.hvalue),n.hvalue&&(i=parseInt(n.hvalue));break}}return i};let WebRTCSession=function(e){this.callType="",this.lineId=e,this.bundlePolicy="max-bundle",this.isIncomingCall=!1,this.isCallInitiator=!0,this.channelID=null,this.isGDS=!1,this.isGDSCall=!1,this.peerAccount="",this.action="",this.transaction="",this.readyToSendCandidate=!1,this.isAnswerForSendCandi=!1,this.trickleCandidate=[],this.lastSendCandiContent="",this.sendInviteQueue=[],this.recvInviteQueue=[],this.participantsSdpQueue=[],this.latestParticipantsSdp="",this.remotePendingSdp="",this.isRecvRequest=!1,this.isSendReInvite=!1,this.isInviteBeingProcessed=!1,this.lastReInviteSdp="",this.isRequestOpenLocalVideo=!1,this.isLocalVideoOn=!1,this.errorCode=null,this.actionCallback=null,this.videoUpResolution=null,this.onRemoteHoldChange=null,this.isExist183Process=!1,this.EVENTS=[],this.conf="",this.deviceId=null,this.pc=null,this.iceCollecting=!1,this.stats={},this.statsInterval="",this.localH264Payload={RTP:"",RTX:""},this.attr={setCodec:null,roCodec:null,roVideoResolution:null,roVideoFramerate:null},this.RESOLUTION={VIDEO_DEFAULT:{width:640,height:360},VIDEO_CURRENT_UP:null,VIDEO_EXPECT_RECV:null,SLIDES_CURRENT_UP:null},this.mids={audio:"",main:"",slides:""},this.localStreams={audio:null,main:null,slides:null},this.remoteStreams={audio:null,slides:null,mainVideos:{}},this.MEDIA_SSRCS={LOCAL_AUDIO_SSRC:null,REMOTE_AUDIO_SSRC:null,LOCAL_VIDEO_SSRC:null,REMOTE_VIDEO_SSRC:null,LOCAL_PRESENT_SSRC:null,REMOTE_PRESENT_SSRC:null},this.MEDIA_CODECS={LOCAL_AUDIO_CODEC:null,REMOTE_AUDIO_CODEC:null,LOCAL_VIDEO_CODEC:null,REMOTE_VIDEO_CODEC:null,LOCAL_PRESENT_CODEC:null,REMOTE_PRESENT_CODEC:null},this.rtpInfo={audioIn:void 0,audioOut:void 0,videoIn:void 0,videoOut:void 0,slideVideoIn:void 0,slideVideoOut:void 0}};WebRTCSession.prototype.createMediaLine=async function(e,t){log.info("createMediaLine type offer: "+t);let i,o=this;switch(o.getStream("audio",!0)||await o.getUserMediaStream({type:"audio",callback:async e=>{e.stream?(i=e.stream,log.info("add audio stream to WebRTCSession: "+i.id),await o.pc.addStream(i),o.setStream(i,"audio",!0)):(log.warn("get audio stream failed! "+e.error),t?(o.actionCallback({codeType:WebRTCSession.prototype.getGumErrorCode("audio",e.error.name)}),await o.pc.addTransceiver("audio")):gsRTC.trigger("OnError",{codeType:gsRTC.CODE_TYPE.FAILED_TO_UNMUTE_MIC}))}}),e){case"audioConference":break;case"p2pAudioCall":case"videoConferenceAudioCall":if(t)if("firefox"===gsRTC.getBrowserDetail().browser){let e=await WebRTCSession.prototype.getCaptureStreams(),t=await WebRTCSession.prototype.getCaptureStreams();await o.pc.addStream(e),await o.pc.addStream(t)}else await o.pc.addTransceiver("video"),await o.pc.addTransceiver("video");else{let e=await WebRTCSession.prototype.getCaptureStreams(),t=await WebRTCSession.prototype.getCaptureStreams();"firefox"===gsRTC.getBrowserDetail().browser?(await o.pc.addStream(e),await o.pc.addStream(t)):(await o.processAddStream(e,o.pc,"main"),await o.processAddStream(t,o.pc,"slides"))}break;case"p2pVideoCall":case"videoConferenceVideoCall":let i=await WebRTCSession.prototype.getCaptureStreams(),n=await WebRTCSession.prototype.getCaptureStreams();await o.getUserMediaStream({type:"video",callback:async e=>{e.stream?(n=e.stream,log.info("add video stream to WebRTCSession: "+n.id),o.setStream(n,"main",!0)):(log.warn("get video stream failed! "+e.error),t?o.actionCallback({codeType:WebRTCSession.prototype.getGumErrorCode("video",e.error.name)}):gsRTC.trigger("OnError",{codeType:gsRTC.CODE_TYPE.FAILED_TO_OPEN_LOCAL_VIDEO})),t?(await o.pc.addStream(n),"firefox"===gsRTC.getBrowserDetail().browser?await o.pc.addStream(i):await o.pc.addTransceiver("video")):"firefox"===gsRTC.getBrowserDetail().browser?(await o.pc.addStream(n),await o.pc.addStream(i)):(await o.processAddStream(n,o.pc,"main"),await o.processAddStream(i,o.pc,"slides"))}});break;default:log.warn("Unknown type: "+e),gsRTC.trigger("OnError",{codeType:gsRTC.CODE_TYPE.PARAMETER_ERROR})}},WebRTCSession.prototype.subscribeStreamEvents=function(e){let t=this;e.ontrack=function(e){let i=e.streams?e.streams[0]:null;if(!i&&e.track)log.info("`stream` is undefined on `ontrack` event in WebRTC, get track id: "+e.track.id);else{let o=i&&i.id;log.info("__on_add_track: "+o);let n="";e.transceiver&&e.transceiver.mid&&Object.keys(t.mids).forEach((function(i){t.mids[i].toString()===e.transceiver.mid.toString()&&(log.info("get "+i+" stream"),n=i)})),n||(n=o.split("_")[0],log.warn("ontrack get mediaType ("+n+")")),log.info("get ontrack msid: "+o),t.setStream(i,n,!1,o),i&&(i.onremovetrack=function(e){log.info("__on_remove_track msid: "+o),t.setStream(null,n,!1,o)})}}},WebRTCSession.prototype.createRTCSession=async function(e,t){log.info("create webRTC multiStream Peer connection");let i=this;i.pc=i.createPeerConnection(e,t);try{if(await i.createMediaLine(t,!0),t.indexOf("VideoCall")>=0&&!i.localStreams.main)return void log.warn("videoCall cancel!");await i.doOffer(i.pc,e.type)}catch(e){log.error(e)}},WebRTCSession.prototype.createPeerConnection=function(e,t){let i,o=this,n=e.iceServers;o.conf=o.conf||e;let r=this.conf&&this.conf.RTCpeerConnectionOptional;null==r?r={optional:[{pcName:"PC_"+Math.random().toString(36).substr(2)},{googDscp:!0},{googIPv6:!0}]}:r&&r.optional&&r.optional.length>0&&r.optional.push({pcName:"PC_"+Math.random().toString(36).substr(2)},{googDscp:!0},{googIPv6:!0});let s={bundlePolicy:"max-bundle"};return e.iceTransportPolicy?s.iceTransportPolicy=e.iceTransportPolicy:s.iceTransportPolicy="all",null==n||0===n.length?log.info("iceServers is null"):s.iceServers=e.iceServers,"firefox"!==window.gsRTC.getBrowserDetail().browser&&(s.sdpSemantics="unified-plan"),o.peerAccount=e&&e.peerAccount,i=new window.RTCPeerConnection(s,r),i.type=t,i.pcName="PC_"+Math.random().toString(36).substr(2),i.peerId=Math.random().toString(36).substr(2),i.action=null,i.iceFailureNum=0,i.isIceFailed=!1,i.isLocalSdpPending=!0,o.subscribeStreamEvents(i),i.onicecandidate=function(e){o.onIceCandidate(i,e)},i.onsignalingstatechange=function(){o.onSignalingStateChange(i)},i.onicegatheringstatechange=function(){o.onIceGatheringStateChange(i)},i.oniceconnectionstatechange=function(){o.onIceConnectionStateChange(i)},i.onconnectionstatechange=function(e){o.onConnectionStateChange(i,e)},i},WebRTCSession.prototype.doOffer=async function(e,t){let i=this;if(e.isLocalSdpPending=!0,log.info("create sdp( PC: "+e.type+" )"),e){log.info("Creating offer"),e.offerConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:"audioConference"!==t};try{log.info(e.type+" createOffer start"),log.log("createOffer offerConstraints "+JSON.stringify(e.offerConstraints,null,"   ")),"iceRestart"===e.action&&(e.offerConstraints.iceRestart=!0);let t=await e.createOffer(e.offerConstraints);await async function(t){log.info("start setLocalDescription");try{if("stable"!==e.signalingState)return void(e.isIceFailed&&"iceRestart"===e.action&&"have-local-offer"===e.signalingState?(log.warn("doOffer: pc in signalingState have-local-offer, run JSEPStatusRollback for iceRestart!"),i.JSEPStatusRollback(),i.doIceRestart(e),e.iceFailureNum--):(log.warn("doOffer: Called in wrong state "+e.signalingState),!i.isRecvRequest&&i.sendInviteQueue.length&&(i.action=i.sendInviteQueue[0].action,i.actionCallback=i.sendInviteQueue[0].callback,log.info("Restore action and callback: "+i.action))));t.sdp=i.setSessionLevelMediaLine(t.sdp),log.info(`Offer setLocalDescription sdp:  \n${t.sdp}`),await e.setLocalDescription(t),i.setLocalDescriptionSuccess(e)}catch(e){i.onSetLocalDescriptionError(e)}}(t)}catch(e){i.onCreateLocalDescriptionError(e)}}else log.info("RTCSessionDescription offer, Dropping of creating of offer as connection does not exists")},WebRTCSession.prototype.doAnswer=async function(e){let t=this;if(e.isLocalSdpPending=!0,log.info("prepare do answer"),!e||e&&"closed"===e.signalingState)log.info("doAnswer: RTCPeerConnection is not available");else{if(t.isRequestOpenLocalVideo||t.isGDSCall)log.info("prepare add video stream"),t.isIncomingCall?(log.info("incomingCall do answer"),await t.createMediaLine(t.callType,!1)):await t.getUserMediaStream({type:"video",callback:e=>{if(e.stream){let i=e.stream;log.info("add main stream to pc: "+i.id),t.processAddStream(i,t.pc,"main"),t.setStream(i,"main",!0)}else log.warn("get video stream failed! "+e.error),gsRTC.trigger("OnError",{codeType:gsRTC.CODE_TYPE.FAILED_TO_OPEN_LOCAL_VIDEO})}});else if(!t.getStream("audio",!0)&&(await t.getUserMediaStream({type:"audio",callback:e=>{if(e.stream){let i=e.stream;log.info("add audio stream to session: "+i.id),t.processAddStream(i,t.pc,"audio"),t.setStream(i,"audio",!0)}else log.warn("get audio stream failed! "+e.error),gsRTC.trigger("OnError",{codeType:gsRTC.CODE_TYPE.FAILED_TO_UNMUTE_MIC})}}),t.isIncomingCall&&"audioConference"!==t.callType)){log.info("incomingCall add video and slides fake stream");let e=await WebRTCSession.prototype.getCaptureStreams(),i=await WebRTCSession.prototype.getCaptureStreams();"firefox"===gsRTC.getBrowserDetail().browser?(await t.pc.addStream(e),await t.pc.addStream(i)):(t.processAddStream(e,t.pc,"main"),t.processAddStream(i,t.pc,"slides"))}log.info("createAnswer start");try{const i=await e.createAnswer();await async function(i){log.info(e.type+" createAnswerSuccess, setLocalDescription start");try{if("have-remote-offer"!==e.signalingState)return void log.warn("doAnswer: Called in wrong state "+e.signalingState);i.sdp=t.setSessionLevelMediaLine(i.sdp),log.info(`answer setLocalDescription sdp: \n${i.sdp}`),await e.setLocalDescription(i),t.setLocalDescriptionSuccess(e)}catch(e){t.onSetLocalDescriptionError(e)}}(i)}catch(e){t.onCreateLocalDescriptionError(e)}}},WebRTCSession.prototype.setRemoteDescriptionSuccess=function(e){let t=this;log.info("setRemoteDescription success ("+t.action+")"),!1===gsRTC.onCall&&!1===t.isGDSCall&&!1===t.isIncomingCall?log.info("the user is busy..."):(t.action||t.actionCallback||t.sendInviteQueue.length&&(t.action=t.sendInviteQueue[0].action,t.actionCallback=t.sendInviteQueue[0].callback),t.action&&t.actionCallback?t.actionCallback({codeType:gsRTC.CODE_TYPE.ACTION_SUCCESS}):t.sendInviteQueue.length&&(log.info("Automatically clear invite action"),t.removeInviteAction({action:t.sendInviteQueue[0].action}))),e.action&&"iceRestart"===e.action&&e.actionCallback&&e.actionCallback({codeType:gsRTC.CODE_TYPE.ACTION_SUCCESS}),log.info("set remote success with participantsSdpQueue length ("+t.participantsSdpQueue.length+")"),log.info("set remote success with sendInviteQueue length ("+t.sendInviteQueue.length+")"),t.participantsSdpQueue.length&&!t.sendInviteQueue.length&&(log.info("prepare hanlde participants sdp!!"),t.handleParticipantsSdp()),t.saveNetStatsUseParam(SDPTools.parseSDP(e.remoteDescription.sdp),!1)},WebRTCSession.prototype.setLocalDescriptionSuccess=function(e){log.info("setLocalDescription success ( "+e.type+")"),this.setEncodingParameters("main"),"complete"!==e.iceGatheringState&&"true"!==localStorage.getItem("enableTrickleIce")||(e.isLocalSdpPending=!1,log.info("onSetLocalDescriptionSuccess send invite( PC: "+e.type+" )"),this.onIceGatheringCompleted())},WebRTCSession.prototype.onSetLocalDescriptionError=function(e){log.warn(`Failed to set local description: ${e}`)},WebRTCSession.prototype.onCreateLocalDescriptionError=function(e){log.warn(`Failed to create session description: ${e}`)},WebRTCSession.prototype.onSetRemoteDescriptionError=function(e){log.warn(`Failed to set remote description: ${e}`)},WebRTCSession.prototype.JSEPStatusRollback=async function(){log.info("JSEP status Rollback");let e=this;if("have-local-offer"===e.pc.signalingState){log.info(e.pc.type+" WebRTCSession signalingState: "+e.pc.signalingState);try{let t=e.pc.currentRemoteDescription,i=SDPTools.parseSDP(t.sdp);for(let t=0;t<i.media.length;t++){"video"===i.media[t].type&&(log.info("rollback set video bitrate"),e.bitrateControl(i,t,"video"))}t.sdp=SDPTools.writeSDP(i);let o=new window.RTCSessionDescription(t);log.info("JSEPStatusRollback setRemoteDescription: \r\n"+t.sdp),await e.pc.setRemoteDescription(o),log.info("JSEPStatusRollback setRemoteDescription success")}catch(t){log.warn("JSEPStatusRollback set error: ",t),e.onSetRemoteDescriptionError(t)}}else log.warn("JSEPStatusRollback: Called in wrong state "+e.pc.signalingState)},WebRTCSession.prototype.on=function(e,t){if("function"!=typeof t)throw new Error("Provided parameter is not a function");this.EVENTS[e]=this.EVENTS[e]||[],this.EVENTS[e].push(t)},WebRTCSession.prototype.off=function(e,t){if(e&&"string"==typeof e){if(void 0===t)return void(this.EVENTS[e]=[]);let i=this.EVENTS[e]||[];for(let e=0;e<i.length;e++)if(i[e]===t){i.splice(e,1);break}}else this.EVENTS={}},WebRTCSession.prototype.trigger=function(e){let t=Array.prototype.slice.call(arguments),i=this.EVENTS[e];if(t.shift(),i)for(let o=0;o<i.length;o++)try{if(!1===i[o].apply(this,t))break;this.EVENTS[e].shift()}catch(e){throw e}},WebRTCSession.prototype.removeInviteAction=function(e){let t=this;if(log.info("remote invite action "+JSON.stringify(e,null,"    ")),e&&e.action)if(t.sendInviteQueue.length>0){for(let i=0;i<t.sendInviteQueue.length;i++)if(t.sendInviteQueue[i].action===e.action){t.sendInviteQueue.splice(i,1),log.info("sendInviteQueue length: "+t.sendInviteQueue.length+", ("+e.action+")");break}t.participantsSdpQueue.length>0?(log.info("prepare process next participants SDP"),t.handleParticipantsSdp()):t.sendInviteQueue.length>0&&(t.action=t.sendInviteQueue[0].action,t.actionCallback=t.sendInviteQueue[0].callback,log.info("prepare send invite "+t.action),t.doOffer(t.pc,t.pc.callType))}else log.info("removeInviteAction: remove already");else log.info("removeInviteAction: Invalid Argument")},WebRTCSession.prototype.getSessionInstance=function(e,t){if(log.info("get session instance of line ("+e+")"),!gsRTC)return log.warn("gsRTC is not found !"),null;let i=WebRTCSession.prototype.getSession({key:"lineId",value:e});return i||(e=gsRTC.lineIdCount++,log.warn("create new webRTC session "+e),i=new WebRTCSession(e),gsRTC.webrtcSessions.push(i)),t&&(i.transaction=t),i},WebRTCSession.prototype.getSession=function(e){if(!gsRTC||!gsRTC.webrtcSessions||!gsRTC.webrtcSessions.length)return void log.info("getSession: session []");if(!e||!e.key||!e.value)return void log.info("get session: invalid parameters: "+JSON.stringify(e,null,"    "));let t=gsRTC.webrtcSessions.find((t=>String(t[e.key])===String(e.value)));return t?log.info("get session by peer account ("+e.value+")"):log.warn("getSession: no session found"),t},WebRTCSession.prototype.getLocalParticipantSDP=function(e,t){log.info("get local participant sdp");let i=this;if(!e||!t)return void log.warn("get local participant sdp: local or remote sdp can not be empty");let o=SDPTools.parseSDP(t),n=SDPTools.parseSDP(e);if(n.media&&n.media.length&&n.media.length>3){n.media.splice(0,3),o.media&&o.media.length&&o.media.length>3&&o.media.splice(0,3),i.trimCodec(n);for(let e=0;e<n.media.length;e++){let t=n.media[e];if(delete t.iceOptions,delete t.fingerprint,delete t.icePwd,delete t.iceUfrag,delete t.setup,delete t.ext,o.media&&o.media[e]&&"inactive"===o.media[e].direction?t.direction="inactive":t.direction="recvonly",t.rtp&&t.rtp.length&&!i.localH264Payload.RTP&&!i.localH264Payload.RTX)for(let e=0;e<t.rtp.length;e++)"H264"===t.rtp[e].codec?(i.localH264Payload.RTP=t.rtp[e].payload,log.info("get local H264 RTP Payload ("+i.localH264Payload.RTP+")")):"rtx"===t.rtp[e].codec&&(i.localH264Payload.RTX=t.rtp[e].payload,log.info("get local H264 RTX Payload ("+i.localH264Payload.RTX+")"))}e=SDPTools.writeSDP(n)}let r=e.indexOf("m=");return e=e.slice(r)},WebRTCSession.prototype.setSessionLevelMediaLine=function(e){let t=SDPTools.parseSDP(e);if(this.trimCodec(t),t.groups[0].mids="",t.fingerprint=t.fingerprint||t.media[0].fingerprint,t.icePwd=t.icePwd||t.media[0].icePwd,t.iceUfrag=t.iceUfrag||t.media[0].iceUfrag,t.setup=t.media[0].setup,t.media&&t.media.length&&t.media.length>3){for(let e=0;e<t.media.length;e++){let i=t.media[e];t.groups[0].mids?t.groups[0].mids=t.groups[0].mids+" "+i.mid:t.groups[0].mids=t.groups[0].mids+i.mid,0===parseInt(i.port)&&(i.port=9),delete i.iceOptions,delete i.fingerprint,delete i.icePwd,delete i.iceUfrag,delete i.setup,delete i.ext}e=SDPTools.writeSDP(t)}return e},WebRTCSession.prototype.setDefaultRtcpReceiverReportSsrc=function(e,t){let i=this;if(log.info("set default RTCP receiver report ssrc"),!e||!t)return log.warn("Invalid sdp parameter"),t;let o=SDPTools.parseSDP(e),n=SDPTools.parseSDP(t);if(o.media&&o.media.length&&n.media&&n.media.length)for(let e=0;e<n.media.length;e++){let t=o.media[e],r=n.media[e];if(e>=3){let e,i,o,n;t.ssrcGroups&&t.ssrcGroups.length?(e=parseInt(t.ssrcGroups[0].ssrcs.split(" ")[0])+1,i=parseInt(t.ssrcGroups[0].ssrcs.split(" ")[1])+1):t.ssrcs&&t.ssrcs.length&&(e=parseInt(t.ssrcs[0].id)+1),r&&r.ssrcGroups&&r.ssrcGroups.length?(o=parseInt(r.ssrcGroups[0].ssrcs.split(" ")[0]),n=parseInt(r.ssrcGroups[0].ssrcs.split(" ")[1])):r.ssrcs&&r.ssrcs.length&&(o=parseInt(r.ssrcs[0].id));for(let t=0;t<r.ssrcs.length;t++){let s=r.ssrcs[t];s.id===o?s.id=e:s.id===n?i&&(s.id=i):log.warn("Get unexpected ssrc "+s.id)}r.ssrcGroups=t.ssrcGroups||r.ssrcGroups,r.ssrcGroups&&(r.ssrcGroups[0].ssrcs=i?e+" "+i:e+" "+n),r.msid=t.msid||r.msid}else{let e=i.mids.main;parseInt(r.mid)!==parseInt(e)||i.getStream("main",!0)||(log.warn("set main direction to inactive"),r.direction="inactive")}e>0?delete r.setup:r.setup="actpass"}else log.warn("set RTP/RTX SSRC failed, roParsedSdp: "+o),log.warn("set RTP/RTX SSRC failed, loParsedSdp: "+n);return SDPTools.writeSDP(n)},WebRTCSession.prototype.removeReservedPayloads=function(e,t,i){log.info("delete reserved payload");let o=SDPTools.parseSDP(e);if(o&&o.media&&o.media.length){for(let e=0;e<o.media.length;e++){let n=o.media[e];if(n.type===t&&n.rtp&&n.rtp.length)for(let t=0;t<n.rtp.length;t++)if(i.includes(n.rtp[t].payload)){log.warn("Payload type 2 is marked reserved due to conflicting use"),SDPTools.removeCodecByPayload(o,e,i);break}}e=SDPTools.writeSDP(o)}return e},WebRTCSession.prototype.removeSSRC=function(e){let t=this;for(let i=0;i<e.media.length;i++){let o=e.media[i].content||e.media[i].type;t.localStreams[o]||"audio"===o||(e.media[i].direction="recvonly",delete e.media[i].ssrcs,delete e.media[i].ssrcGroups,delete e.media[i].msid)}},WebRTCSession.prototype.renameMediaMsid=function(e,t){for(let i=0;i<e.media.length;i++){let o=e.media[i],n=gsRTC.generateUUID();"audio"===o.type?(o.ssrcs&&o.ssrcs.length&&o.ssrcs.forEach((function(e){"msid"===e.attribute&&(e.value=t+"_"+n+" audio")})),o.msid&&(o.msid.msid=t+"_"+n,o.msid.trackid="audio")):o.content&&"main"===o.content?(o.ssrcs&&o.ssrcs.length&&o.ssrcs.forEach((function(e){"msid"===e.attribute&&(e.value=t+"_"+n+" main-video")})),o.msid&&(o.msid.msid=t+"_"+n,o.msid.trackid="main-video")):o.content&&"slides"===o.content&&(o.ssrcs&&o.ssrcs.length&&o.ssrcs.forEach((function(e){"msid"===e.attribute&&(e.value=t+"_"+n+" slides-video")})),o.msid&&(o.msid.msid=t+"_"+n,o.msid.trackid="slides-video"))}},WebRTCSession.prototype.saveOwnMediasMid=function(e){let t=this,i=!0;if(Object.keys(t.mids).forEach((function(e){""===t.mids[e]&&(i=!1)})),!i){for(let i=0;i<e.media.length;i++){let o,n=e.media[i];"audio"===n.type?(o="audio",t.mids[o]=n.mid):n.content&&(o=n.content,t.mids[o]=n.mid)}log.info("save Medias Mid: "+JSON.stringify(t.mids,null,"    "))}},WebRTCSession.prototype.trimCodec=function(e){let t=this;if(e.media&&e.media.length)for(let i=0;i<e.media.length;i++){let o=e.media[i],n=["VP8","VP9"];"audio"===o.type?(n=["G722","opus","PCMU","PCMA","telephone-event"],SDPTools.removeCodecByName(e,i,n,!0)):("true"!==localStorage.getItem("test_red_ulpfec_enabled")&&(log.info("move red && ulpfec"),n.push("red","ulpfec")),t.trimH264Codec(e,i),SDPTools.removeCodecByName(e,i,n),"main"===o.content&&(t.attr.roCodec&&(log.info("remote codec "+t.attr.roCodec),SDPTools.removeCodecByName(e,i,[t.attr.roCodec],!0),t.attr.roCodec=null),t.attr.setCodec&&(log.info("set codec "+t.attr.setCodec),SDPTools.removeCodecByName(e,i,[t.attr.setCodec],!0),t.attr.setCodec=null)))}else log.warn("trimCodec error media: "+e.media)},WebRTCSession.prototype.trimH264Codec=function(e,t){let i=e.media[t],o=this.getExternalEncoder(i),n=SDPTools.getCodecByName(e,t,["H264"]);if(n&&n.length){let r=[];if(o)n.forEach((function(e){e!==o&&r.push(e)}));else{let e=n.splice(1,n.length);r.push(e);for(let t=0;t<i.fmtp.length;t++)if(i.fmtp[t].payload===e){let e=i.fmtp[t].config;e.indexOf("profile-level-id")<0&&(e+=";profile-level-id=42e028")}}SDPTools.removeCodecByPayload(e,t,r)}},WebRTCSession.prototype.getExternalEncoder=function(e){let t;if(e&&e.fmtp&&e.fmtp.length){for(let i=0;i<e.fmtp.length;i++){let o=e.fmtp[i].config;if(o.indexOf("packetization-mode=1")>=0&&o.indexOf("profile-level-id=42e0")>=0){t=e.fmtp[i].payload;break}}if(!t)for(let i=0;i<e.fmtp.length;i++){let o=e.fmtp[i].config;if(o.indexOf("packetization-mode=1")>=0&&o.indexOf("profile-level-id=4200")>=0){t=e.fmtp[i].payload;break}}}return t},WebRTCSession.prototype.getMaxBitRate=function(e){if(log.info("getMaxBitRate resolution "+e),!e)return log.warn("Invalid resolution parameter: "+e),null;let t=null;e=parseInt(e);let i=sessionStorage.getItem("isScreenShareGranted");log.info("is present sharing: "+i);let o=parseInt(sessionStorage.getItem("currentVideoStreamCount"));return log.info("currentVideoStreamCount "+o),360===e||"true"===i||o>4?t=172e3:720===e?t=512e3:1080===e&&(t=1024e3),log.info("get maxBitRate:  "+t),t},WebRTCSession.prototype.setEncodingParameters=function(e){log.info(e+" set encoding..");let t=this;if("audio"===e||!GsRTC.prototype.isSetEncodingSupport()||!t.getStream(e,!0))return;let i=t.mids[e],o=t.pc.getTransceivers().find((e=>e.mid?i.toString()===e.mid.toString():null));if(!o)return void log.warn("setEncodingParameters: transceiver is not found");let n=o.sender;if(n&&n.track&&n.getParameters){let i=n.getParameters();if("{}"===JSON.stringify(i)?i.encodings=[{}]:i.encodings.length&&i.encodings[0]||(i.encodings[0]={}),"main"===e){let e=t.videoUpResolution&&t.videoUpResolution.height||360,o=WebRTCSession.prototype.getMaxBitRate(e);i.encodings[0].maxBitrate=o||25e4,i.degradationPreference="maintain-framerate"}else"slides"===e&&(i.encodings[0].maxBitrate=512e3,i.degradationPreference="maintain-resolution");log.info("set setParameters: "+JSON.stringify(i,null,"    ")),n.setParameters(i).then((function(){log.info("set encoding parameters success")})).catch((function(e){log.info("set encoding parameters error"),log.error(e)}))}else log.info("setEncodingParameters: sender or getParameters is null")},WebRTCSession.prototype.bitrateControl=function(e,t,i){let o,n=this;if(log.info("bitrate control type "+i),e&&i){if("video"===i){let e=n.getStream("slides",!0),t=n.videoUpResolution&&n.videoUpResolution.height||360,i=WebRTCSession.prototype.getMaxBitRate(t);o=e&&n.isLocalVideoOn?1024e3+i:n.isLocalVideoOn?i:e?1024e3:15e4}else if("main"===i){let e=n.videoUpResolution&&n.videoUpResolution.height||360;o=WebRTCSession.prototype.getMaxBitRate(e)}else{if("slides"!==i)return void log.warn("Unknown type "+i);o=1024e3}log.info("get bitrate: "+o),SDPTools.setMediaBandwidth(e,t,o),SDPTools.setXgoogleBitrate(e,o,t),SDPTools.removeRembAndTransportCC(e,t)}else log.warn("bitrate control: Invalid argument")},WebRTCSession.prototype.saveNetStatsUseParam=function(e,t){let i=this;e.media.map(((o,n)=>{let r=o.ssrcs?o.ssrcs[0].id:null,s=SDPTools.getPriorityCodec(e,n);if("number"!=typeof o.mid&&(o.mid=Number(o.mid)),o.mid>2){let e;if(o.ssrcs&&o.ssrcs.length)for(let t=0;t<o.ssrcs.length;t++)if(o.ssrcs[t]&&"msid"===o.ssrcs[t].attribute){e=o.ssrcs[t].value;break}return!e&&o.msid&&o.msid.msid&&(e=o.msid.msid),void(e&&(e.indexOf("_")>0&&(e=e.split("_")[0]),i.MEDIA_SSRCS[e]=r,i.MEDIA_CODECS[e]=s))}if(t)switch(o.mid){case 0:i.MEDIA_SSRCS.LOCAL_AUDIO_SSRC=r,i.MEDIA_CODECS.LOCAL_AUDIO_CODEC=s;break;case 1:i.MEDIA_SSRCS.LOCAL_VIDEO_SSRC=r,i.MEDIA_CODECS.LOCAL_VIDEO_CODEC=s;break;case 2:i.MEDIA_SSRCS.LOCAL_PRESENT_SSRC=r,i.MEDIA_CODECS.LOCAL_PRESENT_CODEC=s}else switch(o.direction.indexOf("send")<0&&(r=null),o.mid){case 0:i.MEDIA_SSRCS.REMOTE_AUDIO_SSRC=r,i.MEDIA_CODECS.REMOTE_AUDIO_CODEC=s;break;case 1:i.MEDIA_SSRCS.REMOTE_VIDEO_SSRC=r,i.MEDIA_CODECS.REMOTE_VIDEO_CODEC=s;break;case 2:i.MEDIA_SSRCS.REMOTE_PRESENT_SSRC=r,i.MEDIA_CODECS.REMOTE_PRESENT_CODEC=s}}))},WebRTCSession.prototype.addUserdtx=function(e,t){let i=SDPTools.parseSDP(e),o=[];for(let e=0;e<i.media.length;e++){let n=i.media[e];if("audio"===n.type){log.info(t+" codec enable usedtx");for(let e=0;e<n.rtp.length;e++){let i=n.rtp[e];i.codec===t&&o.push(i.payload)}for(let e=0;e<o.length;e++){let t=o[e];for(let e=0;e<n.fmtp.length;e++){let i=n.fmtp[e];i.payload===t&&(""===i.config?i.config="usedtx=1":i.config.indexOf("usedtx=1")<0&&(i.config=i.config+";usedtx=1"))}}break}}return e=SDPTools.writeSDP(i)},WebRTCSession.prototype.modifyLevelId=function(e,t,i){log.info("modify profile-level-id");let o=null;switch(Number(i)){case 2160:o="33";break;case 1080:o="28";break;case 720:o="1f";break;case 480:o="1e";break;case 360:o="16";break;case 272:o="15";break;default:o=16,log.info("set default levelIdc, "+o)}log.info("set levelId of local sdp "+o);for(let i=0;i<e.media.length;i++){let n=e.media[i];if(n.content&&n.content===t)for(let e=0;e<n.fmtp.length;e++){let t=n.fmtp[e].config.indexOf("profile-level-id");if(t>=0){let i=n.fmtp[e].config.substr(t,21)+o;n.fmtp[e].config=n.fmtp[e].config.replace(/profile-level-id=([a-zA-Z0-9]{6})/,i)}}}},WebRTCSession.prototype.modifyRemoteProfileLevelId=function(e){log.info("set remote profile-level-id to 42e0xx");for(let t=0;t<e.media.length;t++){let i=e.media[t];i&&"video"===i.type&&i.fmtp&&i.fmtp.length&&i.fmtp.forEach((function(e){if(e.config){let t=e.config.indexOf("profile-level-id");if(t>=0){let i="profile-level-id=42e0"+e.config.substr(t+21,2);e.config=e.config.replace(/profile-level-id=([a-zA-Z0-9]{6})/,i)}}}))}},WebRTCSession.prototype.modifyRemoteSdpPayload=function(e){let t=this;log.info("modify remote sdp payload to the first H264 PT and RTX PT values of local SDP");let i=SDPTools.parseSDP(e),o=!1;if(i.media&&i.media.length&&i.media.length>3)for(let e=0;e<i.media.length;e++){let n=i.media[e];e>=3&&(n.fmtp&&n.fmtp.length&&n.fmtp.forEach((function(e){e.config.indexOf("apt=")>=0?(o=!0,t.localH264Payload.RTP&&(e.config="apt="+t.localH264Payload.RTP,t.localH264Payload.RTX&&(e.payload=t.localH264Payload.RTX))):t.localH264Payload.RTP&&(e.payload=t.localH264Payload.RTP)})),n.rtcpFb&&n.rtcpFb.length&&n.rtcpFb.forEach((function(e){t.localH264Payload.RTP&&"*"!==e.payload&&e.payload!==t.localH264Payload.RTP&&(e.payload=t.localH264Payload.RTP)})),n.rtp&&n.rtp.length&&n.rtp.forEach((function(e){"H264"===e.codec&&t.localH264Payload.RTP?e.payload=t.localH264Payload.RTP:"rtx"===e.codec&&t.localH264Payload.RTX&&(e.payload=t.localH264Payload.RTX)})),n.payloads&&(t.localH264Payload.RTP&&t.localH264Payload.RTX&&o?n.payloads=t.localH264Payload.RTP+" "+t.localH264Payload.RTX:t.localH264Payload.RTP&&(n.payloads=t.localH264Payload.RTP)))}return SDPTools.writeSDP(i)},WebRTCSession.prototype.getLocalSDP=function(){let e,t=this;log.warn("decorate local sdp");let i=t.pc.localDescription.sdp,o=SDPTools.parseSDP(i);"max-compat"===t.bundlePolicy&&SDPTools.setBundleMaxCompat(o),"audioConference"!==t.callType&&SDPTools.setMediaContentType(o,["main","slides"]),e=t.RESOLUTION.VIDEO_CURRENT_UP?t.RESOLUTION.VIDEO_CURRENT_UP.height:t.RESOLUTION.VIDEO_DEFAULT.height,t.modifyLevelId(o,"main",e),t.trimCodec(o),t.renameMediaMsid(o,gsRTC.accountId),t.saveNetStatsUseParam(o,!0),SDPTools.increaseSessionVersion(o),t.saveOwnMediasMid(o),"auto"!==gsRTC.getConfFromCookies("maxBitRate")&&(log.info("remove local goog-remb and transport-cc"),SDPTools.removeRembAndTransportCC(o));let n=gsRTC.getConfFromLocalStorage("enableTrickleIce");o.groups[0].mids="",o.fingerprint=o.media[0].fingerprint||o.fingerprint,o.icePwd=o.media[0].icePwd,o.iceUfrag=o.media[0].iceUfrag,o.setup=o.media[0].setup,"true"===n&&(o.iceOptions=o.media[0].iceOptions||o.iceOptions);for(let e=0;e<o.media.length;e++){let i=o.media[e];if(delete i.fingerprint,delete i.icePwd,delete i.iceUfrag,delete i.setup,0===parseInt(i.port)&&(i.port=9),e>=3&&t.callType.indexOf("videoConference")>=0)o.media.splice(e,1),e--;else if(o.groups[0].mids?o.groups[0].mids=o.groups[0].mids+" "+i.mid:o.groups[0].mids=o.groups[0].mids+i.mid,"true"===n||i.endOfCandidates||"audio"!==i.type?delete i.endOfCandidates:i.endOfCandidates="end-of-candidates",i.iceOptions&&delete i.iceOptions,"hold"===t.action){if("main"===i.content)i.direction=!0===t.isLocalVideoOn?"sendrecv":"inactive";else if("hold"===t.onRemoteHoldChange?"sendrecv"!==o.media[e].direction&&"recvonly"!==o.media[e].direction||(o.media[e].direction="inactive"):"sendrecv"===o.media[e].direction?o.media[e].direction="sendonly":"recvonly"===o.media[e].direction&&(o.media[e].direction="inactive"),i.content&&"slides"===i.content){t.getStream("slides",!0)&&t.setStream(null,"slides",!0)}}else if("unhold"===t.action)"audio"===i.type&&"hold"===t.onRemoteHoldChange?i.direction="recvonly":"main"===i.content?i.direction=!0===t.isLocalVideoOn?"sendrecv":"inactive":"slides"===i.content&&(i.direction="sendrecv");else if(t.isGDSCall)"callAnswer"===t.isGDSCall&&"audio"===i.type?i.direction="sendrecv":i.direction="recvonly";else if(i.content&&"main"===i.content){let e=t.getStream("main",!0);log.info("This.isRecvRequest: "+t.isRecvRequest),log.info("This.isRequestOpenLocalVideo: "+t.isRequestOpenLocalVideo),log.info("main stream: ",e),t.isRecvRequest&&!t.isRequestOpenLocalVideo||!e?(i.direction="inactive",log.warn("clear main stream."),e&&t.setStream(null,"main",!0),t.isLocalVideoOn=!1):(log.info("modified main video direction"),t.callType.indexOf("Conference")>=0?i.direction="sendonly":i.direction="sendrecv",t.isLocalVideoOn=!0)}else i.content&&"slides"===i.content&&(i.direction="sendrecv")}return i=SDPTools.writeSDP(o),i},WebRTCSession.prototype.getDecorateRo=function(e){let t=this;if(e.match(/declined-reason:no video codec/)&&t.callType.indexOf("Conference")>=0)return log.warn("no video codec id support"),t.actionCallback&&t.action&&t.actionCallback({codeType:gsRTC.CODE_TYPE.CODE_NOT_SUPPORT}),null;if(e=t.removeReservedPayloads(e,"audio",[2]),!gsRTC.isDecodeCapabilitiesSupport(e))return log.warn("Does not support remote decoding capabilities"),t.actionCallback&&t.action?t.actionCallback({codeType:gsRTC.CODE_TYPE.CODE_NOT_SUPPORT}):t.action&&t.trigger(t.action,{codeType:gsRTC.CODE_TYPE.CODE_NOT_SUPPORT}),null;t.latestParticipantsSdp&&(log.info("getDecorateRo: add participants sdp"),e+=t.latestParticipantsSdp);let i=GsRTC.prototype.getMlinesDirection(e,"audio");"inactive"===i||"sendonly"===i?(t.onRemoteHoldChange="hold",gsRTC.trigger("onRemoteHoldChange",{isHold:!0})):"hold"===t.onRemoteHoldChange&&(t.onRemoteHoldChange="unhold",gsRTC.trigger("onRemoteHoldChange",{isHold:!1}));let o=SDPTools.parseSDP(e);t.saveOwnMediasMid(o),t.modifyRemoteProfileLevelId(o);for(let e=0;e<o.media.length;e++){let i=o.media[e];if("main"===i.content)if(log.info("get video direction "+i.direction),i.invalid&&i.invalid.length){for(let e=0;e<i.invalid.length;e++)if(i.invalid[e].value&&i.invalid[e].value.indexOf("declined-reason:")>=0){log.info("close main stream");let o=t.getStream("main",!0);o&&(t.closeStream(o),t.setStream(null,"main",!0)),t.isLocalVideoOn=!1;let n=i.invalid[e].value;log.warn("Get UCM video "+n),"declined-reason:no video resource"===n?t.errorCode=GsRTC.prototype.CODE_TYPE.SERVER_RESOURCE_REACHED_LIMIT:"declined-reason:no video codec"===n&&(t.errorCode=GsRTC.prototype.CODE_TYPE.CODE_NOT_SUPPORT);break}}else if("p2pAudioCall"===t.callType||"p2pVideoCall"===t.callType)if("inactive"===i.direction){log.info("close main stream");let e=t.getStream("main",!0);e&&(t.closeStream(e),t.setStream(null,"main",!0)),t.isLocalVideoOn=!1}else t.isLocalVideoOn=!0;"video"===i.type&&(log.info("Prepare to set video bitrate"),t.bitrateControl(o,e,"video")),o.groups[0].mids&&!o.groups[0].mids.includes(i.mid)&&(o.groups[0].mids=o.groups[0].mids+" "+i.mid)}return e=SDPTools.writeSDP(o)},GsRTC.prototype.handleIncomingCall=function(e){log.info("handle incoming call");let t=this,i=WebRTCSession.prototype.getSessionInstance();i.remotePendingSdp=e.sdp,i.transaction=e.transaction,i.isRecvRequest=!0,e.isGDS&&(i.isGDSCall="preview",i.handleServerRequestSdp(i.remotePendingSdp));let o=e.sipHeaders;i.peerAccount=String(o.from),!i.channelID&&o.channelID&&(i.channelID=o.channelID,log.info("save incoming call sip channelID: "+i.channelID)),t.EVENTS&&t.EVENTS.incomingCallHandler?(log.info(o.from+" incoming call type: "+o.callType),t.EVENTS.incomingCallHandler({callNum:o.from,type:o.callType,channelID:o.channelID,displayName:o.displayName,isGDS:e.isGDS})):(log.warn("incomingCallHandler is not exist"),t.trigger("OnError",{codeType:"incomingCallHandler is not exist"}))},WebRTCSession.prototype.updateRemoteSdp=async function(e){let t=this;if(e)if(t&&t.pc)if(e=t.getDecorateRo(e))try{log.info("onSignalingStateChange type: "+t.pc.type+", signalingState: "+t.pc.signalingState);let i=await t.pc.createOffer(t.pc.offerConstraints);i.sdp=t.setSessionLevelMediaLine(i.sdp),await t.pc.setLocalDescription(i);let o=new window.RTCSessionDescription({type:"answer",sdp:e});await t.pc.setRemoteDescription(o),t.actionCallback&&t.action&&(log.info("Call callback"),t.actionCallback({codeType:gsRTC.CODE_TYPE.ACTION_SUCCESS})),!0===t.isExist183Process&&(t.isExist183Process=!1)}catch(e){log.error("handle TemporaryTone process sdp error: "+e.name)}else log.warn("no sdp to process");else log.warn("pc is not exist");else log.error("handle TemporaryTone process Sdp: Invalid Argument")},WebRTCSession.prototype.handleServerResponseSdp=async function(e){log.info("handle Server Response Sdp");let t=this;if(e)if(t&&t.pc)if(e=t.getDecorateRo(e))try{if(log.info("setRemoteDescription"),log.info("onSignalingStateChange type: "+t.pc.type+", signalingState: "+t.pc.signalingState),"have-local-offer"!==t.pc.signalingState)return void log.warn("handleServerResponseSdp: Called in wrong state "+t.pc.signalingState);log.info(`Server Response setRemoteDescription sdp:  \n${e}`);let i=new window.RTCSessionDescription({type:"answer",sdp:e});await t.pc.setRemoteDescription(i),t.setRemoteDescriptionSuccess(t.pc)}catch(e){t.onSetRemoteDescriptionError(e)}else log.warn("ServerResponse: no sdp to process");else log.warn("pc is not exist");else log.error("handle Server Response Sdp: Invalid Argument")},WebRTCSession.prototype.handleServerRequestSdp=async function(e){log.info("handle server request sdp ");let t=this;if(t.pc||(log.info("createPeerConnection"),t.pc=t.createPeerConnection(gsRTC.conf,t.callType)),e)if(e=t.getDecorateRo(e))try{let i=t.pc;if(log.info("handle setRemoteDescription"),"stable"!==t.pc.signalingState){if("p2pAudioCall"!==t.callType&&"p2pVideoCall"!==t.callType)return void log.warn("handleServerRequestSdp: Called in wrong state "+t.pc.signalingState);"inactive"!==GsRTC.prototype.getMlinesDirection(e,"main")&&t.sendInviteQueue.length&&"shareVideo"===t.action&&(log.info("roll back for Received a request to turn on the camera when turning on the camera"),t.JSEPStatusRollback())}t.latestParticipantsSdp&&(log.info("handleServerRequestSdp: add participants sdp"),e+=t.latestParticipantsSdp),log.info(`Server request setRemoteDescription sdp:  \n${e}`);let o=new window.RTCSessionDescription({type:"offer",sdp:e});await i.setRemoteDescription(o),t.setRemoteDescriptionSuccess(i),await t.doAnswer(i),t.isAnswerForSendCandi=!0,t.remotePendingSdp=""}catch(e){t.onSetRemoteDescriptionError(e)}else log.warn("ServerRequest: no sdp to process");else log.error("sdp is empty ...")},WebRTCSession.prototype.handleParticipantsSdp=async function(){log.info("Processing other participants media information");let e=this;if(!e.pc.currentRemoteDescription)return void log.warn("session currentRemoteDescription is not found");if("stable"!==e.pc.signalingState)return void log.warn("handleParticipantsSdp: Called in wrong state "+e.pc.signalingState);let t=e.participantsSdpQueue.shift();if(!t.sdp)return log.warn("participantsSdpQueue no bodies body found, send auto replay"),void gsRTC.sipStack.jsSipSendRsp(t.transaction,gsRTC.SIP_RESPONSE_CODES.OK);let i=t.sdp,o=e.pc.currentRemoteDescription.sdp,n=SDPTools.parseSDP(o),r=n.media.length;n.media&&n.media.length>=3&&n.media.splice(3),o=SDPTools.writeSDP(n);let s=o+i,a=SDPTools.parseSDP(s);a.setup="passive",a.connection=a.connection||a.media[0].connection;for(let t=0;t<a.media.length;t++){let i=a.media[t];a.groups[0].mids&&!a.groups[0].mids.includes(i.mid)&&(a.groups[0].mids=a.groups[0].mids+" "+i.mid),delete i.setup,delete i.connection,"video"===i.type&&(log.info("participants: Prepare to set video bitrate"),e.bitrateControl(a,t,"video"))}e.saveNetStatsUseParam(a,!1),e.modifyRemoteProfileLevelId(a),s=SDPTools.writeSDP(a);try{let o=SDPTools.parseSDP(s).media.length-r;if(log.warn("need created media number ("+o+")"),o)for(let t=1;t<=o;t++)if("firefox"===gsRTC.getBrowserDetail().browser){let t=await WebRTCSession.prototype.getCaptureStreams();log.info("add fake stream",t),e.pc.addStream(t)}else log.info("add video transceiver"),e.pc.addTransceiver("video");log.info("participants create offer");let n=await e.pc.createOffer(e.pc.offerConstraints);n.sdp=e.setSessionLevelMediaLine(n.sdp),log.info("participants setLocalDescription sdp: \n"+n.sdp),await e.pc.setLocalDescription(n),e.setEncodingParameters("main");let a=e.getLocalParticipantSDP(n.sdp,s);s=e.modifyRemoteSdpPayload(s),log.info("participants setRemoteDescription sdp: \n"+s);let l=new window.RTCSessionDescription({type:"answer",sdp:s});await e.pc.setRemoteDescription(l),log.info("participants setRemoteDescription success"),log.info("send notify reply of ("+t.transaction+")"),gsRTC.sipStack.jsSipSendRsp(t.transaction,gsRTC.SIP_RESPONSE_CODES.OK,"application/participant-sdp",a),e.latestParticipantsSdp=i,e.participantsSdpQueue.length?(log.info("process next participants SDP"),e.handleParticipantsSdp()):e.sendInviteQueue.length&&(e.action=e.sendInviteQueue[0].action,e.actionCallback=e.sendInviteQueue[0].callback,log.info("participants processing completed, prepare send invite "+e.action),e.doOffer(e.pc,e.pc.callType))}catch(e){log.warn("handleParticipantsMediaInfo error: ",e),log.error("handle participants media error: "+e.name)}},WebRTCSession.prototype.handle491Response=function(){log.info("handle server 491 response");let e=this;"have-local-offer"===e.pc.signalingState&&e.JSEPStatusRollback(),e.isCallInitiator?(log.info("the UAC is not the owner of the Call-ID"),e.retry=2*Math.random()):(log.info("the UAC is the owner of the Call-ID"),e.retry=1.9*Math.random()+2.1),log.info("491 INVITE retry: "+e.retry),e.timerReSendInvite=setTimeout((function(){e.pc&&"iceRestart"===e.pc.action?e.doIceRestart(e.pc):e.sendInviteQueue.length&&(e.action=e.sendInviteQueue[0].action,e.actionCallback=e.sendInviteQueue[0].callback,log.info("participants processing completed, prepare send invite "+e.action),e.doOffer(e.pc,e.pc.callType))}),1e3*e.retry)},WebRTCSession.prototype.closeStream=function(e){if(e){log.info("close stream id: "+e.id);try{e.oninactive=null;let t=e.getTracks();for(let e in t)t[e].onended=null,log.info("close stream"),t[e].stop()}catch(e){log.info("closeStream: Failed to close stream"),log.info(e)}e=null}else log.info("closeStream:stream is null")},WebRTCSession.prototype.setStream=function(e,t,i,o){let n=this;if(!t)return void log.warn("setStream: Invalid parameter!");let r=e?e.id:null;log.info("set "+t+" stream id: "+r),i?(n.localStreams[t]&&n.closeStream(n.localStreams[t]),n.localStreams[t]=e):"audio"===t||"slides"===t?n.remoteStreams[t]=e:n.remoteStreams.mainVideos[t]=e;let s={stream:e,type:t,isLocal:i,msid:o};gsRTC.trigger("onStreamChange",s)},WebRTCSession.prototype.getStream=function(e,t){if(!e)return void log.warn("getStream: Invalid parameter!");let i;return i=t?this.localStreams[e]:"audio"===e||"slides"===e?this.remoteStreams[e]:this.remoteStreams.mainVideos[e],i?log.info("get "+e+" stream id :"+i.id):log.warn(e+" stream does not exist"),i},WebRTCSession.prototype.getGumErrorCode=function(e,t){let i;return"audio"===e?i="NotFoundError"===t||"DevicesNotFoundError"===t?GsRTC.prototype.CODE_TYPE.MIC_NOT_FOUND:"NotReadableError"===t||"TrackStartError"===t?GsRTC.prototype.CODE_TYPE.MIC_NOT_READABLE:"NotAllowedError"===t||"PermissionDeniedError"===t||t&&-1!==t.indexOf("denied")?GsRTC.prototype.CODE_TYPE.MIC_REQUEST_REFUSE:"TypeError"===t?GsRTC.prototype.CODE_TYPE.MIC_TYPE_ERROR:GsRTC.prototype.CODE_TYPE.MIC_REQUEST_FAIL:"video"===e&&(i="OverconstrainedError"===t||"ConstraintNotSatisfiedError"===t||"InternalError"===t?GsRTC.prototype.CODE_TYPE.VIDEO_REQUEST_OVER_CONSTRAINTS:"NotFoundError"===t||"DevicesNotFoundError"===t?GsRTC.prototype.CODE_TYPE.VIDEO_NOT_FOUND:"NotReadableError"===t||"TrackStartError"===t?GsRTC.prototype.CODE_TYPE.VIDEO_NOT_READABLE:"NotAllowedError"===t||"PermissionDeniedError"===t||t&&-1!==t.indexOf("denied")?GsRTC.prototype.CODE_TYPE.VIDEO_REQUEST_REFUSE:"TypeError"===t?GsRTC.prototype.CODE_TYPE.VIDEO_TYPE_ERROR:GsRTC.prototype.CODE_TYPE.VIDEO_REQUEST_FAIL),log.info("gum error "+t+", code "+i),i},WebRTCSession.prototype.getUserMediaStream=async function(e){let t=this,i={},o=e.type;"audio"===o?(i={audio:!0,video:!1},gsRTC.device.currentDev.audioDeviceId&&(i.audio={deviceId:{exact:gsRTC.device.currentDev.audioDeviceId}})):"video"===o&&(i={audio:!1,video:{width:t.RESOLUTION.VIDEO_DEFAULT.width,height:t.RESOLUTION.VIDEO_DEFAULT.height,frameRate:15}},gsRTC.device.currentDev.videoDeviceId&&(i.video.deviceId={exact:gsRTC.device.currentDev.videoDeviceId})),await navigator.mediaDevices.getUserMedia(i).then((function(o){if(!t.pc||t.pc&&"closed"===t.pc.signalingState)return log.info("getUserMediaStream: RTCPeerConnection is not available"),void WebRTCSession.prototype.closeStream(o);log.info("get stream success constraints: "+JSON.stringify(i,null,"  ")),t.videoUpResolution=i.video,e.callback({stream:o,constraints:i})})).catch((function(t){e.callback({error:t})}))},WebRTCSession.prototype.getSwitchDevMediaStream=function(e,t){log.warn("get SwitchLocalVideoDevice Media Stream"),log.info("switch Local video Device get stream constraints: "+JSON.stringify(t,null,"   "));let i=this;if(!(t&&t.video.deviceId&&t.video.height&&t.video.width))return log.warn("switch Local video Device: deviceId mandatory"),void(e&&e({codeType:i.CODE_TYPE.PARAMETER_ERROR}));t.video.deviceId.exact||(t.video.deviceId.exact=t.video.deviceId||t.video.deviceId.exact||t.video.deviceId.ideal),navigator.mediaDevices.getUserMedia(t).then((function(i){log.info(" switchLocalVideoDevice get stream success constraints: "+JSON.stringify(t,null,"  ")),e({stream:i,constraints:t})})).catch((function(o){log.warn("switchLocalVideoDevice get stream failed: "+JSON.stringify(t,null,"  ")),log.warn("onGetStreamFailed: "+o.message),"OverconstrainedError"===o.name||"ConstraintNotSatisfiedError"===o.name?(log.warn("switchLocalVideoDevice: constraints can not be satisfied by avb.device"),function(i){1920===Number(t.video.width.exact)?(t.video.width.exact=1280,t.video.height.exact=720):1280===Number(t.video.width.exact)?(t.video.width.exact=640,t.video.height.exact=360):640===Number(t.video.width.exact)?(t.video.width.ideal=t.video.width.exact,t.video.height.ideal=t.video.height.exact,delete t.video.width.exact,delete t.video.height.exact):(log.warn(" Failed to get video stream "),e({error:i}))}(o),i.getSwitchDevMediaStream(e,t)):("NotFoundError"===o.name||"DeviceNotFoundError"===o.name?log.warn("require track is missing"):"NotReadableError"===o.name||"TrackStartError"===o.name?log.warn("webcam or mic are already in use"):"NotAllowedError"===o.name||"PermissionDeniedError"===o.name||"PermissionDismissedError"===o.name?log.warn("permission denied in browser"):"TypeError"===o.name?log.warn("empty constraints object"):log.warn("other errors "+o.name),e({error:o}))}))},WebRTCSession.prototype.getStreamFromDevice=function(e){if(!e||!e.streamType||!e.constraints||!e.constraints.audio&&!e.constraints.video)return void log.error("getStreamFromDevice: invalid parameters");let t={};switch(e.streamType){case"audio":t={audio:!e.constraints.audio.deviceId||{deviceId:{exact:e.constraints.audio.deviceId}},video:!1};break;case"video":t={audio:!1,video:{width:{exact:e.constraints.video.width?e.constraints.video.width:640},height:{exact:e.constraints.video.height?e.constraints.video.height:360},deviceId:e.constraints.video.deviceId?{exact:e.constraints.video.deviceId}:""}},"firefox"!==GsRTC.prototype.getBrowserDetail().browser&&(t.video.frameRate={exact:e.constraints.video.frameRate?e.constraints.video.frameRate:15});break;case"screenShare":window.ipcRenderer?(log.info("desktop share"),t={audio:!1,video:{mandatory:{chromeMediaSource:e.constraints.video.mandatory.chromeMediaSource||"desktop",maxWidth:e.constraints.video.mandatory.maxWidth||1920,maxHeight:e.constraints.video.mandatory.maxHeight||1080,minWidth:e.constraints.video.mandatory.minWidth||1280,minHeight:e.constraints.video.mandatory.minHeight||720,maxFrameRate:e.constraints.video.mandatory.maxFrameRate||5}}},e.constraints.video.mandatory.chromeMediaSource&&(t.video.mandatory.chromeMediaSource=e.constraints.video.mandatory.chromeMediaSource)):t={audio:GsRTC.prototype.isSystemAudioShareSupport(),video:{width:{max:e.constraints.video.width?e.constraints.video.width:1920},height:{max:e.constraints.video.height?e.constraints.video.height:1080},frameRate:{max:e.constraints.video.frameRate?e.constraints.video.frameRate:15}}};break;default:log.warn("Unknown type: "+e.streamType)}let i={streamType:e.streamType,stream:e.stream,isFirefox:"firefox"===GsRTC.prototype.getBrowserDetail().browser,callback:e.callback};gsRTC.device.getMedia(i,t)},WebRTCSession.prototype.setConstraintsOfGetStream=function(e,t){log.info("set Constraints of Get Stream");let i=this,o={};switch(e.streamType){case"audio":o={audio:!e.deviceId||{deviceId:e.deviceId},video:!1};break;case"video":e.action?"adjustResolution"===e.action?(log.info("adjustResolution get stream constraints: "+JSON.stringify(t,null,"   ")),o={video:{width:{exact:t.video.width.exact},height:{exact:t.video.height.exact},frameRate:{exact:t.video.frameRate&&t.video.frameRate.exact||" "},deviceId:{exact:t.video.deviceId.exact}}},640===Number(t.video.width.exact)&&360===Number(t.video.height.exact)&&(delete o.video.height.exact,o.video.height.ideal=t.video.height.exact)):"switchLocalVideoDevice"===e.action&&(log.info("switch Local video Device get stream constraints: "+JSON.stringify(t,null,"   ")),1920===Number(t.video.width.exact)?(t.video.width.exact=1280,t.video.height.exact=720):1280===Number(t.video.width.exact)?(t.video.width.exact=640,t.video.height.exact=360):640===Number(t.video.width.exact)?(t.video.width.ideal=t.video.width.exact,t.video.height.ideal=t.video.height.exact,delete t.video.width.exact,delete t.video.height.exact):(log.warn(" The constraints parameter is not satisfied "),e.callback({error:e.error})),o=t):(log.info("get stream constraints: "+JSON.stringify(t,null,"   ")),o={audio:!1,video:{width:{ideal:t.video.width.exact},height:{ideal:t.video.height.exact},frameRate:{exact:t.video.frameRate&&t.video.frameRate.exact||" "},deviceId:{exact:t.video.deviceId&&t.video.deviceId.exact||" "}}}),"firefox"===gsRTC.getBrowserDetail().browser&&delete o.video.frameRate;break;case"screenShare":t=i.getScreenShareConstraints(e);break;default:log.warn("unknown type "+e.streamType)}return o},WebRTCSession.prototype.streamMuteSwitch=function(e){if(null!=e.stream){if(log.info("MuteStream: stream id = "+e.stream.id),e&&e.stream&&"audio"===e.type&&e.stream.getAudioTracks().length>0)for(let t=0;t<e.stream.getAudioTracks().length;t++)e.mute?!0===e.stream.getAudioTracks()[t].enabled&&(log.info("MuteStream exec mute audio"),e.stream.getAudioTracks()[t].enabled=!1):!1===e.stream.getAudioTracks()[t].enabled&&(log.info("MuteStream exec unmute audio"),e.stream.getAudioTracks()[t].enabled=!0);else if(("video"===e.type||"slides"===e.type)&&e.stream.getVideoTracks().length>0)for(let t=0;t<e.stream.getVideoTracks().length;t++)e.mute?!0===e.stream.getVideoTracks()[t].enabled&&(log.info("MuteStream exec mute video/slides"),e.stream.getVideoTracks()[t].enabled=!1):!1===e.stream.getVideoTracks()[t].enabled&&(log.info("MuteStream exec unmute video/slides"),e.stream.getVideoTracks()[t].enabled=!0)}else log.warn("stream is not exist!")},WebRTCSession.prototype.processAddStream=function(e,t,i){log.info("process add stream, type "+i);try{let o,n=this.mids[i];if(t.getTransceivers().map((function(e){n.toString()===e.mid.toString()&&(o=e)})),!o)return void log.info("processAddStream: transceiver is not found");if(t.getTransceivers().length>0)if(window.RTCRtpTransceiver.prototype.setDirection)log.info("use replaceTrack to add stream "),o.setDirection("sendrecv");else{o.direction="sendonly",o.direction="inactive";let t="audio"===i?e.getAudioTracks()[0]:e.getVideoTracks()[0];o.sender.replaceTrack(t).then((function(){log.info("use replaceTrack to add stream ")})).catch((function(e){log.error(e.toString())})),o.direction="sendrecv"}else{let n=gsRTC.getBrowserDetail();if("safari"!==n.browser||"11.0.2"!==n.UIVersion&&"11.1.2"!==n.UIVersion||!o){if(e)if("addStream"in window.RTCPeerConnection.prototype)t.addStream(e),log.info("use addStream to add stream.");else{let i=window.RTCPeerConnection.prototype.addTrack;e.getTracks().forEach((function(o){i.call(t,o,e)})),log.info("use addTrack to add stream.")}}else{let t="audio"===i?e.getAudioTracks()[0]:e.getVideoTracks()[0];o.sender.replaceTrack(t).then((function(){log.info("use replaceTrack to add stream ")})).catch((function(e){log.error(e.toString())}))}}}catch(e){log.warn("process add stream"+e)}},WebRTCSession.prototype.processRemoveStream=function(e,t,i){try{let o=this;log.info("process remove stream, type "+i);let n,r=o.mids[i];if(t.getTransceivers().forEach((function(e){r.toString()===e.mid.toString()&&(n=e)})),!n)return void log.error("processRemoveStream: transceiver is not found");if(t.getTransceivers().length>0)window.RTCRtpTransceiver.prototype.setDirection?(log.info("use replaceTrack to remove stream."),n.setDirection("recvonly")):("slides"===i?n.direction="sendrecv":(n.direction="sendonly",n.direction="inactive",n.direction="recvonly"),n.sender.replaceTrack(null).then((function(){log.info("use replaceTrack to remove stream ")})).catch((function(e){log.error(e.toString())})));else{let i=gsRTC.getBrowserDetail();if("safari"!==i.browser||"11.0.2"!==i.UIVersion&&"11.1.2"!==i.UIVersion||!n){if(e)if("removeStream"in window.RTCPeerConnection.prototype)t.removeStream(e),log.info("use removeStream to remove stream ");else{let i=e.getTracks();t.getSenders().forEach((function(e){-1!==i.indexOf(e.track)&&t.removeTrack(e)})),log.info("use removeTrack to remove stream ")}}else n.sender.track.enabled=!1}}catch(e){log.warn("process remove stream "+e)}},WebRTCSession.prototype.getCaptureStreams=async function(){let e,t=document.createElement("canvas");if(t.style.cssText="display: none",t.getContext){let i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.fillStyle="#0000FF",i.fillRect(0,0,1,1),t.captureStream?e=t.captureStream(5):t.mozCaptureStream?e=t.mozCaptureStream(5):log.error("Current browser does not support captureStream!!"),log.info("get captureStream: ",e)}else log.warn("canvas getContext is unsupported");return e},WebRTCSession.prototype.onConnectionStateChange=function(e){log.info("onConnectionStateChange type: "+e.type+", connectionState: "+e.connectionState);let t=gsRTC.getBrowserDetail();"failed"===e.connectionState&&("chrome"===t.browser&&t.version>=76||"opera"===t.browser&&t.chromeVersion>=76)&&this.iceConnectFailed(e)},WebRTCSession.prototype.onIceConnectionStateChange=function(e){if(!e)return void log.warn("Ignoring of ICE candidate event as Peer connection does not exists ->");let t=e.iceConnectionState;switch(log.info("onIceConnectionStateChange this type: "+e.type+", iceConnectionState: "+t),t){case"new":case"starting":case"checking":case"completed":case"closed":case"disconnected":default:break;case"connected":let t=this;e.isIceFailed&&("iceRestart"===e.action&&e.offerConstraints.iceRestart?e.actionCallback=i=>{i&&i.codeType&&999===Number(i.codeType)&&(t.onIceRestartSuccess(e),t.removeInviteAction({action:e.action}),e.actionCallback=null,e.action=null)}:(log.info("iceRestartSuccess alter web"),t.onIceRestartSuccess(e)));break;case"failed":this.iceConnectFailed(e)}},WebRTCSession.prototype.onSignalingStateChange=function(e){e?log.info("onSignalingStateChange type: "+e.type+", signalingState: "+e.signalingState):log.info("WebRTCSession is null: unexpected")},WebRTCSession.prototype.onIceGatheringStateChange=function(e){e?log.info("onicegatheringstatechange type: "+e.type+", iceGatheringState: "+e.iceGatheringState):log.info("WebRTCSession is null: unexpected")},WebRTCSession.prototype.doIceRestart=function(e){log.info("Prepare start do ice restart！"),e.isIceFailed=!0,e.isLocalSdpPending=!0,this.sendInviteQueue.filter((e=>e.action="iceRestart"))[0]||this.sendInviteQueue.push({action:"iceRestart",sdp:null,type:e.type}),this.doOffer(e,e.type),e.iceFailureNum++},WebRTCSession.prototype.iceConnectFailed=function(e){gsRTC.trigger("onIceReconnect",{codeType:gsRTC.CODE_TYPE.ICE_CONNECTION_FAILED}),log.warn("iceConnectFailed, o_failure_num: "+e.iceFailureNum+"  (PC:"+e.type+")"),gsRTC&&gsRTC.webrtcSessions&&gsRTC.webrtcSessions.length?(e.action="iceRestart",e.iceFailureNum>=3?(log.error("Failed to do ice restart(PC: "+e.type+")"),this.onIceRestartFailed(e)):gsRTC.socket&&gsRTC.socket.ws&&1===gsRTC.socket.ws.readyState&&(gsRTC.trigger("onIceReconnect",{codeType:gsRTC.CODE_TYPE.ICE_RECONNECTING}),this.doIceRestart(e))):log.info("no session need process")},WebRTCSession.prototype.onIceRestartSuccess=function(e){log.info("ice restart success  (PC:"+e.type+")"),e.iceFailureNum=0,e.isIceFailed=!1,gsRTC.trigger("onIceReconnect",{codeType:gsRTC.CODE_TYPE.ACTION_SUCCESS})},WebRTCSession.prototype.onIceRestartFailed=function(e){log.error("ice restart failed"),e.iceFailureNum=0,e.isIceFailed=!0,gsRTC.trigger("onIceReconnect",{codeType:gsRTC.CODE_TYPE.ICE_RECONNECTED_FAILED})},WebRTCSession.prototype.onIceCandidate=function(e,t){log.info(`ICE candidate:\n${t.candidate?t.candidate.candidate:"(null)"}`);let i=e.iceGatheringState,o=this,n=localStorage.getItem("enableTrickleIce");if(this.iceCollecting=!0,("completed"===i||"complete"===i||t&&!t.candidate)&&"true"!==n)log.warn("onIceCandidate: ICE GATHERING COMPLETED"),e.isLocalSdpPending=!1,this.onIceGatheringCompleted();else if("failed"===i)return void log.info(`${e.type} ICE candidate:\n${t.candidate?t.candidate.candidate:"(null)"}`);if("true"===n){if(e.isLocalSdpPending=!1,t.candidate&&(t.candidate.candidate.indexOf(" 9 typ host tcp")>=0||t.candidate.candidate.indexOf("169.254.")>=0))return;o.handleTrickleIce({candidate:t.candidate?t.candidate.candidate:null,mid:t.candidate?t.candidate.sdpMid:null})}},WebRTCSession.prototype.onIceGatheringCompleted=function(){let e=this,t=e.pc;if("iceRestart"===t.action&&(e.isInviteBeingProcessed=!1),!0===t.isLocalSdpPending)return log.info("MyOnIceGatheringCompleted not ready( "+t.type+" )"),!1;if(!e.isInviteBeingProcessed){log.warn("__MyOnIceGatheringCompleted be ready to send INVITE or 200OK");let t=e.getLocalSDP();e.lastReInviteSdp=t,gsRTC.sipStack.sendSipMessage({sdp:t,contentType:"application/sdp",session:e,rspCode:gsRTC.SIP_RESPONSE_CODES.OK})}},WebRTCSession.prototype.getContentForTrickleIce=function(e,t){let i=this.pc.localDescription;if(i)return function(i){function o(e){if(!e)return;let t;for(let i=0;i<e.length;i++)t?t+=e[i]:t=e[i];return t}let n,r="m=audio 9 RTP/AVP 0\r\na=mid:"+t+"\r\n",s=[/a=ice-ufrag:[\w\/\+\-]+\r\n/,/a=ice-pwd:[\w\/\+\-]+\r\n/];for(let e=0;e<s.length;e++)n=i.match(s[e]),r?r+=o(n):r=o(n);return e&&(r+=e),r}(i.sdp);log.error("getContentForTrickleIce: localDescription is null")},WebRTCSession.prototype.handleTrickleIce=function(e){log.info("handle trickle ice!");let t,i=this;if(e.candidate){let t=[];i.trickleCandidate.map((i=>{let o=i.candiCont.split("\r\n").find((e=>e.indexOf("ice-ufrag")>=0)).split(":")[1],n=e.candidate.split(" ");o===n[n.indexOf("ufrag")+1]&&t.push(i)})),i.trickleCandidate=deepCopy(t);let o="a="+e.candidate+"\r\n",n=i.trickleCandidate.filter((t=>Number(t.sdpMid)===Number(e.mid)))[0];if(n)n.candidates.push(o),n.candiCont+=o;else{let t={ifcompleted:!1,candiCont:"",candidates:[],sdpMid:e.mid};t.candidates.push(o),t.candiCont=i.getContentForTrickleIce(t.candidates[0],e.mid),i.trickleCandidate.push(t)}}else log.warn("end of candidate"),i.trickleCandidate.map((e=>{t+=e.candiCont,e.candiCont.indexOf("end-of-candidates")<0&&(e.candiCont+="a=end-of-candidates\r\n")}));if(t="",i.trickleCandidate.length>0&&i.trickleCandidate.map((e=>{t+=e.candiCont})),i.readyToSendCandidate&&this.iceCollecting){log.warn("Send info for trickle ice candidate: "),e.candidate||(this.iceCollecting=!1,i.readyToSendCandidate=!1,i.trickleCandidate=[]);let o=[{name:"Info-Package",value:"trickle-ice"},{name:"Content-Disposition",value:"Info-Package"}];if(i.lastSendCandiContent===t)return void log.warn("This trickle ice candidate has been sended!");i.lastSendCandiContent=t,gsRTC.sipStack.jsSipSendInfo(i.lineId,o,"application/trickle-ice-sdpfrag",t)}},WebRTCSession.prototype.setVideoResolution=function(e,t){e&&t?this.RESOLUTION[t]?(this.RESOLUTION[t]=e,log.info("save expect "+t+" resolution: "+e.height)):log.info("unknown resolution: "+t):log.warn("setVideoResolution: INVALID PARAMETERS")},WebRTCSession.prototype.getVideoResolution=function(e){if(!e)return void log.warn("getVideoResolution: INVALID PARAMETER");let t,i=this;return this.RESOLUTION[e]?(t=i.RESOLUTION[e],log.info("get "+e+" resolution: "+t)):log.warn("unknown resolution :"+e),t},WebRTCSession.prototype.getMaxUpResolution=function(e){log.info("This.o_resolution_up_sdp: "+e);let t=e,i=gsRTC.getConfFromCookies("maxResolution");if(i&&"auto"!==i){let o;e?e.height>i&&(o=i):(t={},o=i),o&&(t=this.getResolutionByHeight(o))}return"firefox"===gsRTC.getBrowserDetail().browser&&t.height>=1080&&(log.info("firefox 56 do not support 1080P."),t=this.getResolutionByHeight(720)),t?log.info("Get max resolution = "+t.height):log.info("Get max resolution null "),t},WebRTCSession.prototype.setVideoUpResolution=function(e){e&&e.video&&e.video.height&&e.video.width&&(this.RESOLUTION.VIDEO_CURRENT_UP={width:e.video.width.exact||e.video.width.ideal||e.video.width.max||e.video.width,height:e.video.height.exact||e.video.height.ideal||e.video.height.max||e.video.height},log.info("set video up resolution: "+this.RESOLUTION.VIDEO_CURRENT_UP.width+"*"+this.RESOLUTION.VIDEO_CURRENT_UP.height))},WebRTCSession.prototype.getResolutionByHeight=function(e){if(!e)return log.warn("height is null"),null;let t;switch(e=parseInt(e)){case 2160:log.info("3840 * 2160"),t={width:3840,height:2160};break;case 1080:log.info("1920 * 1080"),t={width:1920,height:1080};break;case 720:log.info("1280 * 720"),t={width:1280,height:720};break;case 480:log.info("848 * 480"),t={width:848,height:480};break;case 360:log.info("640 * 360"),t={width:640,height:360};break;case 272:log.info("480 * 272"),t={width:640,height:360};break;default:log.info(" Unknown resolution "+e+", default 640 * 360"),t={width:640,height:360}}return t};let offerConnection,localWindow,presentStream,screenSplitLog={debug:window.debug("screen_split:DEBUG"),log:window.debug("screen_split:LOG"),info:window.debug("screen_split:INFO"),warn:window.debug("screen_split:WARN"),error:window.debug("screen_split:ERROR")},appDomain="https://"+window.location.host,slideVideoEle=document.getElementById("remotePresentVideo");function shareScreenSplitOut(e){screenSplitLog.info("get present stream: "+e.id),presentStream=e;let t=document.body.clientWidth/3*2,i=document.body.clientHeight/3*2;window.secondWindow=window.open(appDomain+"/splitScreen.html?v=224","second-screen","toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no, width="+t+", height="+i+", left="+t/4+", top="+i/4),window.secondWindow.focus()}async function createLocalDescription(){let e={optional:[{pcName:"PC_split_offer_"+Math.random().toString(36).substr(2)}]};offerConnection=new window.RTCPeerConnection(null,e),offerConnection.onicecandidate=onIceCandidate,offerConnection.addStream(presentStream),screenSplitLog.info("add presentStream to offerConnection");try{const e=await offerConnection.createOffer();await async function(e){screenSplitLog.info("offerConnection setLocalDescription:\n"+e.sdp);try{await offerConnection.setLocalDescription(e),screenSplitLog.warn("setLocalDescription success")}catch(e){screenSplitLog.error("setLocalDescription error:\n"+e.toString())}}(e)}catch(e){screenSplitLog.error("offerConnection createOffer error:\n"+e.toString())}}function handleSdp(){screenSplitLog.info("handle sdp");let e=offerConnection.localDescription.sdp,t=SDPTools.parseSDP(e),i=localStorage.getItem("slideVideoInCodeName")?localStorage.getItem("slideVideoInCodeName"):"",o=localStorage.getItem("ASBitrate")?localStorage.getItem("ASBitrate"):1216,n=localStorage.getItem("startBitrate")?localStorage.getItem("startBitrate"):1536;for(let e=0;e<t.media.length;e++){if("video"!==t.media[e].type)return;SDPTools.setMediaBandwidth(t,e,o),SDPTools.setXgoogleBitrate(t,n,e),SDPTools.removeRembAndTransportCC(t,e),i&&SDPTools.removeCodecByName(t,e,i)}return e=SDPTools.writeSDP(t),e}function onIceCandidate(e){let t=offerConnection.iceGatheringState;if("completed"===t||"complete"===t||e&&!e.candidate){screenSplitLog.info("onIceCandidate: ICE GATHERING COMPLETED( PC: offer)");let e={type:"offer",sdp:handleSdp(offerConnection.localDescription.sdp)},t={type:"offerSdp",value:JSON.stringify(e)};screenSplitLog.warn("send offer"),localWindow.postMessage(t,appDomain)}else screenSplitLog.info(`offerConnection ICE candidate:\n${e.candidate?e.candidate.candidate:"(null)"}`)}function handleSplitAnswer(e){let t=JSON.parse(e.data.value),i=new window.RTCSessionDescription(t);screenSplitLog.info("offerConnection get answer sdp:\n"+i.sdp),offerConnection.setRemoteDescription(i).then((function(){screenSplitLog.info("offerConnection setRemoteDes success"),slideVideoEle.srcObject=null})).catch((function(e){screenSplitLog.error("offerConnection setRemoteDes error"),screenSplitLog.error(e.toString())}))}function handleStopSplit(){offerConnection&&offerConnection.close(),window.offerConnection=null,isScreenSplit=!1,slideVideoEle.srcObject=presentStream,window.screenSplBtn.innerHTML="splitScreen"}function stopSplitScreen(){let e={type:"stopSplit",value:!0};localWindow&&localWindow.postMessage(e,appDomain)}window.addEventListener("message",(function(e){switch(e.data.type){case"open":localWindow=e.source,createLocalDescription(e);break;case"answerSdp":handleSplitAnswer(e);break;case"stopSplit":handleStopSplit(e)}})),window.onbeforeunload=stopSplitScreen,WebRTCSession.prototype.getStats=function(e,t,i,o){let n=gsRTC.getBrowserDetail();"chrome"===n.browser&&n.version<76?e.getStats((e=>{let t={};e.result().forEach((function(e){let i={id:e.id,type:e.type};e.names().forEach((function(t){i[t]=e.stat(t)})),i.timestamp=Date.now(),t[i.id]=i})),i(t)}),o):e.getStats(t).then((function(e){let t={};e.forEach((e=>{t[e.id]=deepCopy(e)})),i(t)}),o)},WebRTCSession.prototype.processStats=function(e,t=null){let i=this,o={},n=gsRTC.getBrowserDetail();function r(e){return"[object Object]"===Object.prototype.toString.call(e)?"Object":"[object Array]"===Object.prototype.toString.call(e)?"Array":"nomal"}function s(e,t){if("nomal"===r(e))return e;var i=t?deepCopy(t):"Object"===r(e)?{}:[];for(let t in e)e.hasOwnProperty(t)&&(i[t]=s(e[t]));return i}if("firefox"===n.browser)for(let t in e){let i="inbound-rtp"===e[t].type?"_in":"remote-inbound-rtp"===e[t].type?"_out":"outbound-rtp"===e[t].type?"local_out":null,n="ssrc_"+e[t].ssrc;i&&"local_out"!==i?o[n]=o[n]?s(e[t],o[n]):s(e[t]):"local_out"===i&&(o[n+"forFirefoxSendStream"]=s(e[t]))}else if("chrome"===n.browser&&n.version<76)for(let t in e){let i="ssrc_"+e[t].ssrc;e[t].ssrc&&(o[i]=s(e[t]),o[i].codecName=(o[i].googCodecName,o[i].googCodecName),o[i].frameWidth=o[i].googFrameWidthSent?o[i].googFrameWidthSent:"",o[i].frameHeight=o[i].googFrameHeightSent?o[i].googFrameHeightSent:"",o[i].roundTripTime=o[i].googRtt||0===o[i].googRtt||"0"===o[i].googRtt?Number(o[i].googRtt):null)}else{for(let t in e){let i="inbound-rtp"===e[t].type?"local_in":"outbound-rtp"===e[t].type?"local_out":"remote-inbound-rtp"===e[t].type?"remote_in":null,n="ssrc_"+e[t].ssrc;i&&(i&&i.indexOf("local")>=0?o[n]=o[n]?s(e[t],o[n]):s(e[t]):o[n]&&"remote_in"===i&&(o[n].packetsLost=e[t].packetsLost),o[n].roundTripTime=e[t].hasOwnProperty("roundTripTime")?1e3*Number(e[t].roundTripTime):null,o[n].jitter=e[t].hasOwnProperty("jitter")?Number(e[t].jitter):null)}for(let t in o){let i=e[o[t].codecId]||null,n=e[o[t].trackId]||null;if(i)for(let e in i)"id"!==e&&"type"!==e&&"mimeType"!==e&&(o[t][e]=i[e]),"mimeType"===e&&(o[t].codecName=i[e].split("/")[1]);if(n)for(let e in n)"id"!==e&&"type"!==e&&(o[t][e]=n[e]);for(let e in o[t])(e.toLocaleLowerCase().indexOf("id")>=0||"kind"===e)&&delete o[t][e]}}for(let e in o)i.stats||(i.stats={}),i.stats[e]&&(i.stats[e].hasOwnProperty("packetsReceived")&&(o[e].prevPacketsReceived=i.stats[e].packetsReceived),i.stats[e].hasOwnProperty("packetsSent")&&(o[e].prevPacketsSent=i.stats[e].packetsSent),i.stats[e].hasOwnProperty("packetsLost")&&(o[e].prevPacketsLost=i.stats[e].packetsLost),i.stats[e].hasOwnProperty("bytesReceived")&&(o[e].prevBytesReceived=i.stats[e].bytesReceived),i.stats[e].hasOwnProperty("bytesSent")&&(o[e].prevBytesSent=i.stats[e].bytesSent),i.stats[e].hasOwnProperty("timestamp")&&(o[e].prevTimestamp=i.stats[e].timestamp));i.stats=deepCopy(o)},WebRTCSession.prototype.getLossRate=function(e){let t={};function i(e){let t,i,o={};if(t=e&&e.prevTimestamp?Number(e.timestamp)-Number(e.prevTimestamp):0,i=e&&e.hasOwnProperty("prevBytesReceived")?Number(e.bytesReceived)-Number(e.prevBytesReceived):e&&e.hasOwnProperty("prevBytesSent")?Number(e.bytesSent)-Number(e.prevBytesSent):0,i>=0&&t>0){let e=8*i*1e3/t;o.bandWidthVal=e}else o.bandWidthVal=0;return o.bandWidthUnit="bps",o}for(let o in e){let n,r={lossRate:"0.00%",bandWidthVal:0,bandWidthUnit:"bps",codecName:""},s=e[o];if(s.hasOwnProperty("prevPacketsSent")&&s.hasOwnProperty("prevPacketsLost")){let e=Number(s.packetsSent)-Number(s.prevPacketsSent),t=Number(s.packetsLost)-Number(s.prevPacketsLost);n=t>=0&&e>0?t/e:0===e?0:"negative"}else if(s.hasOwnProperty("prevPacketsReceived")&&s.hasOwnProperty("prevPacketsLost")){let e=Number(s.packetsReceived)-Number(s.prevPacketsReceived),t=Number(s.packetsLost)-Number(s.prevPacketsLost);n=t>=0&&e>=0?0===e&&0!==t&&0!==Number(s.packetsReceived)&&0!==Number(s.packetsLost)?1:t/(e+t):"negative"}"number"==typeof n&&"NaN"!==n.toString()?(n>1&&(n=1),r.lossRate=(100*n).toFixed(2)+"%"):r.lossRate="negative",s.codecName&&(r.codecName=s.codecName.toUpperCase()),s.hasOwnProperty("roundTripTime")&&(r.roundTripTime=s.roundTripTime),s.hasOwnProperty("jitter")&&(r.jitter=s.jitter),s.frameWidth&&"0"!==s.frameWidth&&s.frameHeight&&"0"!==s.frameHeight&&(r.resolution=s.frameWidth+" X "+s.frameHeight),r.bandWidthVal=i(s).bandWidthVal,r.bandWidthUnit=i(s).bandWidthUnit,t[o]=r}return t};