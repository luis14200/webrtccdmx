$((function(){var e,i,n=$("#audioSourceContainer"),o=$("#audioSource"),s=$("#audioSourceText"),a=$("#audioSourceTestBtn"),c=$("#audioOutputContainer"),l=$("#audioOutput"),r=$("#video"),d=$("#audioMix"),u=$("#ringbacktone"),m=$("#audioOutputText"),v=null,h=null,g=$("#audioOutputTestBtn"),p=$("#anonymousWebRTC",parent.document),f=$("#main"),w=$("#reload"),C=$("#calling"),x=$(".calling-title"),b=$(".hangup-btn"),T=[],S=[];function y(e){p.css({width:"400px",height:"280px"}),f.show();var t,i,n,a=0,c=0;T=[],S=[],o.empty(),l.empty();for(let r=0;r!==e.length;++r){const d=e[r];if("default"!==d.deviceId&&"communications"!==d.deviceId)if("audioinput"===d.kind){if(t=d.label,i=d.deviceId,T.indexOf(i)>-1)continue;T.push(i),0===a?(n=$("<div>").addClass("select-item select-item-active").text(t).attr({value:i,title:t}),s.text(t).attr({value:i,title:t})):n=$("<div>").addClass("select-item").text(t).attr({title:t,value:i}),o.append(n),a++}else if("audiooutput"===d.kind){if(t=d.label,i=d.deviceId,S.indexOf(i)>-1)continue;S.push(i),0===c?(n=$("<div>").addClass("select-item select-item-active").text(t).attr({title:t,value:i}),m.text(t).attr({title:t,value:i}),I(i)):n=$("<div>").addClass("select-item").text(t).attr({title:t,value:i}),l.append(n),c++}else console.log("Some other kind of source/device: ",d)}}function I(e){var t,i;t=r[0],i=e,void 0!==t.sinkId?t.setSinkId(i).then((()=>{console.log(`Success, audio output device attached: ${i}`)})).catch((e=>{let t=e;"SecurityError"===e.name&&(t=`You need to use HTTPS for selecting audio output device: ${e}`),console.error(t),l.selectedIndex=0})):console.warn("Browser does not support output device selection.")}function M(e){return window.stream=e,navigator.mediaDevices.enumerateDevices()}function k(e){p.css({width:"560px",height:"288px"}),w.show(),console.log("navigator.MediaDevices.getUserMedia error: ",e.message,e.name)}function R(){D();const e=o.value,t={audio:{deviceId:e?{exact:e}:void 0},video:!1};navigator.mediaDevices.getUserMedia(t).then(M).then(y).catch(k)}function D(){window.stream&&window.stream.getTracks().forEach((e=>{e.stop()}))}function A(e){this.context=e,this.instant=0,this.script=e.createScriptProcessor(2048,1,1);const t=this;this.script.onaudioprocess=function(e){const i=e.inputBuffer.getChannelData(0);let n,o=0,s=0;for(n=0;n<i.length;++n)o+=i[n]*i[n],Math.abs(i[n])>.99&&(s+=1);t.instant=Math.sqrt(o/i.length)}}function O(e){function t(){if(!n())throw"Audio amplitude meter not supported";return a=new(window.AudioContext||window.webkitAudioContext),s=a.createAnalyser(),s.minDecibels=-60,s.maxDecibels=-30,s.smoothingTimeConstant=.8,s.fftSize=256,a}function i(e){return o&&(o.disconnect(),o=void 0),e&&(o=e,o.connect(s)),o}function n(){return void 0!==c}let o,s,a,c=window.AudioContext||window.webkitAudioContext||window.mozAudioContext;this.close=function(){o.disconnect(s),a?a.close().then((function(){console.info("success")})).catch((function(){console.info(error)})):Promise.resolve(),a=null,s=null},this.supported=n,this.setStream=function(e){let n=t();return i(e?n.createMediaStreamSource(e):null)},this.getAmplitude=function(){if(!o||!a)return-1;let e=0,t=new Uint8Array(s.frequencyBinCount);s.getByteFrequencyData(t);for(let i=0;i<t.length;i++)e+=t[i];return e/t.length*3},this.setMediaElement=function(e){let n=t();return i(e?n.createMediaElementSource(e):null)},this.connectDestination=function(){s&&a&&s.connect(a.destination)}}function E(){(v=new Audio).src="./webRTC/sounds/SoundTest.ogg",v.crossOrigin="anonymous",v.loop=!0,function(e){if(window.amplitudeMeter)return h&&clearInterval(h),h=setInterval((function(){let e=window.amplitudeMeter.getAmplitude();e=Math.min(100,Math.max(0,e)),e/=4,$(".audio-output-meter").map((function(t,i){i=$(i),t<parseInt(e)?i.addClass("list-item-active"):i.removeClass("list-item-active")}))}),100),!1;window.amplitudeMeter=new O(e),window.amplitudeMeter.setMediaElement(e),h&&clearInterval(h);h=setInterval((function(){let e=window.amplitudeMeter.getAmplitude();e=Math.min(100,Math.max(0,e)),e/=4,$(".audio-output-meter").map((function(t,i){i=$(i),t<parseInt(e)?i.addClass("list-item-active"):i.removeClass("list-item-active")}))}),100)}(v),v.play();try{$("#soundTest")[0].play()}catch(e){}}function L(){n.addClass("main-disabled"),c.addClass("main-disabled")}function N(){n.removeClass("main-disabled"),c.removeClass("main-disabled")}l.disabled=!("sinkId"in HTMLMediaElement.prototype),window.startDevice=R,n.click((function(e){e.stopPropagation();var t=$(this);c.hasClass("col-right-active")&&(l.hide(),c.removeClass("col-right-active")),t.hasClass("col-right-active")?(o.hide(),n.removeClass("col-right-active")):(o.show(),t.addClass("col-right-active"))})),c.click((function(e){e.stopPropagation();var t=$(this);n.hasClass("col-right-active")&&(o.hide(),n.removeClass("col-right-active")),t.hasClass("col-right-active")?(l.hide(),c.removeClass("col-right-active")):(l.show(),t.addClass("col-right-active"))})),o.on("mouseenter",(function(){var e=$(this);e.children().mouseenter((function(){var e=$(this);e.hasClass("select-item-active")||e.addClass("select-item-hover")})),e.children().mouseleave((function(){var e=$(this);e.hasClass("select-item-hover")&&e.removeClass("select-item-hover")})),e.children().click((function(){var e=$(this);if(!e.hasClass("select-item-active")){var t=e.attr("value");e.addClass("select-item-active"),e.siblings().removeClass("select-item-active"),s.text(e.text()),s.attr("value",t),s.attr("title",e.text());var i={type:"audio",deviceId:t};gsRTC.setSelectedDevice(i)}}))})),l.on("mouseenter",(function(){var e=$(this);e.children().mouseenter((function(){var e=$(this);e.hasClass("select-item-active")||e.addClass("select-item-hover")})),e.children().mouseleave((function(){var e=$(this);e.hasClass("select-item-hover")&&e.removeClass("select-item-hover")})),e.children().click((function(){var e=$(this);if(!e.hasClass("select-item-active")){var t=e.attr("value");e.addClass("select-item-active"),e.siblings().removeClass("select-item-active"),m.text(e.text()),m.attr("value",t),m.attr("title",e.text()),I(t)}}))})),navigator.mediaDevices.addEventListener("devicechange",(function(e){R()})),A.prototype.connectToSource=function(e,t){console.log("SoundMeter connecting");try{this.mic=this.context.createMediaStreamSource(e),this.mic.connect(this.script),this.script.connect(this.context.destination),void 0!==t&&t(null)}catch(e){console.error(e),void 0!==t&&t(e)}},A.prototype.stop=function(){console.log("SoundMeter stopping"),this.mic.disconnect(),this.script.disconnect()},a.click((function(){a.text()===getTextData("L11")?(console.log("Stopping local stream"),$(".list-item-active").removeClass("list-item-active"),D(),window.soundMeter.stop(),clearInterval(U),a.text(getTextData("L2")),N()):(!function(){console.log("Requesting local stream");var e=s.attr("value");const t=window.constraints={audio:{deviceId:e?{exact:e}:void 0},video:!1};try{window.AudioContext=window.AudioContext||window.webkitAudioContext,window.audioContext=new AudioContext}catch(e){alert("Web Audio API not supported.")}navigator.mediaDevices.getUserMedia(t).then(j).catch(J)}(),a.text(getTextData("L11")),L())})),g.click((function(){g.text()===getTextData("L11")?(!function(){try{$("#soundTest")[0].pause()}catch(e){}$(".list-item-active").removeClass("list-item-active"),v&&(v.pause(),v.currentTime=0,v=void 0),h&&clearInterval(h),window.amplitudeMeter&&(window.amplitudeMeter.close(),window.amplitudeMeter=void 0)}(),g.text(getTextData("L2")),N()):(E(),g.text(getTextData("L11")),L())}));let U=null;function j(e){window.stream=e,r[0].srcObject=e;const t=window.soundMeter=new A(window.audioContext);t.connectToSource(e,(function(e){e?alert(e):U=setInterval((()=>{var e=100*t.instant.toFixed(2)/2;$(".audio-source-meter").map((function(t,i){i=$(i),t<parseInt(e)?i.addClass("list-item-active"):i.removeClass("list-item-active")}))}),200)}))}function J(e){console.log("navigator.MediaDevices.getUserMedia error: ",e.message,e.name)}function P(e){console.log("onCallEnd "+JSON.stringify(e)),F()}function _(e){console.log("onMediaStreamChange "+JSON.stringify(e));let t=e.type,i=e.stream,n=e.isLocal;"audio"===t&&(n?(console.log("合进本地音频"),i||console.log("删除本地音频")):i?(console.log("合进远方音频"),function(e,t){if(!e)return void console.info("attachMediaStream element is null, return");console.info("attachMediaStream, element.id:"+e.id);if(!t)return void console.info("attachMediaStream stream is null, return");console.info("attachMediaStream, stream id:"+t.id);e.srcObject=t,e&&"AUDIO"===e.tagName&&window.usedSpeakerDeviceId&&console.log("chrome attachMediaStream setSinkId")}(d[0],i)):console.log("删除远方音频"))}function B(e){console.log("onCallAnswered "+JSON.stringify(e))}function G(e){console.log("onCallRemoteRinging "+JSON.stringify(e))}function H(e){console.log("onRecvInfo "+JSON.stringify(e))}function W(e){console.log("onError "+JSON.stringify(e))}f.click((function(){n.hasClass("col-right-active")&&(o.hide(),n.removeClass("col-right-active")),c.hasClass("col-right-active")&&(l.hide(),c.removeClass("col-right-active"))})),$(".btn-close").click((function(){D(),p.hide()})),$(".reload-close-btn").click((function(){p.hide()})),$(".known-btn").click((function(){p.hide()})),$(".reload-btn").click((function(){location.reload()})),$.ajax({type:"GET",url:"./webrtc_settings.json",dataType:"json",async:!1,success:function(e){webrtcSettings=e,txtPhoneNumber=e.phone_number}});var q=function(){GsRTC&&GsRTC.prototype.preInit()};function F(){clearInterval(i),Y=0,X=0,K=1,$(this).css("background","#FFB299"),x.text(getTextData("L10")),D(),setTimeout((function(){p.hide(),f.show(),C.hide(),p.addClass(".main-box"),p.removeClass("calling-box").css({width:"400px",height:"280px",right:"100px",bottom:"0"}),b.css("background","#ff3f00")}),1e3)}function z(){try{u[0].pause()}catch(e){}}e=setInterval((function(){"complete"===document.readyState&&(clearInterval(e),setTimeout(q,3e3))}),500),$(".bottom-call-btn").click((function(){!window.gsRTC&&GsRTC&&GsRTC.prototype.preInit(),gsRTC&&(gsRTC.on("onCallEnd",P),gsRTC.on("onStreamChange",_),gsRTC.on("onCallAnswered",B),gsRTC.on("onCallRemoteRinging",G),gsRTC.on("onRecvInfo",H),gsRTC.on("OnError",W)),function(){try{u[0].play()}catch(e){}}(),window.gsRTC.sipCallInit({host:"df7jal23ls0d.invalid",organization:"Grandstream",protocol:"sip",sipDisplayName:"Anonymous",sipImpi:webrtcSettings.impi,sipPasswd:"xxx",sipRealm:webrtcSettings.websocket_proxy_url,userAgent:"Grandstream Wave Web 0.2.6.2 (chrome 88.0.4324.190 windows)",version:"0.2.6.2",websocketUrl:"wss://"+webrtcSettings.websocket_proxy_url+"/ws",click2Talk:!0,callback:function(e){console.warn("sipCallInit obj: ",e),e&&999===e.codeType&&window.gsRTC.sipCall({type:"audioConference",peerAccount:webrtcSettings.phone_number,callback:function(e){console.log("sipCall obj: ",JSON.stringify(e,null,"    ")),999===e.codeType?(z(),i=setInterval((function(){x.text(function(){K>0&&K%60==0&&(Y+=1,K=0);Y>0&&Y%60==0&&(X+=1,Y=0);var e=function(){return K<10?"0"+K:K},i=function(){return Y<10?"0"+Y:Y};return t=function(){if(X<10){var e="0"+X;return e}else{return X}}()+":"+i()+":"+e(),K+=1,t}())}),1e3)):x.text(getTextData("L12"))}})}}),p.removeClass(".main-box"),f.hide(),p.addClass("calling-box").css({width:"260px",height:"180px",right:"20px",bottom:"20px"}),C.show(),x.text(getTextData("L9"))})),b.click((function(){z(),clearInterval(i),Y=0,X=0,K=1;var e={peerAccount:webrtcSettings.phone_number,callback:function(){console.log("sipHangUp")}};window.gsRTC?(console.log(JSON.stringify(e)),window.gsRTC.sipHangUp(e)):console.log("no gsRTC function"),F()}));var Y=0,X=0,K=1;var Q,V,Z,ee,te,ie,ne,oe,se=!1;C.mousedown((function(e){se=!0,Q=e.screenX,V=e.screenY,Z=parseInt(p.css("right")),ee=parseInt(p.css("bottom")),te=parseInt(p.css("width")),ie=parseInt(p.css("height")),ne=window.parent.document.documentElement.clientWidth,oe=window.parent.document.documentElement.clientHeight})),$(document).mousemove((function(e){if(se){var t=Q-e.screenX+Z,i=V-e.screenY+ee;t<0&&(t=0),i<0&&(i=0),ne-te<t&&(t=ne-te),oe-ie<i&&(i=oe-ie),p.css({bottom:i,right:t})}})).mouseup((function(){se=!1}))}));